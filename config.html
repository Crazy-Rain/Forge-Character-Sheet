<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Forge Configuration</title>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #64b5f6;
            text-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
            margin-bottom: 30px;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-buttons button {
            background: #424242;
            color: #e0e0e0;
            border: 1px solid #64b5f6;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-buttons button:hover {
            background: #64b5f6;
            color: #1a1a2e;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: rgba(45, 45, 68, 0.8);
            border: 1px solid #64b5f6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .panel h3 {
            color: #81c784;
            margin-top: 0;
            border-bottom: 1px solid #81c784;
            padding-bottom: 10px;
        }

        .search-box {
            width: 100%;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .perk-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
        }

        .perk-item {
            padding: 10px;
            border-bottom: 1px solid #424242;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .perk-item:hover {
            background: #3a3a3a;
        }

        .perk-item:last-child {
            border-bottom: none;
        }

        .perk-name {
            font-weight: bold;
            color: #64b5f6;
        }

        .perk-origin {
            color: #81c784;
            font-size: 0.9em;
        }

        .perk-cost {
            color: #ffb74d;
            font-weight: bold;
        }

        .perk-description {
            margin-top: 5px;
            color: #c0c0c0;
            font-size: 0.9em;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #424242;
        }

        .setting-item label {
            color: #e0e0e0;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
        }

        button {
            background: #424242;
            color: #e0e0e0;
            border: 1px solid #64b5f6;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background: #64b5f6;
            color: #1a1a2e;
        }

        button.danger {
            border-color: #f44336;
        }

        button.danger:hover {
            background: #f44336;
            color: white;
        }

        .file-input {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            width: 100%;
        }

        .success {
            background: #4caf50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .sheet-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
        }

        .sheet-item {
            padding: 10px;
            border-bottom: 1px solid #424242;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-item:last-child {
            border-bottom: none;
        }

        .sheet-info {
            flex-grow: 1;
        }

        .sheet-actions {
            display: flex;
            gap: 5px;
        }

        .sheet-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #2d2d44;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #64b5f6;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #64b5f6;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #64b5f6;
        }

        .domain-selector {
            margin-bottom: 15px;
        }

        .domain-selector select {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2a2a2a;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #64b5f6;
        }

        .stat-label {
            color: #c0c0c0;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Celestial Forge Configuration</h1>
        
        <div class="nav-buttons">
            <button onclick="showTab('perk-browser')">Perk Browser</button>
            <button onclick="showTab('sheet-manager')">Sheet Manager</button>
            <button onclick="showTab('import-export')">Import/Export</button>
            <button onclick="showTab('settings')">Settings</button>
            <button onclick="goToForge()">‚Üê Back to Forge</button>
        </div>

        <div id="perk-browser" class="tab-content active">
            <div class="panel">
                <h3>üîç Perk Database Browser</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-perks">-</div>
                        <div class="stat-label">Total Perks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-domains">-</div>
                        <div class="stat-label">Domains</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="affordable-perks">-</div>
                        <div class="stat-label">Affordable (1000 CP)</div>
                    </div>
                </div>
                
                <div class="domain-selector">
                    <select id="domain-filter" onchange="filterPerks()">
                        <option value="">All Domains</option>
                    </select>
                </div>
                
                <input type="text" class="search-box" id="perk-search" placeholder="Search perks by name or description..." oninput="filterPerks()">
                
                <div class="perk-list" id="perk-list"></div>
            </div>
        </div>

        <div id="sheet-manager" class="tab-content">
            <div class="panel">
                <h3>üìã Sheet Manager</h3>
                <div class="sheet-list" id="sheet-list"></div>
                <button onclick="refreshSheetList()">Refresh</button>
                <button onclick="exportAllSheets()">Export All Sheets</button>
                <button class="danger" onclick="clearAllSheets()">Clear All Sheets</button>
            </div>
        </div>

        <div id="import-export" class="tab-content">
            <div class="panel">
                <h3>üì§ Export Options</h3>
                <button onclick="exportCurrentSheet()">Export Current Sheet (JSON)</button>
                <button onclick="exportCurrentSheetFormatted()">Export Current Sheet (Formatted)</button>
                <button onclick="exportPerksDatabase()">Export Perks Database</button>
                <button onclick="exportSettings()">Export Settings</button>
            </div>
            
            <div class="panel">
                <h3>üì• Import Options</h3>
                <div>
                    <label>Import Sheet:</label>
                    <input type="file" class="file-input" id="import-sheet" accept=".json" onchange="importSheet(this)">
                </div>
                <div style="margin-top: 15px;">
                    <label>Import Perks Database:</label>
                    <input type="file" class="file-input" id="import-perks" accept=".json" onchange="importPerks(this)">
                </div>
                <div style="margin-top: 15px;">
                    <label>Import Settings:</label>
                    <input type="file" class="file-input" id="import-settings" accept=".json" onchange="importSettings(this)">
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="panel">
                <h3>‚öôÔ∏è Application Settings</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="confirm-selections">Confirm perk selection</label>
                        <input type="checkbox" id="confirm-selections" checked>
                    </div>
                    <div class="setting-item">
                        <label for="show-descriptions">Show full descriptions</label>
                        <input type="checkbox" id="show-descriptions" checked>
                    </div>
                    <div class="setting-item">
                        <label for="remember-last-sheet">Remember last sheet name</label>
                        <input type="checkbox" id="remember-last-sheet" checked>
                    </div>
                </div>
                <button onclick="saveSettings()">Save Settings</button>
                <button onclick="resetSettings()">Reset to Defaults</button>
            </div>
        </div>

        <div class="success" id="success-message"></div>
        <div class="error" id="error-message"></div>
    </div>

    <!-- Perk Detail Modal -->
    <div id="perk-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-perk-name">Perk Name</h3>
                <span class="close" onclick="closePerkModal()">&times;</span>
            </div>
            <div id="modal-perk-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="modal-add-perk" onclick="addPerkFromModal()">Add to Sheet</button>
                <button onclick="closePerkModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let perksData = {};
        let currentSheet = [];
        let currentCP = 0;
        let settings = {
            confirmSelections: true,
            showDescriptions: true,
            rememberLastSheet: true
        };
        let selectedPerk = null;

        // Load data on page load
        window.addEventListener('load', async () => {
            await loadPerksData();
            loadSettings();
            loadCurrentSheetData();
            showTab('perk-browser');
        });

        async function loadPerksData() {
            try {
                const response = await fetch('perks.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                perksData = await response.json();
                
                populateDomainFilter();
                updateStats();
                displayPerks();
                showSuccess('Perks database loaded successfully!');
            } catch (error) {
                showError(`Failed to load perks database: ${error.message}`);
            }
        }

        function loadCurrentSheetData() {
            // Try to get current sheet data from localStorage
            const sheetData = localStorage.getItem('forgeSheet');
            const cpData = localStorage.getItem('forgeCPData');
            
            if (sheetData) {
                try {
                    currentSheet = JSON.parse(sheetData);
                } catch (e) {
                    currentSheet = [];
                }
            }
            
            if (cpData) {
                try {
                    const parsed = JSON.parse(cpData);
                    currentCP = parsed.currentCP || 0;
                } catch (e) {
                    currentCP = 0;
                }
            }
            
            updateStats();
        }

        function populateDomainFilter() {
            const select = document.getElementById('domain-filter');
            select.innerHTML = '<option value="">All Domains</option>';
            
            Object.keys(perksData).sort().forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
            const totalDomains = Object.keys(perksData).length;
            const affordablePerks = Object.values(perksData).reduce((sum, perks) => {
                return sum + perks.filter(p => (p.cost || 0) <= 1000).length;
            }, 0);

            document.getElementById('total-perks').textContent = totalPerks;
            document.getElementById('total-domains').textContent = totalDomains;
            document.getElementById('affordable-perks').textContent = affordablePerks;
        }

        function filterPerks() {
            const searchTerm = document.getElementById('perk-search').value.toLowerCase();
            const domainFilter = document.getElementById('domain-filter').value;
            
            displayPerks(searchTerm, domainFilter);
        }

        function displayPerks(searchTerm = '', domainFilter = '') {
            const perkList = document.getElementById('perk-list');
            perkList.innerHTML = '';

            const domainsToShow = domainFilter ? [domainFilter] : Object.keys(perksData);

            domainsToShow.forEach(domain => {
                const perks = perksData[domain] || [];
                
                perks.forEach(perk => {
                    const matchesSearch = !searchTerm || 
                        perk.name.toLowerCase().includes(searchTerm) ||
                        (perk.description && perk.description.toLowerCase().includes(searchTerm)) ||
                        (perk.origin && perk.origin.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        const perkItem = createPerkElement(perk, domain);
                        perkList.appendChild(perkItem);
                    }
                });
            });
        }

        function createPerkElement(perk, domain) {
            const div = document.createElement('div');
            div.className = 'perk-item';
            div.onclick = () => showPerkModal(perk, domain);

            const cost = perk.cost || 0;
            const description = perk.description || 'No description available';
            const truncatedDesc = description.length > 150 ? description.substring(0, 150) + '...' : description;

            div.innerHTML = `
                <div class="perk-name">${perk.name}</div>
                <div class="perk-origin">${perk.origin || 'Unknown Origin'} - ${domain}</div>
                <div class="perk-cost">[${cost} CP]</div>
                <div class="perk-description">${truncatedDesc}</div>
            `;

            return div;
        }

        function showPerkModal(perk, domain) {
            selectedPerk = { ...perk, domain };
            
            document.getElementById('modal-perk-name').textContent = perk.name;
            
            const cost = perk.cost || 0;
            const canAfford = cost <= currentCP;
            
            document.getElementById('modal-perk-content').innerHTML = `
                <p><strong>Origin:</strong> ${perk.origin || 'Unknown'}</p>
                <p><strong>Domain:</strong> ${domain}</p>
                <p><strong>Cost:</strong> <span style="color: ${canAfford ? '#81c784' : '#f44336'}">${cost} CP</span></p>
                ${cost > currentCP ? '<p style="color: #f44336;"><em>Insufficient CP!</em></p>' : ''}
                <p><strong>Description:</strong></p>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    ${perk.description || 'No description available'}
                </div>
                ${perk.sub_perks && perk.sub_perks.length > 0 ? `
                    <p><strong>Sub-perks:</strong></p>
                    <ul>
                        ${perk.sub_perks.map(sp => `<li><strong>${sp.name}</strong> [${sp.cost || 0} CP] - ${sp.description || 'No description'}</li>`).join('')}
                    </ul>
                ` : ''}
            `;
            
            const addButton = document.getElementById('modal-add-perk');
            addButton.disabled = !canAfford;
            addButton.style.opacity = canAfford ? '1' : '0.5';
            
            document.getElementById('perk-modal').style.display = 'block';
        }

        function closePerkModal() {
            document.getElementById('perk-modal').style.display = 'none';
            selectedPerk = null;
        }

        function addPerkFromModal() {
            if (!selectedPerk) return;
            
            const cost = selectedPerk.cost || 0;
            if (cost > currentCP) {
                showError('Insufficient CP!');
                return;
            }
            
            if (settings.confirmSelections) {
                if (!confirm(`Add "${selectedPerk.name}" to your sheet for ${cost} CP?`)) {
                    return;
                }
            }
            
            // Add to sheet
            currentSheet.push(selectedPerk);
            currentCP -= cost;
            
            // Save to localStorage
            localStorage.setItem('forgeSheet', JSON.stringify(currentSheet));
            localStorage.setItem('forgeCPData', JSON.stringify({ currentCP, totalCP: currentCP }));
            
            updateStats();
            closePerkModal();
            showSuccess(`"${selectedPerk.name}" added to sheet!`);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Refresh data for specific tabs
            if (tabName === 'sheet-manager') {
                refreshSheetList();
            }
        }

        function refreshSheetList() {
            const sheetList = document.getElementById('sheet-list');
            sheetList.innerHTML = '';
            
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            
            if (Object.keys(savedSheets).length === 0) {
                sheetList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No saved sheets found</div>';
                return;
            }
            
            Object.entries(savedSheets).forEach(([name, data]) => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'sheet-item';
                
                const timestamp = new Date(data.timestamp).toLocaleString();
                const perkCount = data.sheet ? data.sheet.length : 0;
                const cpSpent = data.sheet ? data.sheet.reduce((sum, p) => sum + (p.cost || 0), 0) : 0;
                
                sheetItem.innerHTML = `
                    <div class="sheet-info">
                        <div style="font-weight: bold; color: #64b5f6;">${name}</div>
                        <div style="font-size: 0.9em; color: #c0c0c0;">
                            ${perkCount} perks, ${cpSpent} CP spent, saved ${timestamp}
                        </div>
                    </div>
                    <div class="sheet-actions">
                        <button onclick="loadSheet('${name}')">Load</button>
                        <button onclick="exportSheet('${name}')">Export</button>
                        <button class="danger" onclick="deleteSheet('${name}')">Delete</button>
                    </div>
                `;
                
                sheetList.appendChild(sheetItem);
            });
        }

        function loadSheet(name) {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const sheetData = savedSheets[name];
            
            if (!sheetData) {
                showError('Sheet not found!');
                return;
            }
            
            // Load into current sheet
            localStorage.setItem('forgeSheet', JSON.stringify(sheetData.sheet || []));
            localStorage.setItem('forgeCPData', JSON.stringify({
                currentCP: sheetData.currentCP || 0,
                totalCP: sheetData.totalCP || 0
            }));
            
            loadCurrentSheetData();
            showSuccess(`Sheet "${name}" loaded!`);
        }

        function exportSheet(name) {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const sheetData = savedSheets[name];
            
            if (!sheetData) {
                showError('Sheet not found!');
                return;
            }
            
            const blob = new Blob([JSON.stringify(sheetData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/[^a-z0-9]/gi, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(`Sheet "${name}" exported!`);
        }

        function deleteSheet(name) {
            if (!confirm(`Delete sheet "${name}"? This cannot be undone.`)) {
                return;
            }
            
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            delete savedSheets[name];
            localStorage.setItem('forgeSheets', JSON.stringify(savedSheets));
            
            refreshSheetList();
            showSuccess(`Sheet "${name}" deleted!`);
        }

        function exportCurrentSheet() {
            const blob = new Blob([JSON.stringify(currentSheet, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'current_sheet.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Current sheet exported!');
        }

        function exportCurrentSheetFormatted() {
            let txt = '<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\\n<hr>\\n';
            
            currentSheet.forEach(perk => {
                txt += `[${perk.name}] - ${perk.origin || 'Unknown'} - ${perk.cost || 0} CP\\n`;
                txt += `${perk.description || 'No description available'}\\n<hr>\\n`;
            });
            
            txt += `Current CP: ${currentCP}\\nTotal Perks: ${currentSheet.length}\\n<hr>`;
            
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'current_sheet_formatted.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Formatted sheet exported!');
        }

        function exportPerksDatabase() {
            const blob = new Blob([JSON.stringify(perksData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'perks_database.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Perks database exported!');
        }

        function exportSettings() {
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'forge_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Settings exported!');
        }

        function exportAllSheets() {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const blob = new Blob([JSON.stringify(savedSheets, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_sheets.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('All sheets exported!');
        }

        function clearAllSheets() {
            if (!confirm('Delete ALL saved sheets? This cannot be undone!')) {
                return;
            }
            
            localStorage.removeItem('forgeSheets');
            refreshSheetList();
            showSuccess('All sheets cleared!');
        }

        async function importSheet(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                if (Array.isArray(importedData)) {
                    // Direct sheet import
                    currentSheet = importedData;
                    localStorage.setItem('forgeSheet', JSON.stringify(currentSheet));
                    loadCurrentSheetData();
                    showSuccess(`Sheet imported from "${file.name}"!`);
                } else if (importedData.sheet) {
                    // Full sheet data import
                    localStorage.setItem('forgeSheet', JSON.stringify(importedData.sheet || []));
                    localStorage.setItem('forgeCPData', JSON.stringify({
                        currentCP: importedData.currentCP || 0,
                        totalCP: importedData.totalCP || 0
                    }));
                    loadCurrentSheetData();
                    showSuccess(`Sheet data imported from "${file.name}"!`);
                } else {
                    showError('Invalid sheet format!');
                }
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        async function importPerks(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedPerks = JSON.parse(text);
                
                perksData = importedPerks;
                populateDomainFilter();
                updateStats();
                displayPerks();
                showSuccess(`Perks database imported from "${file.name}"!`);
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        async function importSettings(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedSettings = JSON.parse(text);
                
                settings = { ...settings, ...importedSettings };
                saveSettings();
                showSuccess(`Settings imported from "${file.name}"!`);
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        function loadSettings() {
            const saved = localStorage.getItem('forgeSettings');
            if (saved) {
                try {
                    settings = { ...settings, ...JSON.parse(saved) };
                } catch (e) {
                    // Use defaults
                }
            }
            
            // Update UI
            document.getElementById('confirm-selections').checked = settings.confirmSelections;
            document.getElementById('show-descriptions').checked = settings.showDescriptions;
            document.getElementById('remember-last-sheet').checked = settings.rememberLastSheet;
        }

        function saveSettings() {
            settings = {
                confirmSelections: document.getElementById('confirm-selections').checked,
                showDescriptions: document.getElementById('show-descriptions').checked,
                rememberLastSheet: document.getElementById('remember-last-sheet').checked
            };
            
            localStorage.setItem('forgeSettings', JSON.stringify(settings));
            showSuccess('Settings saved!');
        }

        function resetSettings() {
            if (!confirm('Reset all settings to defaults?')) {
                return;
            }
            
            settings = {
                confirmSelections: true,
                showDescriptions: true,
                rememberLastSheet: true
            };
            
            localStorage.setItem('forgeSettings', JSON.stringify(settings));
            loadSettings();
            showSuccess('Settings reset to defaults!');
        }

        function goToForge() {
            window.location.href = 'forge-enhanced.html';
        }

        function showSuccess(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('perk-modal');
            if (event.target === modal) {
                closePerkModal();
            }
        }
    </script>
</body>
</html>