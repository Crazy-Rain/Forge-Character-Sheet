<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celestial Forge Configuration</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f1419, #1a1a2e); 
      color: #e0e0e0; 
      padding: 1rem; 
      margin: 0;
      min-height: 100vh;
    }
    
    h2 { 
      margin-top: 0; 
      color: #4fc3f7;
      text-align: center;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
      font-size: 1.8em;
    }
    
    h3 {
      color: #81c784;
      border-bottom: 2px solid #2e7d32;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }
    
    button { 
      margin: 0.25rem; 
      padding: 0.75rem 1.25rem; 
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      background: linear-gradient(135deg, #1976d2, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }
    
    button.secondary {
      background: linear-gradient(135deg, #455a64, #37474f);
    }
    
    button.secondary:hover {
      background: linear-gradient(135deg, #37474f, #263238);
    }
    
    button.danger {
      background: linear-gradient(135deg, #f44336, #d32f2f);
    }
    
    button.danger:hover {
      background: linear-gradient(135deg, #d32f2f, #c62828);
    }
    
    button.success {
      background: linear-gradient(135deg, #4caf50, #388e3c);
    }
    
    button.success:hover {
      background: linear-gradient(135deg, #388e3c, #2e7d32);
    }
    
    .panel { 
      border: 2px solid #0f3460; 
      padding: 1.5rem; 
      margin-bottom: 1.5rem; 
      border-radius: 12px; 
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .row { 
      display: flex; 
      gap: 0.5rem; 
      flex-wrap: wrap; 
      align-items: center;
      margin: 0.5rem 0;
    }
    
    input, textarea, select {
      background: #2d3748;
      border: 1px solid #4a5568;
      color: #e0e0e0;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: #4fc3f7;
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
      outline: none;
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #bdbdbd;
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      box-sizing: border-box;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .perk-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #4a5568;
      border-radius: 6px;
      background: #1a202c;
    }
    
    .perk-item {
      padding: 1rem;
      border-bottom: 1px solid #2d3748;
      transition: background 0.2s ease;
    }
    
    .perk-item:hover {
      background: #2d3748;
    }
    
    .perk-item:last-child {
      border-bottom: none;
    }
    
    .perk-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .perk-name {
      font-weight: bold;
      color: #4fc3f7;
    }
    
    .perk-cost {
      color: #ffc107;
      font-weight: bold;
    }
    
    .perk-origin {
      color: #81c784;
      font-size: 0.9em;
    }
    
    .perk-description {
      color: #bdbdbd;
      font-size: 0.9em;
      margin-top: 0.5rem;
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .search-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .search-controls input {
      flex: 1;
      min-width: 200px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 2px solid #0f3460;
    }
    
    .tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      color: #bdbdbd;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      color: #4fc3f7;
      border-bottom-color: #4fc3f7;
      background: rgba(79, 195, 247, 0.1);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .file-drop-zone {
      border: 2px dashed #4a5568;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      color: #bdbdbd;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 1rem 0;
    }
    
    .file-drop-zone:hover, .file-drop-zone.dragover {
      border-color: #4fc3f7;
      background: rgba(79, 195, 247, 0.05);
      color: #4fc3f7;
    }
    
    .success-message, .error-message {
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-weight: bold;
    }
    
    .success-message {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }
    
    .error-message {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    
    .hidden {
      display: none !important;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #4fc3f7;
    }
    
    .stat-label {
      color: #bdbdbd;
      font-size: 0.9em;
      margin-top: 0.5rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95));
      margin: 5% auto;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 2px solid #0f3460;
    }
    
    .close {
      color: #bdbdbd;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #f44336;
    }
    
    .navigation-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideInDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .animate-in {
      animation: slideInDown 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="navigation-panel">
    <button onclick="goToMain()" class="secondary">‚Üê Back to Main</button>
  </div>

  <h2>‚öôÔ∏è Celestial Forge Configuration</h2>

  <div class="tabs">
    <button class="tab active" onclick="showTab('perks')">Perk Management</button>
    <button class="tab" onclick="showTab('import-export')">Import/Export</button>
    <button class="tab" onclick="showTab('settings')">Settings</button>
    <button class="tab" onclick="showTab('database')">Database Info</button>
  </div>

  <!-- Perk Management Tab -->
  <div id="perks-tab" class="tab-content active">
    <div class="panel">
      <h3>üîß Perk Management</h3>
      
      <div class="search-controls">
        <input type="text" id="perk-search" placeholder="Search perks by name, origin, or description..." onkeyup="filterPerks()">
        <select id="domain-filter" onchange="filterPerks()">
          <option value="">All Domains</option>
        </select>
        <select id="cost-filter" onchange="filterPerks()">
          <option value="">All Costs</option>
          <option value="0">Free (0 CP)</option>
          <option value="1-100">1-100 CP</option>
          <option value="101-300">101-300 CP</option>
          <option value="301-600">301-600 CP</option>
          <option value="601+">601+ CP</option>
        </select>
        <button onclick="showAddPerkModal()">+ Add Custom Perk</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-perks">0</div>
          <div class="stat-label">Total Perks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-domains">0</div>
          <div class="stat-label">Domains</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="visible-perks">0</div>
          <div class="stat-label">Filtered Results</div>
        </div>
      </div>

      <div class="perk-list" id="perk-list">
        <!-- Perks will be populated here -->
      </div>
    </div>
  </div>

  <!-- Import/Export Tab -->
  <div id="import-export-tab" class="tab-content">
    <div class="panel">
      <h3>üìÅ Import/Export Functions</h3>
      
      <div class="form-grid">
        <div>
          <h4>Import Data</h4>
          <div class="file-drop-zone" id="import-drop-zone" onclick="document.getElementById('import-file').click()">
            <p>üìÅ Click to select file or drag & drop</p>
            <p style="font-size: 0.8em; color: #bdbdbd;">Supports JSON, CSV, and TXT formats</p>
          </div>
          <input type="file" id="import-file" accept=".json,.csv,.txt" style="display: none;" onchange="handleFileImport(this)">
          
          <div class="row">
            <button onclick="importFromClipboard()">Import from Clipboard</button>
            <button onclick="importPerksDatabase()">Import Perks Database</button>
          </div>
        </div>
        
        <div>
          <h4>Export Data</h4>
          <div class="row">
            <button onclick="exportCurrentSheet('json')">Export Sheet (JSON)</button>
            <button onclick="exportCurrentSheet('csv')">Export Sheet (CSV)</button>
            <button onclick="exportCurrentSheet('html')">Export Sheet (HTML)</button>
          </div>
          <div class="row">
            <button onclick="exportPerksDatabase()">Export Perks Database</button>
            <button onclick="exportSheetTemplate()">Export as Template</button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Import/Export Preview:</label>
        <textarea id="import-export-preview" placeholder="Import data will appear here for preview..." readonly></textarea>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="settings-tab" class="tab-content">
    <div class="panel">
      <h3>‚öôÔ∏è Application Settings</h3>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Default CP Amount for "Add CP":</label>
          <input type="number" id="default-cp-amount" value="100" min="1" max="10000">
        </div>
        
        <div class="form-group">
          <label>Auto-save Interval (minutes):</label>
          <select id="autosave-interval">
            <option value="0">Disabled</option>
            <option value="1">1 minute</option>
            <option value="5">5 minutes</option>
            <option value="10" selected>10 minutes</option>
            <option value="30">30 minutes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Theme:</label>
          <select id="theme-select">
            <option value="dark" selected>Dark (Current)</option>
            <option value="light">Light</option>
            <option value="auto">Auto (System)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Default Domain Selection:</label>
          <select id="default-domain">
            <option value="random">Random (Current)</option>
            <option value="favorites">Favorites Only</option>
            <option value="recent">Recently Used</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Export Format Preferences:</label>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label><input type="checkbox" id="include-descriptions" checked> Include perk descriptions</label>
            <label><input type="checkbox" id="include-subperks" checked> Include sub-perks</label>
            <label><input type="checkbox" id="include-costs" checked> Include CP costs</label>
            <label><input type="checkbox" id="include-origins" checked> Include origins</label>
          </div>
        </div>
        
        <div class="form-group">
          <label>Advanced Options:</label>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label><input type="checkbox" id="debug-mode"> Enable debug mode</label>
            <label><input type="checkbox" id="confirm-actions" checked> Confirm destructive actions</label>
            <label><input type="checkbox" id="show-tooltips" checked> Show helpful tooltips</label>
          </div>
        </div>
      </div>
      
      <div class="row">
        <button onclick="saveSettings()" class="success">Save Settings</button>
        <button onclick="resetSettings()" class="danger">Reset to Defaults</button>
        <button onclick="exportSettings()">Export Settings</button>
        <button onclick="importSettings()">Import Settings</button>
      </div>
    </div>
  </div>

  <!-- Database Info Tab -->
  <div id="database-tab" class="tab-content">
    <div class="panel">
      <h3>üìä Database Information</h3>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="db-total-perks">0</div>
          <div class="stat-label">Total Perks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="db-total-domains">0</div>
          <div class="stat-label">Total Domains</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="db-free-perks">0</div>
          <div class="stat-label">Free Perks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="db-avg-cost">0</div>
          <div class="stat-label">Average Cost</div>
        </div>
      </div>

      <div class="form-group">
        <label>Database Status:</label>
        <div id="database-status" style="padding: 1rem; background: rgba(76, 175, 80, 0.2); border-radius: 6px; color: #4caf50;">
          Loading database information...
        </div>
      </div>

      <div class="form-group">
        <label>Domain Breakdown:</label>
        <div id="domain-breakdown" style="max-height: 300px; overflow-y: auto;">
          <!-- Domain stats will be populated here -->
        </div>
      </div>

      <div class="row">
        <button onclick="refreshDatabaseInfo()">Refresh Info</button>
        <button onclick="optimizeDatabase()">Optimize Database</button>
        <button onclick="validateDatabase()">Validate Database</button>
        <button onclick="backupDatabase()">Backup Database</button>
      </div>
    </div>
  </div>

  <!-- Add Perk Modal -->
  <div id="add-perk-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAddPerkModal()">&times;</span>
      <h3>Add Custom Perk</h3>
      
      <div class="form-group">
        <label>Perk Name:</label>
        <input type="text" id="new-perk-name" placeholder="Enter perk name">
      </div>
      
      <div class="form-group">
        <label>Origin:</label>
        <input type="text" id="new-perk-origin" placeholder="Enter origin/source">
      </div>
      
      <div class="form-group">
        <label>Cost (CP):</label>
        <input type="number" id="new-perk-cost" value="0" min="0" max="10000">
      </div>
      
      <div class="form-group">
        <label>Domain:</label>
        <select id="new-perk-domain">
          <!-- Will be populated with existing domains -->
        </select>
      </div>
      
      <div class="form-group">
        <label>Description:</label>
        <textarea id="new-perk-description" placeholder="Enter perk description"></textarea>
      </div>
      
      <div class="row">
        <button onclick="addCustomPerk()" class="success">Add Perk</button>
        <button onclick="closeAddPerkModal()" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Perk Modal -->
  <div id="edit-perk-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditPerkModal()">&times;</span>
      <h3>Edit Perk</h3>
      
      <div class="form-group">
        <label>Perk Name:</label>
        <input type="text" id="edit-perk-name">
      </div>
      
      <div class="form-group">
        <label>Origin:</label>
        <input type="text" id="edit-perk-origin">
      </div>
      
      <div class="form-group">
        <label>Cost (CP):</label>
        <input type="number" id="edit-perk-cost" min="0" max="10000">
      </div>
      
      <div class="form-group">
        <label>Description:</label>
        <textarea id="edit-perk-description"></textarea>
      </div>
      
      <div class="row">
        <button onclick="saveEditedPerk()" class="success">Save Changes</button>
        <button onclick="deleteCurrentPerk()" class="danger">Delete Perk</button>
        <button onclick="closeEditPerkModal()" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <div id="message-area"></div>

  <script>
    let perksData = {};
    let filteredPerks = [];
    let currentEditingPerk = null;
    let settings = {
      defaultCPAmount: 100,
      autosaveInterval: 10,
      theme: 'dark',
      defaultDomain: 'random',
      includeDescriptions: true,
      includeSubperks: true,
      includeCosts: true,
      includeOrigins: true,
      debugMode: false,
      confirmActions: true,
      showTooltips: true
    };

    // Initialize the configuration page
    async function init() {
      await loadPerksData();
      loadSettings();
      populateDomainFilter();
      populateNewPerkDomain();
      updatePerkDisplay();
      updateDatabaseInfo();
      showMessage('Configuration page loaded successfully!', 'success');
    }

    // Load perks data from the main perks.json file
    async function loadPerksData() {
      try {
        const response = await fetch('perks.json');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        perksData = await response.json();
        console.log('Perks data loaded:', Object.keys(perksData).length, 'domains');
      } catch (error) {
        console.error('Error loading perks data:', error);
        showMessage('Failed to load perks database. Some features may not work.', 'error');
      }
    }

    // Tab management
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    // Navigate back to main forge page
    function goToMain() {
      window.location.href = 'forge-enhanced.html';
    }

    // Populate domain filter dropdown
    function populateDomainFilter() {
      const select = document.getElementById('domain-filter');
      const domains = Object.keys(perksData).sort();
      
      // Clear existing options (except "All Domains")
      select.innerHTML = '<option value="">All Domains</option>';
      
      domains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = `${domain} (${perksData[domain]?.length || 0} perks)`;
        select.appendChild(option);
      });
    }

    // Populate domain dropdown for new perk modal
    function populateNewPerkDomain() {
      const select = document.getElementById('new-perk-domain');
      const domains = Object.keys(perksData).sort();
      
      select.innerHTML = '';
      domains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = domain;
        select.appendChild(option);
      });
    }

    // Filter perks based on search criteria
    function filterPerks() {
      const searchTerm = document.getElementById('perk-search').value.toLowerCase();
      const domainFilter = document.getElementById('domain-filter').value;
      const costFilter = document.getElementById('cost-filter').value;
      
      filteredPerks = [];
      
      Object.keys(perksData).forEach(domain => {
        if (domainFilter && domain !== domainFilter) return;
        
        perksData[domain].forEach(perk => {
          // Apply search filter
          if (searchTerm) {
            const searchableText = [
              perk.name || '',
              perk.origin || '',
              perk.description || ''
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) return;
          }
          
          // Apply cost filter
          if (costFilter) {
            const cost = perk.cost || 0;
            switch (costFilter) {
              case '0':
                if (cost !== 0) return;
                break;
              case '1-100':
                if (cost < 1 || cost > 100) return;
                break;
              case '101-300':
                if (cost < 101 || cost > 300) return;
                break;
              case '301-600':
                if (cost < 301 || cost > 600) return;
                break;
              case '601+':
                if (cost < 601) return;
                break;
            }
          }
          
          filteredPerks.push({ ...perk, domain });
        });
      });
      
      updatePerkDisplay();
    }

    // Update the perk display list
    function updatePerkDisplay() {
      const container = document.getElementById('perk-list');
      container.innerHTML = '';
      
      if (filteredPerks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #757575;">No perks found matching your criteria.</div>';
        document.getElementById('visible-perks').textContent = '0';
        return;
      }
      
      filteredPerks.forEach((perk, index) => {
        const div = document.createElement('div');
        div.className = 'perk-item';
        div.onclick = () => editPerk(perk, index);
        
        const description = (perk.description || 'No description available');
        const truncatedDesc = description.length > 150 ? description.substring(0, 150) + '...' : description;
        
        div.innerHTML = `
          <div class="perk-header">
            <div>
              <div class="perk-name">${perk.name || 'Unnamed Perk'}</div>
              <div class="perk-origin">${perk.origin || 'Unknown Origin'} ‚Ä¢ ${perk.domain || 'Unknown Domain'}</div>
            </div>
            <div class="perk-cost">${perk.cost || 0} CP</div>
          </div>
          <div class="perk-description">${truncatedDesc}</div>
        `;
        
        container.appendChild(div);
      });
      
      document.getElementById('visible-perks').textContent = filteredPerks.length;
    }

    // Show add perk modal
    function showAddPerkModal() {
      document.getElementById('add-perk-modal').style.display = 'block';
      // Clear form
      document.getElementById('new-perk-name').value = '';
      document.getElementById('new-perk-origin').value = '';
      document.getElementById('new-perk-cost').value = '0';
      document.getElementById('new-perk-description').value = '';
    }

    // Close add perk modal
    function closeAddPerkModal() {
      document.getElementById('add-perk-modal').style.display = 'none';
    }

    // Add custom perk
    function addCustomPerk() {
      const name = document.getElementById('new-perk-name').value.trim();
      const origin = document.getElementById('new-perk-origin').value.trim();
      const cost = parseInt(document.getElementById('new-perk-cost').value) || 0;
      const domain = document.getElementById('new-perk-domain').value;
      const description = document.getElementById('new-perk-description').value.trim();
      
      if (!name) {
        showMessage('Please enter a perk name.', 'error');
        return;
      }
      
      if (!domain) {
        showMessage('Please select a domain.', 'error');
        return;
      }
      
      const newPerk = {
        name,
        origin: origin || 'Custom',
        cost,
        description: description || 'Custom perk created in configuration.',
        sub_perks: []
      };
      
      // Add to perks data
      if (!perksData[domain]) {
        perksData[domain] = [];
      }
      perksData[domain].push(newPerk);
      
      // Save to localStorage (for persistence in this session)
      localStorage.setItem('customPerks', JSON.stringify(getCustomPerks()));
      
      closeAddPerkModal();
      filterPerks();
      updateDatabaseInfo();
      showMessage(`Added custom perk "${name}" to ${domain} domain.`, 'success');
    }

    // Edit perk
    function editPerk(perk, index) {
      currentEditingPerk = { perk, index };
      
      document.getElementById('edit-perk-name').value = perk.name || '';
      document.getElementById('edit-perk-origin').value = perk.origin || '';
      document.getElementById('edit-perk-cost').value = perk.cost || 0;
      document.getElementById('edit-perk-description').value = perk.description || '';
      
      document.getElementById('edit-perk-modal').style.display = 'block';
    }

    // Close edit perk modal
    function closeEditPerkModal() {
      document.getElementById('edit-perk-modal').style.display = 'none';
      currentEditingPerk = null;
    }

    // Save edited perk
    function saveEditedPerk() {
      if (!currentEditingPerk) return;
      
      const { perk, index } = currentEditingPerk;
      const domain = perk.domain;
      
      // Update perk properties
      const updatedPerk = {
        ...perk,
        name: document.getElementById('edit-perk-name').value.trim(),
        origin: document.getElementById('edit-perk-origin').value.trim(),
        cost: parseInt(document.getElementById('edit-perk-cost').value) || 0,
        description: document.getElementById('edit-perk-description').value.trim()
      };
      
      // Find and update in perksData
      const domainPerks = perksData[domain];
      const perkIndex = domainPerks.findIndex(p => 
        p.name === perk.name && p.origin === perk.origin
      );
      
      if (perkIndex >= 0) {
        domainPerks[perkIndex] = updatedPerk;
        localStorage.setItem('customPerks', JSON.stringify(getCustomPerks()));
        
        closeEditPerkModal();
        filterPerks();
        showMessage(`Updated perk "${updatedPerk.name}".`, 'success');
      }
    }

    // Delete current perk
    function deleteCurrentPerk() {
      if (!currentEditingPerk) return;
      
      if (settings.confirmActions && !confirm('Are you sure you want to delete this perk? This action cannot be undone.')) {
        return;
      }
      
      const { perk } = currentEditingPerk;
      const domain = perk.domain;
      
      // Find and remove from perksData
      const domainPerks = perksData[domain];
      const perkIndex = domainPerks.findIndex(p => 
        p.name === perk.name && p.origin === perk.origin
      );
      
      if (perkIndex >= 0) {
        domainPerks.splice(perkIndex, 1);
        localStorage.setItem('customPerks', JSON.stringify(getCustomPerks()));
        
        closeEditPerkModal();
        filterPerks();
        updateDatabaseInfo();
        showMessage(`Deleted perk "${perk.name}".`, 'success');
      }
    }

    // Get custom perks for saving
    function getCustomPerks() {
      const customPerks = {};
      Object.keys(perksData).forEach(domain => {
        const customs = perksData[domain].filter(perk => 
          perk.origin === 'Custom' || perk.isCustom
        );
        if (customs.length > 0) {
          customPerks[domain] = customs;
        }
      });
      return customPerks;
    }

    // Load custom perks from localStorage
    function loadCustomPerks() {
      try {
        const stored = localStorage.getItem('customPerks');
        if (stored) {
          const customPerks = JSON.parse(stored);
          Object.keys(customPerks).forEach(domain => {
            if (!perksData[domain]) {
              perksData[domain] = [];
            }
            customPerks[domain].forEach(perk => {
              perk.isCustom = true;
              perksData[domain].push(perk);
            });
          });
        }
      } catch (error) {
        console.error('Error loading custom perks:', error);
      }
    }

    // Import/Export Functions
    function handleFileImport(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const preview = document.getElementById('import-export-preview');
        preview.value = content;
        
        // Try to parse and validate
        try {
          if (file.name.endsWith('.json')) {
            const data = JSON.parse(content);
            showMessage(`JSON file loaded. Found ${Object.keys(data).length} entries.`, 'success');
          } else {
            showMessage(`Text file loaded. ${content.split('\n').length} lines.`, 'success');
          }
        } catch (error) {
          showMessage('File loaded but may contain invalid JSON.', 'error');
        }
      };
      reader.readAsText(file);
    }

    function importFromClipboard() {
      navigator.clipboard.readText().then(text => {
        document.getElementById('import-export-preview').value = text;
        showMessage('Content imported from clipboard.', 'success');
      }).catch(err => {
        showMessage('Failed to read from clipboard.', 'error');
      });
    }

    function importPerksDatabase() {
      const content = document.getElementById('import-export-preview').value.trim();
      if (!content) {
        showMessage('No content to import. Please load a file or paste data first.', 'error');
        return;
      }
      
      try {
        const importedData = JSON.parse(content);
        
        if (settings.confirmActions && !confirm('This will merge imported perks with existing data. Continue?')) {
          return;
        }
        
        let importCount = 0;
        Object.keys(importedData).forEach(domain => {
          if (!perksData[domain]) {
            perksData[domain] = [];
          }
          
          importedData[domain].forEach(perk => {
            perk.isImported = true;
            perksData[domain].push(perk);
            importCount++;
          });
        });
        
        populateDomainFilter();
        populateNewPerkDomain();
        filterPerks();
        updateDatabaseInfo();
        showMessage(`Successfully imported ${importCount} perks from ${Object.keys(importedData).length} domains.`, 'success');
        
      } catch (error) {
        showMessage('Invalid JSON format. Please check your import data.', 'error');
        console.error('Import error:', error);
      }
    }

    function exportCurrentSheet(format) {
      // Get current sheet from localStorage
      const sheet = JSON.parse(localStorage.getItem('forgeSheet') || '[]');
      
      if (sheet.length === 0) {
        showMessage('No sheet data to export. Please create a character sheet first.', 'error');
        return;
      }
      
      let content = '';
      let filename = '';
      let mimeType = '';
      
      switch (format) {
        case 'json':
          content = JSON.stringify(sheet, null, 2);
          filename = 'celestial_forge_sheet.json';
          mimeType = 'application/json';
          break;
          
        case 'csv':
          content = 'Name,Origin,Cost,Description\n';
          sheet.forEach(perk => {
            const name = (perk.name || '').replace(/"/g, '""');
            const origin = (perk.origin || '').replace(/"/g, '""');
            const cost = perk.cost || 0;
            const desc = (perk.description || '').replace(/"/g, '""').substring(0, 200);
            content += `"${name}","${origin}",${cost},"${desc}"\n`;
          });
          filename = 'celestial_forge_sheet.csv';
          mimeType = 'text/csv';
          break;
          
        case 'html':
          content = generateHTMLExport(sheet);
          filename = 'celestial_forge_sheet.html';
          mimeType = 'text/html';
          break;
      }
      
      downloadFile(content, filename, mimeType);
      showMessage(`Sheet exported as ${format.toUpperCase()}.`, 'success');
    }

    function exportPerksDatabase() {
      const content = JSON.stringify(perksData, null, 2);
      downloadFile(content, 'perks_database.json', 'application/json');
      showMessage('Perks database exported.', 'success');
    }

    function exportSheetTemplate() {
      const template = {
        name: 'Custom Template',
        description: 'Template created from configuration page',
        perks: [],
        settings: settings
      };
      
      const content = JSON.stringify(template, null, 2);
      downloadFile(content, 'sheet_template.json', 'application/json');
      showMessage('Sheet template exported.', 'success');
    }

    function generateHTMLExport(sheet) {
      let html = `
<!DOCTYPE html>
<html>
<head>
  <title>Celestial Forge Character Sheet</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: #2196f3; border-bottom: 2px solid #2196f3; padding-bottom: 10px; }
    .perk { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .perk-name { font-weight: bold; color: #1976d2; font-size: 1.1em; }
    .perk-info { color: #666; margin: 5px 0; }
    .perk-desc { margin-top: 10px; line-height: 1.4; }
    .summary { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üåå Celestial Forge Character Sheet</h1>
    <p>Generated on ${new Date().toLocaleDateString()}</p>
  </div>
`;
      
      sheet.forEach(perk => {
        html += `
  <div class="perk">
    <div class="perk-name">${perk.name || 'Unknown Perk'}</div>
    <div class="perk-info">${perk.origin || 'Unknown Origin'} ‚Ä¢ ${perk.cost || 0} CP</div>
    <div class="perk-desc">${perk.description || 'No description available'}</div>
  </div>
`;
      });
      
      const totalCost = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
      html += `
  <div class="summary">
    <h3>Summary</h3>
    <p><strong>Total Perks:</strong> ${sheet.length}</p>
    <p><strong>Total Cost:</strong> ${totalCost} CP</p>
  </div>
</body>
</html>
`;
      
      return html;
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Settings Functions
    function loadSettings() {
      try {
        const stored = localStorage.getItem('configSettings');
        if (stored) {
          settings = { ...settings, ...JSON.parse(stored) };
        }
        
        // Apply settings to form
        document.getElementById('default-cp-amount').value = settings.defaultCPAmount;
        document.getElementById('autosave-interval').value = settings.autosaveInterval;
        document.getElementById('theme-select').value = settings.theme;
        document.getElementById('default-domain').value = settings.defaultDomain;
        document.getElementById('include-descriptions').checked = settings.includeDescriptions;
        document.getElementById('include-subperks').checked = settings.includeSubperks;
        document.getElementById('include-costs').checked = settings.includeCosts;
        document.getElementById('include-origins').checked = settings.includeOrigins;
        document.getElementById('debug-mode').checked = settings.debugMode;
        document.getElementById('confirm-actions').checked = settings.confirmActions;
        document.getElementById('show-tooltips').checked = settings.showTooltips;
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    function saveSettings() {
      settings = {
        defaultCPAmount: parseInt(document.getElementById('default-cp-amount').value) || 100,
        autosaveInterval: parseInt(document.getElementById('autosave-interval').value) || 0,
        theme: document.getElementById('theme-select').value,
        defaultDomain: document.getElementById('default-domain').value,
        includeDescriptions: document.getElementById('include-descriptions').checked,
        includeSubperks: document.getElementById('include-subperks').checked,
        includeCosts: document.getElementById('include-costs').checked,
        includeOrigins: document.getElementById('include-origins').checked,
        debugMode: document.getElementById('debug-mode').checked,
        confirmActions: document.getElementById('confirm-actions').checked,
        showTooltips: document.getElementById('show-tooltips').checked
      };
      
      localStorage.setItem('configSettings', JSON.stringify(settings));
      showMessage('Settings saved successfully!', 'success');
    }

    function resetSettings() {
      if (settings.confirmActions && !confirm('Reset all settings to defaults?')) {
        return;
      }
      
      settings = {
        defaultCPAmount: 100,
        autosaveInterval: 10,
        theme: 'dark',
        defaultDomain: 'random',
        includeDescriptions: true,
        includeSubperks: true,
        includeCosts: true,
        includeOrigins: true,
        debugMode: false,
        confirmActions: true,
        showTooltips: true
      };
      
      localStorage.removeItem('configSettings');
      loadSettings();
      showMessage('Settings reset to defaults.', 'success');
    }

    function exportSettings() {
      const content = JSON.stringify(settings, null, 2);
      downloadFile(content, 'forge_config_settings.json', 'application/json');
      showMessage('Settings exported.', 'success');
    }

    function importSettings() {
      const content = document.getElementById('import-export-preview').value.trim();
      if (!content) {
        showMessage('No settings data to import. Please load settings file first.', 'error');
        return;
      }
      
      try {
        const importedSettings = JSON.parse(content);
        settings = { ...settings, ...importedSettings };
        localStorage.setItem('configSettings', JSON.stringify(settings));
        loadSettings();
        showMessage('Settings imported successfully!', 'success');
      } catch (error) {
        showMessage('Invalid settings format.', 'error');
      }
    }

    // Database Info Functions
    function updateDatabaseInfo() {
      if (!perksData || Object.keys(perksData).length === 0) {
        document.getElementById('database-status').innerHTML = 
          '<span style="color: #f44336;">‚ùå Database not loaded</span>';
        return;
      }
      
      let totalPerks = 0;
      let freePerks = 0;
      let totalCost = 0;
      const domains = Object.keys(perksData);
      
      domains.forEach(domain => {
        if (perksData[domain] && Array.isArray(perksData[domain])) {
          perksData[domain].forEach(perk => {
            totalPerks++;
            const cost = perk.cost || 0;
            if (cost === 0) freePerks++;
            totalCost += cost;
          });
        }
      });
      
      const avgCost = totalPerks > 0 ? Math.round(totalCost / totalPerks) : 0;
      
      document.getElementById('db-total-perks').textContent = totalPerks;
      document.getElementById('db-total-domains').textContent = domains.length;
      document.getElementById('db-free-perks').textContent = freePerks;
      document.getElementById('db-avg-cost').textContent = avgCost;
      
      document.getElementById('total-perks').textContent = totalPerks;
      document.getElementById('total-domains').textContent = domains.length;
      
      document.getElementById('database-status').innerHTML = 
        '<span style="color: #4caf50;">‚úÖ Database loaded successfully</span>';
      
      // Update domain breakdown
      updateDomainBreakdown();
    }

    function updateDomainBreakdown() {
      const container = document.getElementById('domain-breakdown');
      container.innerHTML = '';
      
      const domains = Object.keys(perksData).sort();
      domains.forEach(domain => {
        const perks = perksData[domain] || [];
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #333;';
        div.innerHTML = `
          <span>${domain}</span>
          <span style="color: #4fc3f7;">${perks.length} perks</span>
        `;
        container.appendChild(div);
      });
    }

    function refreshDatabaseInfo() {
      updateDatabaseInfo();
      showMessage('Database information refreshed.', 'success');
    }

    function optimizeDatabase() {
      // Remove duplicate perks and clean up data
      let removedCount = 0;
      
      Object.keys(perksData).forEach(domain => {
        const perks = perksData[domain];
        const seen = new Set();
        const cleaned = [];
        
        perks.forEach(perk => {
          const key = `${perk.name}-${perk.origin}`;
          if (!seen.has(key)) {
            seen.add(key);
            cleaned.push(perk);
          } else {
            removedCount++;
          }
        });
        
        perksData[domain] = cleaned;
      });
      
      updateDatabaseInfo();
      filterPerks();
      showMessage(`Database optimized. Removed ${removedCount} duplicate entries.`, 'success');
    }

    function validateDatabase() {
      let issues = [];
      let totalChecked = 0;
      
      Object.keys(perksData).forEach(domain => {
        perksData[domain].forEach((perk, index) => {
          totalChecked++;
          
          if (!perk.name || perk.name.trim() === '') {
            issues.push(`${domain}[${index}]: Missing name`);
          }
          
          if (typeof perk.cost !== 'undefined' && (isNaN(perk.cost) || perk.cost < 0)) {
            issues.push(`${domain}[${index}]: Invalid cost value`);
          }
          
          if (perk.sub_perks && !Array.isArray(perk.sub_perks)) {
            issues.push(`${domain}[${index}]: Invalid sub_perks format`);
          }
        });
      });
      
      const message = issues.length === 0 
        ? `‚úÖ Database validation complete. ${totalChecked} perks checked, no issues found.`
        : `‚ö†Ô∏è Found ${issues.length} issues:\n${issues.slice(0, 5).join('\n')}${issues.length > 5 ? '\n...' : ''}`;
      
      showMessage(message, issues.length === 0 ? 'success' : 'error');
    }

    function backupDatabase() {
      const backup = {
        timestamp: new Date().toISOString(),
        version: '1.0',
        data: perksData,
        settings: settings
      };
      
      const content = JSON.stringify(backup, null, 2);
      downloadFile(content, `forge_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
      showMessage('Database backup created and downloaded.', 'success');
    }

    // Utility Functions
    function showMessage(text, type = 'info') {
      const messageArea = document.getElementById('message-area');
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type}-message animate-in`;
      messageDiv.textContent = text;
      
      messageArea.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // File drop zone functionality
    function setupDropZone() {
      const dropZone = document.getElementById('import-drop-zone');
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById('import-file').files = files;
          handleFileImport(document.getElementById('import-file'));
        }
      });
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setupDropZone();
      
      // Set initial filter to show all perks
      setTimeout(() => {
        // Initialize filteredPerks with all perks
        filteredPerks = [];
        Object.keys(perksData).forEach(domain => {
          perksData[domain].forEach(perk => {
            filteredPerks.push({ ...perk, domain });
          });
        });
        updatePerkDisplay();
      }, 500);
    });
  </script>
</body>
</html>