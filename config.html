<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Forge Configuration</title>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #64b5f6;
            text-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
            margin-bottom: 30px;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-buttons button {
            background: #424242;
            color: #e0e0e0;
            border: 1px solid #64b5f6;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-buttons button:hover {
            background: #64b5f6;
            color: #1a1a2e;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel {
            background: rgba(45, 45, 68, 0.8);
            border: 1px solid #64b5f6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .panel h3 {
            color: #81c784;
            margin-top: 0;
            border-bottom: 1px solid #81c784;
            padding-bottom: 10px;
        }

        .search-box {
            width: 100%;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .perk-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
        }

        .perk-item {
            padding: 10px;
            border-bottom: 1px solid #424242;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .perk-item:hover {
            background: #3a3a3a;
        }

        .perk-item:last-child {
            border-bottom: none;
        }

        .perk-name {
            font-weight: bold;
            color: #64b5f6;
        }

        .perk-origin {
            color: #81c784;
            font-size: 0.9em;
        }

        .perk-cost {
            color: #ffb74d;
            font-weight: bold;
        }

        .perk-description {
            margin-top: 5px;
            color: #c0c0c0;
            font-size: 0.9em;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #424242;
        }

        .setting-item label {
            color: #e0e0e0;
        }

        input[type="checkbox"] {
            transform: scale(1.2);
        }

        button {
            background: #424242;
            color: #e0e0e0;
            border: 1px solid #64b5f6;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background: #64b5f6;
            color: #1a1a2e;
        }

        button.danger {
            border-color: #f44336;
        }

        button.danger:hover {
            background: #f44336;
            color: white;
        }

        .file-input {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            width: 100%;
        }

        .success {
            background: #4caf50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .sheet-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
        }

        .sheet-item {
            padding: 10px;
            border-bottom: 1px solid #424242;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-item:last-child {
            border-bottom: none;
        }

        .sheet-info {
            flex-grow: 1;
        }

        .sheet-actions {
            display: flex;
            gap: 5px;
        }

        .sheet-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #2d2d44;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #64b5f6;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #64b5f6;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #64b5f6;
        }

        .domain-selector {
            margin-bottom: 15px;
        }

        .domain-selector select {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2a2a2a;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #64b5f6;
        }

        .stat-label {
            color: #c0c0c0;
            margin-top: 5px;
        }

        /* Perk Editor Styles */
        .editor-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #424242;
        }

        .editor-tab {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid #424242;
            border-bottom: none;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .editor-tab.active {
            background: #424242;
            color: #64b5f6;
        }

        .editor-tab:hover {
            background: #3a3a3a;
        }

        .editor-content {
            display: none;
        }

        .editor-content.active {
            display: block;
        }

        .raw-editor {
            width: 100%;
            height: 400px;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .perk-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #81c784;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 10px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 5px rgba(100, 181, 246, 0.3);
        }

        .perk-list-editor {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
            margin-bottom: 15px;
        }

        .perk-item-editor {
            padding: 10px;
            border-bottom: 1px solid #424242;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .perk-item-editor:hover {
            background: #3a3a3a;
        }

        .perk-item-editor:last-child {
            border-bottom: none;
        }

        .perk-item-info {
            flex-grow: 1;
        }

        .perk-item-name {
            font-weight: bold;
            color: #64b5f6;
        }

        .perk-item-domain {
            color: #81c784;
            font-size: 0.9em;
        }

        .perk-item-cost {
            color: #ffb74d;
            font-weight: bold;
        }

        /* Sub-Perks Management Styles */
        .sub-perk-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
            margin-top: 5px;
            display: none;
        }

        .sub-perk-result-item {
            padding: 8px 12px;
            border-bottom: 1px solid #424242;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .sub-perk-result-item:hover {
            background: #3a3a3a;
        }

        .sub-perk-result-item:last-child {
            border-bottom: none;
        }

        .sub-perk-result-name {
            font-weight: bold;
            color: #64b5f6;
            margin-bottom: 3px;
        }

        .sub-perk-result-info {
            font-size: 0.85em;
            color: #aaa;
        }

        .current-sub-perks {
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
            padding: 10px;
            min-height: 60px;
        }

        .sub-perk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 8px;
            margin: 5px 0;
            background: #1a1a1a;
            border-radius: 3px;
            border-left: 3px solid #64b5f6;
        }

        .sub-perk-info {
            flex-grow: 1;
        }

        .sub-perk-name {
            font-weight: bold;
            color: #64b5f6;
        }

        .sub-perk-details {
            font-size: 0.85em;
            color: #aaa;
        }

        .sub-perk-remove {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sub-perk-remove:hover {
            background: #d32f2f;
        }

        .perk-item-cost {
            color: #ffcc02;
            font-weight: bold;
        }

        .compiler-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #424242;
            border-radius: 5px;
            background: #2a2a2a;
            margin-top: 20px;
        }

        .compiled-perk {
            padding: 15px;
            border-bottom: 1px solid #424242;
            position: relative;
        }

        .compiled-perk:last-child {
            border-bottom: none;
        }

        .compiled-perk.added {
            opacity: 0.5;
            background: #1a5a1a;
        }

        .compiled-perk-form {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
        }

        .compiled-perk-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .file-drop-zone {
            border: 2px dashed #424242;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            color: #c0c0c0;
            background: #2a2a2a;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #64b5f6;
            background: #3a3a4a;
            color: #64b5f6;
        }

        .parsing-status {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #c0c0c0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #2a2a2a;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #64b5f6);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Celestial Forge Configuration</h1>
        
        <div class="nav-buttons">
            <button onclick="showTab('perk-browser')">Perk Browser</button>
            <button onclick="showTab('perk-editor')">Perk Editor</button>
            <button onclick="showTab('sheet-manager')">Sheet Manager</button>
            <button onclick="showTab('import-export')">Import/Export</button>
            <button onclick="showTab('settings')">Settings</button>
            <button onclick="goToForge()">← Back to Forge</button>
        </div>

        <div id="perk-browser" class="tab-content active">
            <div class="panel">
                <h3>🔍 Perk Database Browser</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-perks">-</div>
                        <div class="stat-label">Total Perks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-domains">-</div>
                        <div class="stat-label">Domains</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="affordable-perks">-</div>
                        <div class="stat-label">Affordable (1000 CP)</div>
                    </div>
                </div>
                
                <div class="domain-selector">
                    <select id="domain-filter" onchange="filterPerks()">
                        <option value="">All Domains</option>
                    </select>
                </div>
                
                <input type="text" class="search-box" id="perk-search" placeholder="Search perks by name or description..." oninput="filterPerks()">
                
                <div class="perk-list" id="perk-list"></div>
            </div>
        </div>

        <div id="perk-editor" class="tab-content">
            <div class="panel">
                <h3>🛠️ Perk Editor/Fixer</h3>
                
                <div class="editor-tabs">
                    <div class="editor-tab active" onclick="showEditorTab('raw-editor')">Raw File Editor</div>
                    <div class="editor-tab" onclick="showEditorTab('individual-editor')">Individual Perk Editor</div>
                    <div class="editor-tab" onclick="showEditorTab('compiler')">Perk Compiler</div>
                </div>

                <!-- Raw File Editor -->
                <div id="raw-editor" class="editor-content active">
                    <h4>Direct Perks Database Editor</h4>
                    <p>Edit the raw perks.json database directly. Be careful with syntax!</p>
                    
                    <div style="margin-bottom: 15px;">
                        <button onclick="loadRawPerksData()">Load Current Database</button>
                        <button onclick="saveRawPerksData()" style="background: #4caf50;">Save Changes</button>
                        <button onclick="validateRawPerksData()">Validate JSON</button>
                        <button onclick="formatRawPerksData()">Format JSON</button>
                    </div>
                    
                    <textarea id="raw-perks-editor" class="raw-editor" placeholder="Perks database JSON will be loaded here..."></textarea>
                    
                    <div id="raw-editor-status" style="margin-top: 10px; font-style: italic; color: #c0c0c0;"></div>
                </div>

                <!-- Individual Perk Editor -->
                <div id="individual-editor" class="editor-content">
                    <h4>Individual Perk Editor</h4>
                    <p>Search, select, and edit individual perks with a user-friendly interface.</p>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="text" class="search-box" id="perk-editor-search" 
                               placeholder="Search perks by name or description..." 
                               oninput="filterPerksForEditing()" style="margin-bottom: 10px;">
                        
                        <select id="perk-editor-domain-filter" onchange="filterPerksForEditing()" style="margin-bottom: 10px;">
                            <option value="">All Domains</option>
                        </select>
                    </div>

                    <div class="perk-list-editor" id="perk-editor-list"></div>

                    <div id="perk-edit-form" style="display: none;">
                        <h4>Edit Perk: <span id="editing-perk-name"></span></h4>
                        
                        <div class="perk-form">
                            <div class="form-group">
                                <label for="edit-perk-name">Name:</label>
                                <input type="text" id="edit-perk-name" placeholder="Perk name">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-perk-domain">Domain:</label>
                                <select id="edit-perk-domain">
                                    <option value="">Select Domain</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-perk-origin">Origin:</label>
                                <input type="text" id="edit-perk-origin" placeholder="Source/Origin">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-perk-cost">Cost:</label>
                                <input type="number" id="edit-perk-cost" placeholder="CP cost" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-perk-description">Description:</label>
                                <textarea id="edit-perk-description" placeholder="Perk description"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="edit-perk-primary"> Primary Perk (bundle of sub-perks)
                                </label>
                                <small>Primary Perks show their sub-perks instead of description and purchase all sub-perks together</small>
                            </div>
                            
                            <div id="sub-perks-section" style="display: none;">
                                <h5>Sub-Perks Management</h5>
                                <div class="form-group">
                                    <label for="sub-perk-search">Search for sub-perks to add:</label>
                                    <input type="text" id="sub-perk-search" placeholder="Search perks..." oninput="searchSubPerks()">
                                    <div id="sub-perk-results" class="sub-perk-results"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Current Sub-Perks:</label>
                                    <div id="current-sub-perks" class="current-sub-perks">
                                        <em>No sub-perks added yet</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="savePerkEdit()" style="background: #4caf50;">Save Perk</button>
                        <button onclick="cancelPerkEdit()">Cancel</button>
                        <button onclick="deletePerk()" class="danger" style="float: right;">Delete Perk</button>
                    </div>
                </div>

                <!-- Perk Compiler -->
                <div id="compiler" class="editor-content">
                    <h4>Perk Compiler</h4>
                    <p>Upload documents to automatically parse and extract perks. Supports text files, Word documents, and PDFs.</p>
                    
                    <div class="file-drop-zone" id="file-drop-zone" onclick="document.getElementById('compiler-file-input').click()">
                        <div>
                            <strong>Click to select files or drag & drop here</strong><br>
                            <small>Supported formats: .txt, .doc, .docx, .pdf</small>
                        </div>
                    </div>
                    
                    <input type="file" id="compiler-file-input" style="display: none;" 
                           accept=".txt,.doc,.docx,.pdf" 
                           multiple onchange="handleFileUpload(this.files)">
                    
                    <div id="parsing-status" class="parsing-status" style="display: none;">
                        <div>Parsing files...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="parsing-progress"></div>
                        </div>
                    </div>
                    
                    <div id="compiler-results" class="compiler-results" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div id="sheet-manager" class="tab-content">
            <div class="panel">
                <h3>📋 Sheet Manager</h3>
                <div class="sheet-list" id="sheet-list"></div>
                <button onclick="refreshSheetList()">Refresh</button>
                <button onclick="exportAllSheets()">Export All Sheets</button>
                <button class="danger" onclick="clearAllSheets()">Clear All Sheets</button>
            </div>
        </div>

        <div id="import-export" class="tab-content">
            <div class="panel">
                <h3>📤 Export Options</h3>
                <button onclick="exportCurrentSheet()">Export Current Sheet (JSON)</button>
                <button onclick="exportCurrentSheetFormatted()">Export Current Sheet (Formatted)</button>
                <button onclick="exportPerksDatabase()">Export Perks Database</button>
                <button onclick="exportSettings()">Export Settings</button>
            </div>
            
            <div class="panel">
                <h3>📥 Import Options</h3>
                <div>
                    <label>Import Sheet:</label>
                    <input type="file" class="file-input" id="import-sheet" accept=".json" onchange="importSheet(this)">
                </div>
                <div style="margin-top: 15px;">
                    <label>Import Perks Database:</label>
                    <input type="file" class="file-input" id="import-perks" accept=".json" onchange="importPerks(this)">
                </div>
                <div style="margin-top: 15px;">
                    <label>Import Settings:</label>
                    <input type="file" class="file-input" id="import-settings" accept=".json" onchange="importSettings(this)">
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="panel">
                <h3>⚙️ Application Settings</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="confirm-selections">Confirm perk selection</label>
                        <input type="checkbox" id="confirm-selections" checked>
                    </div>
                    <div class="setting-item">
                        <label for="show-descriptions">Show full descriptions</label>
                        <input type="checkbox" id="show-descriptions" checked>
                    </div>
                    <div class="setting-item">
                        <label for="remember-last-sheet">Remember last sheet name</label>
                        <input type="checkbox" id="remember-last-sheet" checked>
                    </div>
                </div>
                <button onclick="saveSettings()">Save Settings</button>
                <button onclick="resetSettings()">Reset to Defaults</button>
            </div>
        </div>

        <div class="success" id="success-message"></div>
        <div class="error" id="error-message"></div>
    </div>

    <!-- Perk Detail Modal -->
    <div id="perk-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-perk-name">Perk Name</h3>
                <span class="close" onclick="closePerkModal()">&times;</span>
            </div>
            <div id="modal-perk-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="modal-add-perk" onclick="addPerkFromModal()">Add to Sheet</button>
                <button onclick="closePerkModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let perksData = {};
        let currentSheet = [];
        let currentCP = 0;
        let settings = {
            confirmSelections: true,
            showDescriptions: true,
            rememberLastSheet: true
        };
        let selectedPerk = null;
        let currentEditingPerk = null;
        let currentEditingDomain = null;
        let parsedPerks = [];

        // Tab management functions

        // Load data on page load
        window.addEventListener('load', async () => {
            await loadPerksData();
            loadSettings();
            loadCurrentSheetData();
            showTab('perk-browser');
        });

        async function loadPerksData() {
            try {
                const response = await fetch('perks.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                perksData = await response.json();
                
                populateDomainFilter();
                updateStats();
                displayPerks();
                showSuccess('Perks database loaded successfully!');
            } catch (error) {
                showError(`Failed to load perks database: ${error.message}`);
            }
        }

        function loadCurrentSheetData() {
            // Try to get current sheet data from localStorage
            const sheetData = localStorage.getItem('forgeSheet');
            const cpData = localStorage.getItem('forgeCPData');
            
            if (sheetData) {
                try {
                    currentSheet = JSON.parse(sheetData);
                } catch (e) {
                    currentSheet = [];
                }
            }
            
            if (cpData) {
                try {
                    const parsed = JSON.parse(cpData);
                    currentCP = parsed.currentCP || 0;
                } catch (e) {
                    currentCP = 0;
                }
            }
            
            updateStats();
        }

        function populateDomainFilter() {
            const select = document.getElementById('domain-filter');
            select.innerHTML = '<option value="">All Domains</option>';
            
            Object.keys(perksData).sort().forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
            const totalDomains = Object.keys(perksData).length;
            const affordablePerks = Object.values(perksData).reduce((sum, perks) => {
                return sum + perks.filter(p => (p.cost || 0) <= 1000).length;
            }, 0);

            document.getElementById('total-perks').textContent = totalPerks;
            document.getElementById('total-domains').textContent = totalDomains;
            document.getElementById('affordable-perks').textContent = affordablePerks;
        }

        function filterPerks() {
            const searchTerm = document.getElementById('perk-search').value.toLowerCase();
            const domainFilter = document.getElementById('domain-filter').value;
            
            displayPerks(searchTerm, domainFilter);
        }

        function displayPerks(searchTerm = '', domainFilter = '') {
            const perkList = document.getElementById('perk-list');
            perkList.innerHTML = '';

            const domainsToShow = domainFilter ? [domainFilter] : Object.keys(perksData);

            domainsToShow.forEach(domain => {
                const perks = perksData[domain] || [];
                
                perks.forEach(perk => {
                    const matchesSearch = !searchTerm || 
                        perk.name.toLowerCase().includes(searchTerm) ||
                        (perk.description && perk.description.toLowerCase().includes(searchTerm)) ||
                        (perk.origin && perk.origin.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        const perkItem = createPerkElement(perk, domain);
                        perkList.appendChild(perkItem);
                    }
                });
            });
        }

        function createPerkElement(perk, domain) {
            const div = document.createElement('div');
            div.className = 'perk-item';
            div.onclick = () => showPerkModal(perk, domain);

            const cost = perk.cost || 0;
            const description = perk.description || 'No description available';
            const truncatedDesc = description.length > 150 ? description.substring(0, 150) + '...' : description;

            div.innerHTML = `
                <div class="perk-name">${perk.name}</div>
                <div class="perk-origin">${perk.origin || 'Unknown Origin'} - ${domain}</div>
                <div class="perk-cost">[${cost} CP]</div>
                <div class="perk-description">${truncatedDesc}</div>
            `;

            return div;
        }

        function showPerkModal(perk, domain) {
            selectedPerk = { ...perk, domain };
            
            document.getElementById('modal-perk-name').textContent = perk.name;
            
            const cost = perk.cost || 0;
            const canAfford = cost <= currentCP;
            
            document.getElementById('modal-perk-content').innerHTML = `
                <p><strong>Origin:</strong> ${perk.origin || 'Unknown'}</p>
                <p><strong>Domain:</strong> ${domain}</p>
                <p><strong>Cost:</strong> <span style="color: ${canAfford ? '#81c784' : '#f44336'}">${cost} CP</span></p>
                ${cost > currentCP ? '<p style="color: #f44336;"><em>Insufficient CP!</em></p>' : ''}
                <p><strong>Description:</strong></p>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    ${perk.description || 'No description available'}
                </div>
                ${perk.sub_perks && perk.sub_perks.length > 0 ? `
                    <p><strong>Sub-perks:</strong></p>
                    <ul>
                        ${perk.sub_perks.map(sp => `<li><strong>${sp.name}</strong> [${sp.cost || 0} CP] - ${sp.description || 'No description'}</li>`).join('')}
                    </ul>
                ` : ''}
            `;
            
            const addButton = document.getElementById('modal-add-perk');
            addButton.disabled = !canAfford;
            addButton.style.opacity = canAfford ? '1' : '0.5';
            
            document.getElementById('perk-modal').style.display = 'block';
        }

        function closePerkModal() {
            document.getElementById('perk-modal').style.display = 'none';
            selectedPerk = null;
        }

        function addPerkFromModal() {
            if (!selectedPerk) return;
            
            const cost = selectedPerk.cost || 0;
            if (cost > currentCP) {
                showError('Insufficient CP!');
                return;
            }
            
            if (settings.confirmSelections) {
                if (!confirm(`Add "${selectedPerk.name}" to your sheet for ${cost} CP?`)) {
                    return;
                }
            }
            
            // Add to sheet
            currentSheet.push(selectedPerk);
            currentCP -= cost;
            
            // Save to localStorage
            localStorage.setItem('forgeSheet', JSON.stringify(currentSheet));
            localStorage.setItem('forgeCPData', JSON.stringify({ currentCP, totalCP: currentCP }));
            
            updateStats();
            closePerkModal();
            showSuccess(`"${selectedPerk.name}" added to sheet!`);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Refresh data for specific tabs
            if (tabName === 'sheet-manager') {
                refreshSheetList();
            }
        }

        function refreshSheetList() {
            const sheetList = document.getElementById('sheet-list');
            sheetList.innerHTML = '';
            
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            
            if (Object.keys(savedSheets).length === 0) {
                sheetList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No saved sheets found</div>';
                return;
            }
            
            Object.entries(savedSheets).forEach(([name, data]) => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'sheet-item';
                
                const timestamp = new Date(data.timestamp).toLocaleString();
                const perkCount = data.sheet ? data.sheet.length : 0;
                const cpSpent = data.sheet ? data.sheet.reduce((sum, p) => sum + (p.cost || 0), 0) : 0;
                
                sheetItem.innerHTML = `
                    <div class="sheet-info">
                        <div style="font-weight: bold; color: #64b5f6;">${name}</div>
                        <div style="font-size: 0.9em; color: #c0c0c0;">
                            ${perkCount} perks, ${cpSpent} CP spent, saved ${timestamp}
                        </div>
                    </div>
                    <div class="sheet-actions">
                        <button onclick="loadSheet('${name}')">Load</button>
                        <button onclick="exportSheet('${name}')">Export</button>
                        <button class="danger" onclick="deleteSheet('${name}')">Delete</button>
                    </div>
                `;
                
                sheetList.appendChild(sheetItem);
            });
        }

        function loadSheet(name) {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const sheetData = savedSheets[name];
            
            if (!sheetData) {
                showError('Sheet not found!');
                return;
            }
            
            // Load into current sheet
            localStorage.setItem('forgeSheet', JSON.stringify(sheetData.sheet || []));
            localStorage.setItem('forgeCPData', JSON.stringify({
                currentCP: sheetData.currentCP || 0,
                totalCP: sheetData.totalCP || 0
            }));
            
            loadCurrentSheetData();
            showSuccess(`Sheet "${name}" loaded!`);
        }

        function exportSheet(name) {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const sheetData = savedSheets[name];
            
            if (!sheetData) {
                showError('Sheet not found!');
                return;
            }
            
            const blob = new Blob([JSON.stringify(sheetData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/[^a-z0-9]/gi, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess(`Sheet "${name}" exported!`);
        }

        function deleteSheet(name) {
            if (!confirm(`Delete sheet "${name}"? This cannot be undone.`)) {
                return;
            }
            
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            delete savedSheets[name];
            localStorage.setItem('forgeSheets', JSON.stringify(savedSheets));
            
            refreshSheetList();
            showSuccess(`Sheet "${name}" deleted!`);
        }

        function exportCurrentSheet() {
            const blob = new Blob([JSON.stringify(currentSheet, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'current_sheet.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Current sheet exported!');
        }

        function exportCurrentSheetFormatted() {
            let txt = '<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\\n<hr>\\n';
            
            currentSheet.forEach(perk => {
                txt += `[${perk.name}] - ${perk.origin || 'Unknown'} - ${perk.cost || 0} CP\\n`;
                txt += `${perk.description || 'No description available'}\\n<hr>\\n`;
            });
            
            txt += `Current CP: ${currentCP}\\nTotal Perks: ${currentSheet.length}\\n<hr>`;
            
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'current_sheet_formatted.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Formatted sheet exported!');
        }

        function exportPerksDatabase() {
            const blob = new Blob([JSON.stringify(perksData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'perks_database.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Perks database exported!');
        }

        function exportSettings() {
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'forge_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Settings exported!');
        }

        function exportAllSheets() {
            const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
            const blob = new Blob([JSON.stringify(savedSheets, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_sheets.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('All sheets exported!');
        }

        function clearAllSheets() {
            if (!confirm('Delete ALL saved sheets? This cannot be undone!')) {
                return;
            }
            
            localStorage.removeItem('forgeSheets');
            refreshSheetList();
            showSuccess('All sheets cleared!');
        }

        async function importSheet(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                if (Array.isArray(importedData)) {
                    // Direct sheet import
                    currentSheet = importedData;
                    localStorage.setItem('forgeSheet', JSON.stringify(currentSheet));
                    loadCurrentSheetData();
                    showSuccess(`Sheet imported from "${file.name}"!`);
                } else if (importedData.sheet) {
                    // Full sheet data import
                    localStorage.setItem('forgeSheet', JSON.stringify(importedData.sheet || []));
                    localStorage.setItem('forgeCPData', JSON.stringify({
                        currentCP: importedData.currentCP || 0,
                        totalCP: importedData.totalCP || 0
                    }));
                    loadCurrentSheetData();
                    showSuccess(`Sheet data imported from "${file.name}"!`);
                } else {
                    showError('Invalid sheet format!');
                }
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        async function importPerks(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedPerks = JSON.parse(text);
                
                perksData = importedPerks;
                populateDomainFilter();
                updateStats();
                displayPerks();
                showSuccess(`Perks database imported from "${file.name}"!`);
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        async function importSettings(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedSettings = JSON.parse(text);
                
                settings = { ...settings, ...importedSettings };
                saveSettings();
                showSuccess(`Settings imported from "${file.name}"!`);
            } catch (error) {
                showError(`Import failed: ${error.message}`);
            }
            
            input.value = '';
        }

        function loadSettings() {
            const saved = localStorage.getItem('forgeSettings');
            if (saved) {
                try {
                    settings = { ...settings, ...JSON.parse(saved) };
                } catch (e) {
                    // Use defaults
                }
            }
            
            // Update UI
            document.getElementById('confirm-selections').checked = settings.confirmSelections;
            document.getElementById('show-descriptions').checked = settings.showDescriptions;
            document.getElementById('remember-last-sheet').checked = settings.rememberLastSheet;
        }

        function saveSettings() {
            settings = {
                confirmSelections: document.getElementById('confirm-selections').checked,
                showDescriptions: document.getElementById('show-descriptions').checked,
                rememberLastSheet: document.getElementById('remember-last-sheet').checked
            };
            
            localStorage.setItem('forgeSettings', JSON.stringify(settings));
            showSuccess('Settings saved!');
        }

        function resetSettings() {
            if (!confirm('Reset all settings to defaults?')) {
                return;
            }
            
            settings = {
                confirmSelections: true,
                showDescriptions: true,
                rememberLastSheet: true
            };
            
            localStorage.setItem('forgeSettings', JSON.stringify(settings));
            loadSettings();
            showSuccess('Settings reset to defaults!');
        }

        function goToForge() {
            window.location.href = 'forge-enhanced.html';
        }

        function showSuccess(message) {
            const el = document.getElementById('success-message');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        // Perk Editor Functions
        function showEditorTab(tabName) {
            // Hide all editor tabs
            document.querySelectorAll('.editor-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Initialize the tab if needed
            if (tabName === 'individual-editor') {
                populatePerkEditorFilters();
                displayPerksForEditing();
            }
        }

        // Raw File Editor Functions
        function loadRawPerksData() {
            const editor = document.getElementById('raw-perks-editor');
            const status = document.getElementById('raw-editor-status');
            
            try {
                editor.value = JSON.stringify(perksData, null, 2);
                status.textContent = 'Database loaded successfully';
                status.style.color = '#4caf50';
            } catch (error) {
                status.textContent = `Error loading database: ${error.message}`;
                status.style.color = '#f44336';
            }
        }

        function validateRawPerksData() {
            const editor = document.getElementById('raw-perks-editor');
            const status = document.getElementById('raw-editor-status');
            const text = editor.value.trim();
            
            if (!text) {
                status.textContent = 'No data to validate';
                status.style.color = '#ff9800';
                return false;
            }
            
            try {
                const parsed = JSON.parse(text);
                
                // Validate structure
                if (typeof parsed !== 'object' || Array.isArray(parsed)) {
                    throw new Error('Root must be an object (domains)');
                }
                
                let totalPerks = 0;
                for (const [domain, perks] of Object.entries(parsed)) {
                    if (!Array.isArray(perks)) {
                        throw new Error(`Domain "${domain}" must contain an array of perks`);
                    }
                    
                    perks.forEach((perk, index) => {
                        if (!perk.name || typeof perk.name !== 'string') {
                            throw new Error(`Perk at index ${index} in domain "${domain}" missing valid name`);
                        }
                        if (perk.cost !== undefined && (typeof perk.cost !== 'number' || perk.cost < 0)) {
                            throw new Error(`Perk "${perk.name}" has invalid cost`);
                        }
                    });
                    
                    totalPerks += perks.length;
                }
                
                status.textContent = `✓ Valid JSON - ${Object.keys(parsed).length} domains, ${totalPerks} perks`;
                status.style.color = '#4caf50';
                return true;
            } catch (error) {
                status.textContent = `✗ Invalid JSON: ${error.message}`;
                status.style.color = '#f44336';
                return false;
            }
        }

        function formatRawPerksData() {
            const editor = document.getElementById('raw-perks-editor');
            const status = document.getElementById('raw-editor-status');
            const text = editor.value.trim();
            
            if (!text) {
                status.textContent = 'No data to format';
                status.style.color = '#ff9800';
                return;
            }
            
            try {
                const parsed = JSON.parse(text);
                editor.value = JSON.stringify(parsed, null, 2);
                status.textContent = 'JSON formatted successfully';
                status.style.color = '#4caf50';
            } catch (error) {
                status.textContent = `Cannot format invalid JSON: ${error.message}`;
                status.style.color = '#f44336';
            }
        }

        function saveRawPerksData() {
            if (!validateRawPerksData()) {
                return;
            }
            
            const editor = document.getElementById('raw-perks-editor');
            const status = document.getElementById('raw-editor-status');
            
            try {
                const newPerksData = JSON.parse(editor.value);
                perksData = newPerksData;
                
                // Update the perk browser
                populateDomainFilter();
                updateStats();
                displayPerks();
                
                // Update individual editor
                populatePerkEditorFilters();
                displayPerksForEditing();
                
                status.textContent = 'Database saved successfully!';
                status.style.color = '#4caf50';
                showSuccess('Perks database updated successfully!');
            } catch (error) {
                status.textContent = `Save failed: ${error.message}`;
                status.style.color = '#f44336';
                showError(`Failed to save database: ${error.message}`);
            }
        }

        // Individual Perk Editor Functions
        function populatePerkEditorFilters() {
            const domainFilter = document.getElementById('perk-editor-domain-filter');
            domainFilter.innerHTML = '<option value="">All Domains</option>';
            
            Object.keys(perksData).sort().forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                domainFilter.appendChild(option);
            });
            
            // Also populate the edit form domain dropdown
            const editDomain = document.getElementById('edit-perk-domain');
            editDomain.innerHTML = '<option value="">Select Domain</option>';
            
            Object.keys(perksData).sort().forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = domain;
                editDomain.appendChild(option);
            });
        }

        function filterPerksForEditing() {
            const searchTerm = document.getElementById('perk-editor-search').value.toLowerCase();
            const domainFilter = document.getElementById('perk-editor-domain-filter').value;
            
            displayPerksForEditing(searchTerm, domainFilter);
        }

        function displayPerksForEditing(searchTerm = '', domainFilter = '') {
            const perkList = document.getElementById('perk-editor-list');
            perkList.innerHTML = '';

            const domainsToShow = domainFilter ? [domainFilter] : Object.keys(perksData);

            domainsToShow.forEach(domain => {
                const perks = perksData[domain] || [];
                
                perks.forEach((perk, index) => {
                    const matchesSearch = !searchTerm || 
                        perk.name.toLowerCase().includes(searchTerm) ||
                        (perk.description && perk.description.toLowerCase().includes(searchTerm)) ||
                        (perk.origin && perk.origin.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        const perkItem = document.createElement('div');
                        perkItem.className = 'perk-item-editor';
                        perkItem.onclick = () => editPerk(domain, index);
                        
                        perkItem.innerHTML = `
                            <div class="perk-item-info">
                                <div class="perk-item-name">${perk.name}</div>
                                <div class="perk-item-domain">${domain}${perk.origin ? ' - ' + perk.origin : ''}</div>
                            </div>
                            <div class="perk-item-cost">${perk.cost || 0} CP</div>
                        `;
                        
                        perkList.appendChild(perkItem);
                    }
                });
            });
        }

        function editPerk(domain, index) {
            const perk = perksData[domain][index];
            currentEditingPerk = { domain, index };
            
            // Show the edit form
            document.getElementById('perk-edit-form').style.display = 'block';
            document.getElementById('editing-perk-name').textContent = perk.name;
            
            // Populate the form
            document.getElementById('edit-perk-name').value = perk.name || '';
            document.getElementById('edit-perk-domain').value = domain;
            document.getElementById('edit-perk-origin').value = perk.origin || '';
            document.getElementById('edit-perk-cost').value = perk.cost || 0;
            document.getElementById('edit-perk-description').value = perk.description || '';
            
            // Handle Primary Perk checkbox and sub-perks
            const isPrimary = perk.is_primary || false;
            document.getElementById('edit-perk-primary').checked = isPrimary;
            toggleSubPerksSection(isPrimary);
            
            if (isPrimary) {
                displayCurrentSubPerks(perk.sub_perks || []);
            }
            
            // Scroll to form
            document.getElementById('perk-edit-form').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleSubPerksSection(show) {
            const section = document.getElementById('sub-perks-section');
            const descriptionGroup = document.getElementById('edit-perk-description').parentElement;
            
            if (show) {
                section.style.display = 'block';
                descriptionGroup.style.display = 'none';
            } else {
                section.style.display = 'none';
                descriptionGroup.style.display = 'block';
                // Clear sub-perk search
                document.getElementById('sub-perk-search').value = '';
                document.getElementById('sub-perk-results').style.display = 'none';
            }
        }

        function displayCurrentSubPerks(subPerks) {
            const container = document.getElementById('current-sub-perks');
            
            if (!subPerks || subPerks.length === 0) {
                container.innerHTML = '<em>No sub-perks added yet</em>';
                return;
            }
            
            container.innerHTML = '';
            subPerks.forEach((subPerk, index) => {
                const item = document.createElement('div');
                item.className = 'sub-perk-item';
                item.innerHTML = `
                    <div class="sub-perk-info">
                        <div class="sub-perk-name">${subPerk.name}</div>
                        <div class="sub-perk-details">${subPerk.origin || 'Unknown'} - ${subPerk.cost || 0} CP</div>
                    </div>
                    <button class="sub-perk-remove" onclick="removeSubPerk(${index})">&times;</button>
                `;
                container.appendChild(item);
            });
        }

        function searchSubPerks() {
            const searchTerm = document.getElementById('sub-perk-search').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('sub-perk-results');
            
            if (!searchTerm || searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            resultsContainer.innerHTML = '';
            const currentSubPerkNames = getCurrentSubPerkNames();
            
            // Search through all perks in all domains
            Object.keys(perksData).forEach(domain => {
                const perks = perksData[domain] || [];
                perks.forEach(perk => {
                    // Don't show the current perk being edited or already added sub-perks
                    if (currentEditingPerk && 
                        domain === currentEditingPerk.domain && 
                        perk.name === perksData[currentEditingPerk.domain][currentEditingPerk.index].name) {
                        return;
                    }
                    
                    if (currentSubPerkNames.includes(perk.name)) {
                        return;
                    }
                    
                    const matchesSearch = perk.name.toLowerCase().includes(searchTerm) ||
                        (perk.description && perk.description.toLowerCase().includes(searchTerm)) ||
                        (perk.origin && perk.origin.toLowerCase().includes(searchTerm));
                    
                    if (matchesSearch) {
                        const item = document.createElement('div');
                        item.className = 'sub-perk-result-item';
                        item.onclick = () => addSubPerk(perk, domain);
                        item.innerHTML = `
                            <div class="sub-perk-result-name">${perk.name}</div>
                            <div class="sub-perk-result-info">${perk.origin || 'Unknown'} - ${perk.cost || 0} CP - ${domain}</div>
                        `;
                        resultsContainer.appendChild(item);
                    }
                });
            });
            
            resultsContainer.style.display = resultsContainer.children.length > 0 ? 'block' : 'none';
        }

        function getCurrentSubPerkNames() {
            if (!currentEditingPerk) return [];
            
            const perk = perksData[currentEditingPerk.domain][currentEditingPerk.index];
            return (perk.sub_perks || []).map(sp => sp.name);
        }

        function addSubPerk(perk, domain) {
            if (!currentEditingPerk) return;
            
            const currentPerk = perksData[currentEditingPerk.domain][currentEditingPerk.index];
            if (!currentPerk.sub_perks) {
                currentPerk.sub_perks = [];
            }
            
            // Create sub-perk object with essential info
            const subPerk = {
                name: perk.name,
                origin: perk.origin || '',
                cost: perk.cost || 0,
                description: perk.description || '',
                domain: domain
            };
            
            currentPerk.sub_perks.push(subPerk);
            displayCurrentSubPerks(currentPerk.sub_perks);
            
            // Clear search
            document.getElementById('sub-perk-search').value = '';
            document.getElementById('sub-perk-results').style.display = 'none';
        }

        function removeSubPerk(index) {
            if (!currentEditingPerk) return;
            
            const currentPerk = perksData[currentEditingPerk.domain][currentEditingPerk.index];
            if (currentPerk.sub_perks && currentPerk.sub_perks[index]) {
                currentPerk.sub_perks.splice(index, 1);
                displayCurrentSubPerks(currentPerk.sub_perks);
            }
        }

        function savePerkEdit() {
            if (!currentEditingPerk) return;
            
            const { domain: oldDomain, index } = currentEditingPerk;
            const newName = document.getElementById('edit-perk-name').value.trim();
            const newDomain = document.getElementById('edit-perk-domain').value;
            const newOrigin = document.getElementById('edit-perk-origin').value.trim();
            const newCost = parseInt(document.getElementById('edit-perk-cost').value) || 0;
            const newDescription = document.getElementById('edit-perk-description').value.trim();
            const isPrimary = document.getElementById('edit-perk-primary').checked;
            
            if (!newName) {
                showError('Perk name is required');
                return;
            }
            
            if (!newDomain) {
                showError('Domain is required');
                return;
            }
            
            // Create updated perk
            const updatedPerk = {
                name: newName,
                origin: newOrigin,
                cost: newCost,
                description: newDescription,
                sub_perks: perksData[oldDomain][index].sub_perks || []
            };
            
            // Add Primary Perk properties
            if (isPrimary) {
                updatedPerk.is_primary = true;
                // For Primary Perks, calculate total cost from sub-perks if they exist
                if (updatedPerk.sub_perks && updatedPerk.sub_perks.length > 0) {
                    updatedPerk.cost = updatedPerk.sub_perks.reduce((total, sp) => total + (sp.cost || 0), 0);
                }
            } else {
                // If no longer primary, clear sub-perks and restore normal description
                delete updatedPerk.is_primary;
                updatedPerk.sub_perks = [];
            }
            
            // If domain changed, move the perk
            if (newDomain !== oldDomain) {
                // Remove from old domain
                perksData[oldDomain].splice(index, 1);
                
                // Add to new domain (create if doesn't exist)
                if (!perksData[newDomain]) {
                    perksData[newDomain] = [];
                }
                perksData[newDomain].push(updatedPerk);
            } else {
                // Update in place
                perksData[oldDomain][index] = updatedPerk;
            }
            
            // Update displays
            populateDomainFilter();
            updateStats();
            displayPerks();
            populatePerkEditorFilters();
            displayPerksForEditing();
            
            // Hide form
            cancelPerkEdit();
            
            showSuccess(`Perk "${newName}" saved successfully!`);
        }

        function deletePerk() {
            if (!currentEditingPerk) return;
            
            const { domain, index } = currentEditingPerk;
            const perkName = perksData[domain][index].name;
            
            if (!confirm(`Are you sure you want to delete the perk "${perkName}"? This cannot be undone.`)) {
                return;
            }
            
            // Remove the perk
            perksData[domain].splice(index, 1);
            
            // If domain is now empty, remove it
            if (perksData[domain].length === 0) {
                delete perksData[domain];
            }
            
            // Update displays
            populateDomainFilter();
            updateStats();
            displayPerks();
            populatePerkEditorFilters();
            displayPerksForEditing();
            
            // Hide form
            cancelPerkEdit();
            
            showSuccess(`Perk "${perkName}" deleted successfully!`);
        }

        function cancelPerkEdit() {
            document.getElementById('perk-edit-form').style.display = 'none';
            currentEditingPerk = null;
            
            // Clear form
            document.getElementById('edit-perk-name').value = '';
            document.getElementById('edit-perk-domain').value = '';
            document.getElementById('edit-perk-origin').value = '';
            document.getElementById('edit-perk-cost').value = '';
            document.getElementById('edit-perk-description').value = '';
        }

        // Perk Compiler Functions
        function setupFileDropZone() {
            const dropZone = document.getElementById('file-drop-zone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFileUpload(e.dataTransfer.files);
            });
        }

        function handleFileUpload(files) {
            if (files.length === 0) return;
            
            const supportedTypes = ['.txt', '.doc', '.docx', '.pdf'];
            const validFiles = Array.from(files).filter(file => {
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                return supportedTypes.includes(extension);
            });
            
            if (validFiles.length === 0) {
                showError('No supported files found. Please upload .txt, .doc, .docx, or .pdf files.');
                return;
            }
            
            parseFiles(validFiles);
        }

        async function parseFiles(files) {
            const statusDiv = document.getElementById('parsing-status');
            const progressBar = document.getElementById('parsing-progress');
            const resultsDiv = document.getElementById('compiler-results');
            
            statusDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            parsedPerks = [];
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progress = ((i + 1) / files.length) * 100;
                    progressBar.style.width = progress + '%';
                    
                    statusDiv.querySelector('div').textContent = `Parsing ${file.name}...`;
                    
                    const text = await readFileAsText(file);
                    const foundPerks = extractPerksFromText(text, file.name);
                    parsedPerks.push(...foundPerks);
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                statusDiv.style.display = 'none';
                displayCompiledPerks();
                
            } catch (error) {
                showError(`Failed to parse files: ${error.message}`);
                statusDiv.style.display = 'none';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        function extractPerksFromText(text, filename) {
            const perks = [];
            const lines = text.split('\n');
            
            // Common perk patterns
            const perkPatterns = [
                // Pattern: Name [Cost CP] - Description
                /^(.+?)\s*\[(\d+)\s*CP\]\s*-\s*(.+)$/,
                // Pattern: Name (Cost CP): Description  
                /^(.+?)\s*\((\d+)\s*CP\):\s*(.+)$/,
                // Pattern: Name - Cost CP - Description
                /^(.+?)\s*-\s*(\d+)\s*CP\s*-\s*(.+)$/,
                // Pattern: **Name** [Cost] Description
                /^\*\*(.+?)\*\*\s*\[(\d+)\]\s*(.+)$/
            ];
            
            let currentPerk = null;
            let descriptionLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                let matched = false;
                
                // Try each pattern
                for (const pattern of perkPatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        // Save previous perk if exists
                        if (currentPerk) {
                            currentPerk.description = descriptionLines.join(' ').trim();
                            if (currentPerk.description.length > 20) { // Only add if description is substantial
                                perks.push(currentPerk);
                            }
                        }
                        
                        // Start new perk
                        currentPerk = {
                            name: match[1].trim(),
                            cost: parseInt(match[2]) || 0,
                            description: match[3] ? match[3].trim() : '',
                            origin: filename.replace(/\.[^/.]+$/, ""), // Remove file extension
                            domain: '', // Will be set by user
                            sub_perks: []
                        };
                        
                        descriptionLines = currentPerk.description ? [currentPerk.description] : [];
                        matched = true;
                        break;
                    }
                }
                
                // If no pattern matched and we have a current perk, this might be continuation of description
                if (!matched && currentPerk && line.length > 10) {
                    descriptionLines.push(line);
                }
            }
            
            // Don't forget the last perk
            if (currentPerk) {
                currentPerk.description = descriptionLines.join(' ').trim();
                if (currentPerk.description.length > 20) {
                    perks.push(currentPerk);
                }
            }
            
            return perks;
        }

        function displayCompiledPerks() {
            const resultsDiv = document.getElementById('compiler-results');
            resultsDiv.innerHTML = '';
            
            if (parsedPerks.length === 0) {
                resultsDiv.innerHTML = '<div class="parsing-status">No perks found. Try adjusting the file format or content.</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            parsedPerks.forEach((perk, index) => {
                const perkDiv = document.createElement('div');
                perkDiv.className = 'compiled-perk';
                perkDiv.id = `compiled-perk-${index}`;
                
                perkDiv.innerHTML = `
                    <div class="compiled-perk-form">
                        <div class="compiled-perk-row">
                            <input type="text" value="${perk.name}" placeholder="Perk Name" 
                                   onchange="updateCompiledPerk(${index}, 'name', this.value)">
                            <select onchange="updateCompiledPerk(${index}, 'domain', this.value)">
                                <option value="">Select Domain</option>
                                ${Object.keys(perksData).sort().map(domain => 
                                    `<option value="${domain}">${domain}</option>`
                                ).join('')}
                            </select>
                            <input type="number" value="${perk.cost}" placeholder="Cost" min="0"
                                   onchange="updateCompiledPerk(${index}, 'cost', parseInt(this.value) || 0)">
                            <button onclick="addCompiledPerk(${index})" style="background: #4caf50;">Add</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <input type="text" value="${perk.origin}" placeholder="Origin" style="width: 100%;"
                                   onchange="updateCompiledPerk(${index}, 'origin', this.value)">
                        </div>
                        <div style="margin-top: 10px;">
                            <textarea placeholder="Description" style="width: 100%; min-height: 80px;"
                                      onchange="updateCompiledPerk(${index}, 'description', this.value)">${perk.description}</textarea>
                        </div>
                    </div>
                `;
                
                resultsDiv.appendChild(perkDiv);
            });
            
            resultsDiv.style.display = 'block';
            showSuccess(`Found ${parsedPerks.length} potential perks!`);
        }

        function updateCompiledPerk(index, field, value) {
            if (parsedPerks[index]) {
                parsedPerks[index][field] = value;
            }
        }

        function addCompiledPerk(index) {
            const perk = parsedPerks[index];
            
            if (!perk.name.trim()) {
                showError('Perk name is required');
                return;
            }
            
            if (!perk.domain) {
                showError('Domain selection is required');
                return;
            }
            
            // Create the perk
            const newPerk = {
                name: perk.name.trim(),
                origin: perk.origin.trim(),
                cost: perk.cost || 0,
                description: perk.description.trim(),
                sub_perks: []
            };
            
            // Add to domain (create if doesn't exist)
            if (!perksData[perk.domain]) {
                perksData[perk.domain] = [];
            }
            perksData[perk.domain].push(newPerk);
            
            // Mark as added
            const perkDiv = document.getElementById(`compiled-perk-${index}`);
            perkDiv.classList.add('added');
            
            // Update displays
            populateDomainFilter();
            updateStats();
            displayPerks();
            populatePerkEditorFilters();
            
            showSuccess(`Added "${newPerk.name}" to ${perk.domain} domain!`);
        }

        // Initialize file drop zone and event listeners when page loads
        window.addEventListener('load', () => {
            setupFileDropZone();
            
            // Add event listener for Primary Perk checkbox
            const primaryCheckbox = document.getElementById('edit-perk-primary');
            if (primaryCheckbox) {
                primaryCheckbox.addEventListener('change', function() {
                    toggleSubPerksSection(this.checked);
                });
            }
        });

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('perk-modal');
            if (event.target === modal) {
                closePerkModal();
            }
        }
    </script>
</body>
</html>