<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celestial Forge Perk Selector</title>
  <style>
    body { font-family: monospace; background:#111; color:#eee; padding:1rem; }
    h2 { margin-top:0; }
    button { margin:0.25rem; padding:0.5rem 1rem; }
    .panel { border:1px solid #555; padding:1rem; margin-bottom:1rem; border-radius:8px; }
    .choices { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:0.5rem; }
    .choice { cursor:pointer; padding:0.6rem; border:1px solid #333; border-radius:6px; background:#151515; }
    .choice:hover { background:#1f1f1f; }
    .sheet-entry { margin-bottom:0.6rem; border-bottom:1px dashed #333; padding-bottom:0.5rem; }
    details { margin-left:0.75rem; }
    textarea { width:100%; height:220px; }
    .error { color:#f55; font-weight:bold; }
    .row { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .cp-display { font-weight:bold; color:#4af; }
    .insufficient-cp { color:#f55; }
    .available-cp { color:#4f4; }
    
    /* Configuration Modal Styles */
    .config-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    
    .config-modal-content {
      background: #1a1a1a;
      margin: 2% auto;
      padding: 0;
      border: 2px solid #4af;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      height: 90%;
      position: relative;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
      overflow: hidden;
    }
    
    .config-modal-header {
      background: #4af;
      color: #111;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #4af;
    }
    
    .config-modal-header h2 {
      margin: 0;
      font-size: 1.5em;
      color: #111;
    }
    
    .config-close {
      background: transparent;
      border: none;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #111;
      padding: 0;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .config-close:hover {
      background: rgba(17, 17, 17, 0.2);
    }
    
    .config-modal-body {
      padding: 20px;
      height: calc(100% - 80px);
      overflow-y: auto;
      color: #eee;
    }
    
    .config-nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .config-nav-buttons button {
      background: #333;
      color: #eee;
      border: 1px solid #4af;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .config-nav-buttons button:hover,
    .config-nav-buttons button.active {
      background: #4af;
      color: #111;
    }
    
    .config-tab-content {
      display: none;
    }
    
    .config-tab-content.active {
      display: block;
    }
    
    .config-panel {
      background: #222;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #555;
    }
    
    .config-panel h3 {
      color: #4af;
      margin-top: 0;
      border-bottom: 1px solid #4af;
      padding-bottom: 8px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #4af;
    }
    
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #4af;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #ccc;
      margin-top: 5px;
    }
    
    .search-box, .config-select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: #333;
      border: 1px solid #4af;
      border-radius: 5px;
      color: #eee;
      font-size: 1em;
    }
    
    .search-box::placeholder {
      color: #888;
    }
    
    .config-perk-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #555;
      border-radius: 5px;
      background: #111;
    }
    
    .config-perk-item {
      padding: 10px;
      border-bottom: 1px solid #555;
      cursor: pointer;
    }
    
    .config-perk-item:hover {
      background: #1f1f1f;
    }
    
    .config-perk-item:last-child {
      border-bottom: none;
    }
    
    .config-perk-name {
      font-weight: bold;
      color: #4af;
      margin-bottom: 5px;
    }
    
    .config-perk-origin {
      color: #4f4;
      font-size: 0.9em;
      margin-bottom: 3px;
    }
    
    .config-perk-cost {
      color: #fa4;
      font-weight: bold;
    }
    
    .sheet-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #555;
      border-radius: 5px;
      background: #111;
    }
    
    .sheet-item {
      padding: 10px;
      border-bottom: 1px solid #555;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sheet-item:last-child {
      border-bottom: none;
    }
    
    .sheet-info {
      flex-grow: 1;
    }
    
    .sheet-actions {
      display: flex;
      gap: 5px;
    }
    
    .sheet-actions button {
      padding: 5px 10px;
      font-size: 0.8em;
    }
    
    .config-file-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      background: #333;
      border: 1px solid #4af;
      border-radius: 5px;
      color: #eee;
    }
    
    .config-checkbox-group {
      margin: 15px 0;
    }
    
    .config-checkbox-group label {
      display: flex;
      align-items: center;
      margin: 10px 0;
      cursor: pointer;
    }
    
    .config-checkbox-group input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    .danger {
      background: #f44 !important;
      color: white !important;
    }
    
    .danger:hover {
      background: #d33 !important;
    }
    
    .config-success {
      background: #4f4;
      color: #111;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    
    .config-error {
      background: #f44;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body>
  <h2>üåå Celestial Forge Perk Selector</h2>

  <div id="error-box" class="error"></div>

  <div id="cp-panel" class="panel">
    <h3>Choice Points (CP) Management</h3>
    <div class="row">
      <div>Current CP: <span id="current-cp">0</span></div>
      <div>Total CP Earned: <span id="total-cp">0</span></div>
      <div>CP Spent: <span id="spent-cp">0</span></div>
    </div>
    <div class="row">
      <button onclick="addCP()">Add CP</button>
      <button onclick="subtractCP()">Subtract CP</button>
      <button onclick="parseAIResponse()">Parse AI Response for CP</button>
      <button onclick="resetCP()">Reset CP</button>
    </div>
    <div class="row">
      <textarea id="ai-response" placeholder="Paste SillyTavern AI response here to extract CP total..." style="height:80px;"></textarea>
    </div>
  </div>

  <div id="domain-panel" class="panel">
    <h3>Step 1: Choose a Domain</h3>
    <div id="domain-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollDomains()">Reroll Domains</button>
    </div>
  </div>

  <div id="perk-panel" class="panel" style="display:none;">
    <h3>Step 2: Choose a Perk from <span id="selected-domain"></span></h3>
    <div id="perk-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollPerks()">Reroll Perks</button>
      <button onclick="backToDomains()">Back to Domains</button>
    </div>
  </div>

  <div id="sheet-panel" class="panel">
    <h3>Forge Sheet</h3>
    <div id="sheet"></div>
    <div class="row">
      <button onclick="saveSheet()">Save</button>
      <button onclick="loadSheet()">Load</button>
      <button onclick="wipeSheet()">Wipe</button>
      <button onclick="downloadSheet()">Download Sheet as JSON</button>
      <button onclick="openConfiguration()" style="background: #4CAF50; color: white;">‚öôÔ∏è Configuration</button>
    </div>
    <h4>Copyable for SillyTavern:</h4>
    <textarea id="export" readonly></textarea>
  </div>

  <!-- Configuration Modal -->
  <div id="config-modal" class="config-modal">
    <div class="config-modal-content">
      <div class="config-modal-header">
        <h2>‚öôÔ∏è Celestial Forge Configuration</h2>
        <button class="config-close" onclick="closeConfiguration()">&times;</button>
      </div>
      <div class="config-modal-body">
        <div class="config-nav-buttons">
          <button onclick="showConfigTab('perk-browser')" class="active" id="tab-perk-browser">Perk Browser</button>
          <button onclick="showConfigTab('sheet-manager')" id="tab-sheet-manager">Sheet Manager</button>
          <button onclick="showConfigTab('import-export')" id="tab-import-export">Import/Export</button>
          <button onclick="showConfigTab('settings')" id="tab-settings">Settings</button>
        </div>

        <div class="config-success" id="config-success-message"></div>
        <div class="config-error" id="config-error-message"></div>

        <!-- Perk Browser Tab -->
        <div id="config-perk-browser" class="config-tab-content active">
          <div class="config-panel">
            <h3>üîç Perk Database Browser</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="config-total-perks">-</div>
                <div class="stat-label">Total Perks</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="config-total-domains">-</div>
                <div class="stat-label">Domains</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="config-affordable-perks">-</div>
                <div class="stat-label">Affordable (Current CP)</div>
              </div>
            </div>
            
            <select id="config-domain-filter" class="config-select" onchange="configFilterPerks()">
              <option value="">All Domains</option>
            </select>
            
            <input type="text" class="search-box" id="config-perk-search" placeholder="Search perks by name or description..." oninput="configFilterPerks()">
            
            <div class="config-perk-list" id="config-perk-list"></div>
          </div>
        </div>

        <!-- Sheet Manager Tab -->
        <div id="config-sheet-manager" class="config-tab-content">
          <div class="config-panel">
            <h3>üìã Sheet Manager</h3>
            <div class="sheet-list" id="config-sheet-list"></div>
            <div style="margin-top: 15px;">
              <button onclick="configRefreshSheetList()">Refresh</button>
              <button onclick="configExportAllSheets()">Export All Sheets</button>
              <button class="danger" onclick="configClearAllSheets()">Clear All Sheets</button>
            </div>
          </div>
        </div>

        <!-- Import/Export Tab -->
        <div id="config-import-export" class="config-tab-content">
          <div class="config-panel">
            <h3>üì§ Export Options</h3>
            <button onclick="configExportCurrentSheet()">Export Current Sheet (JSON)</button>
            <button onclick="configExportCurrentSheetFormatted()">Export Current Sheet (Formatted)</button>
            <button onclick="configExportPerksDatabase()">Export Perks Database</button>
            <button onclick="configExportSettings()">Export Settings</button>
          </div>
          
          <div class="config-panel">
            <h3>üì• Import Options</h3>
            <div>
              <label>Import Sheet:</label>
              <input type="file" class="config-file-input" id="config-import-sheet" accept=".json" onchange="configImportSheet(this)">
            </div>
            <div style="margin-top: 15px;">
              <label>Import Perks Database:</label>
              <input type="file" class="config-file-input" id="config-import-perks" accept=".json" onchange="configImportPerks(this)">
            </div>
            <div style="margin-top: 15px;">
              <label>Import Settings:</label>
              <input type="file" class="config-file-input" id="config-import-settings" accept=".json" onchange="configImportSettings(this)">
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="config-settings" class="config-tab-content">
          <div class="config-panel">
            <h3>‚öôÔ∏è Application Settings</h3>
            <div class="config-checkbox-group">
              <label>
                <input type="checkbox" id="config-confirm-selections" checked>
                Confirm perk selections
              </label>
              <label>
                <input type="checkbox" id="config-show-descriptions" checked>
                Show full perk descriptions
              </label>
              <label>
                <input type="checkbox" id="config-remember-last-sheet" checked>
                Remember last saved sheet name
              </label>
            </div>
            <div style="margin-top: 20px;">
              <button onclick="configSaveSettings()">Save Settings</button>
              <button onclick="configResetSettings()">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let perksData = {};
    let currentDomain = null;
    let sheet = [];
    let currentCP = 0;
    let totalCP = 0;

    async function loadData(){
      try {
        const res = await fetch("perks.json");
        if(!res.ok) throw new Error("HTTP " + res.status);
        perksData = await res.json();
        rerollDomains();
      } catch (err) {
        document.getElementById("error-box").innerHTML =
          "‚ö†Ô∏è Could not load <b>perks.json</b>. Make sure it's in the same folder as this HTML file.<br>" +
          "If you are opening this with <code>file://</code>, it will fail. " +
          "Please run a local server instead:<br><br>" +
          "<code>python -m http.server 8000</code><br>" +
          "Then open <a href='http://localhost:8000/forge.html'>http://localhost:8000/forge.html</a>";
        console.error("Error loading perks.json:", err);
      }
    }

    function getRandomItems(arr, n){
      // avoid in-place shuffles that mutate source arrays
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function rerollDomains(){
      if(!perksData || Object.keys(perksData).length===0) return;
      document.getElementById("perk-panel").style.display = "none";
      const domains = Object.keys(perksData);
      const picks = getRandomItems(domains, Math.min(5, domains.length));
      const container = document.getElementById("domain-choices");
      container.innerHTML = "";
      picks.forEach(d => {
        const div = document.createElement("div");
        div.className = "choice";
        div.textContent = d;
        div.onclick = () => selectDomain(d);
        container.appendChild(div);
      });
    }

    function backToDomains(){
      currentDomain = null;
      document.getElementById("perk-panel").style.display = "none";
      rerollDomains();
    }

    function selectDomain(domain){
      currentDomain = domain;
      document.getElementById("selected-domain").textContent = domain;
      rerollPerks();
      document.getElementById("perk-panel").style.display = "block";
    }

    function renderSubPerks(p, containerDiv){
      if(!p.sub_perks || !p.sub_perks.length) return;
      const ul = document.createElement("ul");
      p.sub_perks.forEach(sp=>{
        const li = document.createElement("li");
        const btn = document.createElement("button");
        const cost = sp.cost || 0;
        const canAfford = cost <= currentCP;
        const costColor = canAfford ? "#4f4" : "#f55";
        
        btn.textContent = "Select Sub";
        btn.onclick = (ev)=>{
          ev.stopPropagation();           // prevent parent selection
          pickPerk(sp);
        };
        
        if (!canAfford) {
          btn.disabled = true;
          btn.style.opacity = "0.5";
        }
        
        li.innerHTML = `<b>${sp.name}</b> (${sp.origin||"Unknown"}) [<span style="color:${costColor}">${cost} CP</span>]`;
        li.appendChild(document.createTextNode(" "));
        li.appendChild(btn);
        ul.appendChild(li);
      });
      containerDiv.appendChild(ul);
    }

    function rerollPerks(){
      const allPerks = perksData[currentDomain] || [];
      const picks = getRandomItems(allPerks, Math.min(5, allPerks.length));
      const container = document.getElementById("perk-choices");
      container.innerHTML = "";
      picks.forEach(p => {
        const div = document.createElement("div");
        div.className = "choice";
        const cost = p.cost || 0;
        const canAfford = cost <= currentCP;
        const costColor = canAfford ? "#4f4" : "#f55";
        
        div.innerHTML = `<b>${p.name}</b> (${p.origin||"Unknown"}) [<span style="color:${costColor}">${cost} CP</span>]<br>${p.description}`;
        
        if (!canAfford) {
          div.style.opacity = "0.6";
          div.style.border = "1px solid #555";
        }
        
        // Show sub-perks (but don't include sub-perks in the random set ‚Äî they are nested only)
        renderSubPerks(p, div);
        div.onclick = ()=> pickPerk(p);   // picking parent buys parent (and conceptually its whole package)
        container.appendChild(div);
      });
    }

    function pickPerk(perk){
      const cost = perk.cost || 0;
      if (cost > currentCP) {
        alert(`Insufficient CP! You need ${cost} CP but only have ${currentCP} CP.`);
        return;
      }
      
      sheet.push(perk);
      currentCP -= cost;
      updateSheet();
      updateCPDisplay();
      rerollDomains(); // restart cycle after selection
    }

    function updateSheet(){
      const container = document.getElementById("sheet");
      container.innerHTML = "";
      sheet.forEach((p, idx)=>{
        const div = document.createElement("div");
        div.className = "sheet-entry";
        div.innerHTML = `<b>${p.name}</b> (${p.origin||"Unknown"}) [${p.cost} CP]<br>${p.description}`;
        // If parent has sub-perks, list them for clarity (the purchase conceptually includes them)
        if(p.sub_perks && p.sub_perks.length){
          const ul = document.createElement("ul");
          p.sub_perks.forEach(sp=>{
            const li = document.createElement("li");
            li.innerHTML = `<b>${sp.name}</b> (${sp.origin||"Unknown"}) [${sp.cost} CP]`;
            ul.appendChild(li);
          });
          div.appendChild(ul);
        }
        container.appendChild(div);
      });
      updateExport();
      updateCPDisplay();
    }

    function updateExport(){
      let txt = "<sheet>\n<div align=\"center\"> <b>THE CELESTIAL FORGE</b> </div>\n";
      sheet.forEach(p=>{
        const name = p.name || "Unknown Perk";
        const source = p.origin || "Unknown";
        const cost = p.cost || 0;
        txt += `${name} - ${source} - ${cost}\n`;
        
        // If sub-perks exist, list them as well
        if(p.sub_perks && p.sub_perks.length){
          p.sub_perks.forEach(sp=>{
            const subName = sp.name || "Unknown Sub-Perk";
            const subSource = sp.origin || "Unknown";
            const subCost = sp.cost || 0;
            txt += `  ‚îî ${subName} - ${subSource} - ${subCost}\n`;
          });
        }
      });
      txt += "</sheet>";
      document.getElementById("export").value = txt;
    }

    function saveSheet(){ localStorage.setItem("forgeSheet", JSON.stringify(sheet)); }
    function loadSheet(){ 
      const data = localStorage.getItem("forgeSheet"); 
      if(data){ 
        sheet = JSON.parse(data); 
        updateSheet(); 
      } 
    }
    function wipeSheet(){ 
      sheet = []; 
      updateSheet(); 
    }

    function downloadSheet(){
      const blob = new Blob([JSON.stringify(sheet)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'forge_sheet.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function updateCPDisplay(){
      const spentCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
      document.getElementById("current-cp").textContent = currentCP;
      document.getElementById("total-cp").textContent = totalCP;
      document.getElementById("spent-cp").textContent = spentCP;
      
      // Update CP display styling
      const currentCPElement = document.getElementById("current-cp");
      currentCPElement.className = currentCP > 0 ? "available-cp" : "insufficient-cp";
    }

    function addCP(){
      const amount = parseInt(prompt("How much CP to add?", "100"));
      if (amount && amount > 0) {
        currentCP += amount;
        totalCP += amount;
        updateCPDisplay();
        saveCPData();
      }
    }

    function subtractCP(){
      const amount = parseInt(prompt("How much CP to subtract?", "100"));
      if (amount && amount > 0) {
        currentCP = Math.max(0, currentCP - amount);
        updateCPDisplay();
        saveCPData();
      }
    }

    function resetCP(){
      if (confirm("Reset all CP data? This will set current and total CP to 0.")) {
        currentCP = 0;
        totalCP = 0;
        updateCPDisplay();
        saveCPData();
      }
    }

    function parseAIResponse(){
      const aiText = document.getElementById("ai-response").value;
      if (!aiText.trim()) {
        alert("Please paste an AI response to parse for CP!");
        return;
      }

      // Try to extract CP from various patterns in the AI response
      const cpPatterns = [
        /(?:current\s+)?(?:choice\s+)?(?:points?|cp)(?:\s*:?\s*)(\d+)/gi,
        /(\d+)\s*(?:choice\s+)?(?:points?|cp)/gi,
        /cp\s*(?:total|current|available)?\s*:?\s*(\d+)/gi,
        /total\s*cp\s*:?\s*(\d+)/gi
      ];

      let foundCP = null;
      for (const pattern of cpPatterns) {
        const matches = [...aiText.matchAll(pattern)];
        if (matches.length > 0) {
          foundCP = parseInt(matches[matches.length - 1][1]); // Get the last match
          break;
        }
      }

      if (foundCP !== null && foundCP >= 0) {
        const difference = foundCP - currentCP;
        currentCP = foundCP;
        if (difference > 0) {
          totalCP += difference;
        }
        updateCPDisplay();
        saveCPData();
        alert(`Found CP: ${foundCP}. Current CP updated!`);
        document.getElementById("ai-response").value = ""; // Clear the textarea
      } else {
        alert("Could not find CP amount in the AI response. Try patterns like 'CP: 500' or '500 Choice Points'");
      }
    }

    function saveCPData(){
      const cpData = { currentCP, totalCP };
      localStorage.setItem("forgeCPData", JSON.stringify(cpData));
    }

    function loadCPData(){
      const data = localStorage.getItem("forgeCPData");
      if (data) {
        const cpData = JSON.parse(data);
        currentCP = cpData.currentCP || 0;
        totalCP = cpData.totalCP || 0;
        updateCPDisplay();
      }
    }

    // Configuration Modal Functions
    function openConfiguration() {
      document.getElementById('config-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      initializeConfigurationData();
    }

    function closeConfiguration() {
      document.getElementById('config-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function showConfigTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.config-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.config-nav-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('config-' + tabName).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function initializeConfigurationData() {
      configLoadCurrentSheetData();
      configPopulateDomainFilter();
      configUpdateStats();
      configRefreshSheetList();
      configLoadSettings();
    }

    function configLoadCurrentSheetData() {
      configUpdateStats();
    }

    function configPopulateDomainFilter() {
      const select = document.getElementById('config-domain-filter');
      select.innerHTML = '<option value="">All Domains</option>';
      
      if (perksData && typeof perksData === 'object') {
        Object.keys(perksData).sort().forEach(domain => {
          const option = document.createElement('option');
          option.value = domain;
          option.textContent = domain;
          select.appendChild(option);
        });
      }
    }

    function configUpdateStats() {
      if (!perksData || typeof perksData !== 'object') {
        document.getElementById('config-total-perks').textContent = '0';
        document.getElementById('config-total-domains').textContent = '0';
        document.getElementById('config-affordable-perks').textContent = '0';
        return;
      }

      const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
      const totalDomains = Object.keys(perksData).length;
      const affordablePerks = Object.values(perksData).reduce((sum, perks) => {
        return sum + perks.filter(perk => (perk.cost || 0) <= currentCP).length;
      }, 0);

      document.getElementById('config-total-perks').textContent = totalPerks.toLocaleString();
      document.getElementById('config-total-domains').textContent = totalDomains;
      document.getElementById('config-affordable-perks').textContent = affordablePerks.toLocaleString();
    }

    function configFilterPerks() {
      const searchTerm = document.getElementById('config-perk-search').value.toLowerCase();
      const domainFilter = document.getElementById('config-domain-filter').value;
      configDisplayPerks(searchTerm, domainFilter);
    }

    function configDisplayPerks(searchTerm = '', domainFilter = '') {
      const perkList = document.getElementById('config-perk-list');
      perkList.innerHTML = '';

      if (!perksData || typeof perksData !== 'object') {
        perkList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No perks data loaded</div>';
        return;
      }

      let foundPerks = [];
      const domains = domainFilter ? [domainFilter] : Object.keys(perksData);

      domains.forEach(domain => {
        if (perksData[domain]) {
          perksData[domain].forEach(perk => {
            const matchesSearch = !searchTerm || 
              perk.name.toLowerCase().includes(searchTerm) || 
              (perk.description && perk.description.toLowerCase().includes(searchTerm));
            
            if (matchesSearch) {
              foundPerks.push({ ...perk, domain });
            }
          });
        }
      });

      if (foundPerks.length === 0) {
        perkList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No perks found matching your criteria</div>';
        return;
      }

      foundPerks.sort((a, b) => {
        const costDiff = (a.cost || 0) - (b.cost || 0);
        return costDiff !== 0 ? costDiff : a.name.localeCompare(b.name);
      });

      foundPerks.slice(0, 100).forEach(perk => {
        const perkElement = configCreatePerkElement(perk, perk.domain);
        perkList.appendChild(perkElement);
      });

      if (foundPerks.length > 100) {
        const moreElement = document.createElement('div');
        moreElement.style.padding = '10px';
        moreElement.style.textAlign = 'center';
        moreElement.style.color = '#888';
        moreElement.textContent = `... and ${foundPerks.length - 100} more. Try refining your search.`;
        perkList.appendChild(moreElement);
      }
    }

    function configCreatePerkElement(perk, domain) {
      const perkElement = document.createElement('div');
      perkElement.className = 'config-perk-item';
      
      const affordable = (perk.cost || 0) <= currentCP;
      const costColor = affordable ? '#4f4' : '#f44';
      
      perkElement.innerHTML = `
        <div class="config-perk-name">${perk.name}</div>
        <div class="config-perk-origin">${domain}</div>
        <div class="config-perk-cost" style="color: ${costColor};">${perk.cost || 0} CP</div>
      `;
      
      perkElement.onclick = () => configShowPerkModal(perk, domain);
      
      return perkElement;
    }

    function configShowPerkModal(perk, domain) {
      const affordable = (perk.cost || 0) <= currentCP;
      
      const modal = confirm(`${perk.name}\nDomain: ${domain}\nCost: ${perk.cost || 0} CP\n\n${perk.description || 'No description available'}\n\nAdd this perk to your sheet?`);
      
      if (modal && affordable) {
        sheet.push(perk);
        currentCP -= (perk.cost || 0);
        updateSheet();
        updateCPDisplay();
        saveData();
        configShowSuccess(`Added "${perk.name}" to your sheet!`);
        configUpdateStats();
      } else if (modal && !affordable) {
        configShowError('Insufficient CP to add this perk!');
      }
    }

    // Sheet Manager Functions
    function configRefreshSheetList() {
      const sheetList = document.getElementById('config-sheet-list');
      sheetList.innerHTML = '';
      
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      
      if (Object.keys(savedSheets).length === 0) {
        sheetList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No saved sheets found</div>';
        return;
      }
      
      Object.entries(savedSheets).forEach(([name, data]) => {
        const sheetItem = document.createElement('div');
        sheetItem.className = 'sheet-item';
        
        const timestamp = new Date(data.timestamp).toLocaleString();
        const perkCount = data.sheet ? data.sheet.length : 0;
        const cpSpent = data.sheet ? data.sheet.reduce((sum, p) => sum + (p.cost || 0), 0) : 0;
        
        sheetItem.innerHTML = `
          <div class="sheet-info">
            <div style="font-weight: bold; color: #4af;">${name}</div>
            <div style="font-size: 0.9em; color: #ccc;">
              ${perkCount} perks, ${cpSpent} CP spent, saved ${timestamp}
            </div>
          </div>
          <div class="sheet-actions">
            <button onclick="configLoadSheet('${name}')">Load</button>
            <button onclick="configExportSheet('${name}')">Export</button>
            <button class="danger" onclick="configDeleteSheet('${name}')">Delete</button>
          </div>
        `;
        
        sheetList.appendChild(sheetItem);
      });
    }

    function configLoadSheet(name) {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      const sheetData = savedSheets[name];
      
      if (!sheetData) {
        configShowError('Sheet not found!');
        return;
      }
      
      sheet = sheetData.sheet || [];
      currentCP = sheetData.currentCP || 0;
      totalCP = sheetData.totalCP || 0;
      
      updateSheet();
      updateCPDisplay();
      saveData();
      loadCPData();
      
      configShowSuccess(`Sheet "${name}" loaded!`);
      configUpdateStats();
    }

    function configExportSheet(name) {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      const sheetData = savedSheets[name];
      
      if (!sheetData) {
        configShowError('Sheet not found!');
        return;
      }
      
      const dataStr = JSON.stringify(sheetData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${name}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess(`Sheet "${name}" exported!`);
    }

    function configDeleteSheet(name) {
      if (!confirm(`Are you sure you want to delete the sheet "${name}"? This cannot be undone.`)) {
        return;
      }
      
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      delete savedSheets[name];
      localStorage.setItem('forgeSheets', JSON.stringify(savedSheets));
      
      configShowSuccess(`Sheet "${name}" deleted!`);
      configRefreshSheetList();
    }

    // Import/Export Functions
    function configExportCurrentSheet() {
      const exportData = {
        sheet: sheet,
        currentCP: currentCP,
        totalCP: totalCP,
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'current-sheet.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Current sheet exported!');
    }

    function configExportCurrentSheetFormatted() {
      const exportText = document.getElementById('export').value;
      if (!exportText) {
        configShowError('No sheet data to export!');
        return;
      }
      
      const dataBlob = new Blob([exportText], {type: 'text/plain'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'formatted-sheet.txt';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Formatted sheet exported!');
    }

    function configExportPerksDatabase() {
      if (!perksData) {
        configShowError('No perks database to export!');
        return;
      }
      
      const dataStr = JSON.stringify(perksData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'perks-database.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Perks database exported!');
    }

    function configExportSettings() {
      const settings = {
        confirmSelections: document.getElementById('config-confirm-selections').checked,
        showDescriptions: document.getElementById('config-show-descriptions').checked,
        rememberLastSheet: document.getElementById('config-remember-last-sheet').checked
      };
      
      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'forge-settings.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Settings exported!');
    }

    function configExportAllSheets() {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      
      if (Object.keys(savedSheets).length === 0) {
        configShowError('No saved sheets to export!');
        return;
      }
      
      const dataStr = JSON.stringify(savedSheets, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'all-sheets.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('All sheets exported!');
    }

    function configClearAllSheets() {
      if (!confirm('Are you sure you want to delete ALL saved sheets? This cannot be undone!')) {
        return;
      }
      
      localStorage.removeItem('forgeSheets');
      configShowSuccess('All sheets cleared!');
      configRefreshSheetList();
    }

    async function configImportSheet(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (!data.sheet || !Array.isArray(data.sheet)) {
          throw new Error('Invalid sheet format');
        }
        
        sheet = data.sheet;
        currentCP = data.currentCP || 0;
        totalCP = data.totalCP || 0;
        
        updateSheet();
        updateCPDisplay();
        saveData();
        
        configShowSuccess('Sheet imported successfully!');
        configUpdateStats();
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = '';
    }

    async function configImportPerks(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (typeof data !== 'object' || !Object.keys(data).length) {
          throw new Error('Invalid perks database format');
        }
        
        perksData = data;
        
        configPopulateDomainFilter();
        configUpdateStats();
        configDisplayPerks();
        
        configShowSuccess('Perks database imported successfully!');
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = '';
    }

    async function configImportSettings(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const settings = JSON.parse(text);
        
        // Apply settings (ignoring autoSave as it's disabled)
        if (settings.hasOwnProperty('confirmSelections')) {
          document.getElementById('config-confirm-selections').checked = settings.confirmSelections;
        }
        if (settings.hasOwnProperty('showDescriptions')) {
          document.getElementById('config-show-descriptions').checked = settings.showDescriptions;
        }
        if (settings.hasOwnProperty('rememberLastSheet')) {
          document.getElementById('config-remember-last-sheet').checked = settings.rememberLastSheet;
        }
        
        configSaveSettings();
        configShowSuccess('Settings imported successfully!');
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = '';
    }

    // Settings Functions
    function configLoadSettings() {
      const settings = JSON.parse(localStorage.getItem('forgeSettings') || '{}');
      
      document.getElementById('config-confirm-selections').checked = settings.confirmSelections !== false;
      document.getElementById('config-show-descriptions').checked = settings.showDescriptions !== false;
      document.getElementById('config-remember-last-sheet').checked = settings.rememberLastSheet !== false;
    }

    function configSaveSettings() {
      const settings = {
        confirmSelections: document.getElementById('config-confirm-selections').checked,
        showDescriptions: document.getElementById('config-show-descriptions').checked,
        rememberLastSheet: document.getElementById('config-remember-last-sheet').checked
      };
      
      localStorage.setItem('forgeSettings', JSON.stringify(settings));
      configShowSuccess('Settings saved!');
    }

    function configResetSettings() {
      if (!confirm('Reset all settings to defaults?')) {
        return;
      }
      
      document.getElementById('config-confirm-selections').checked = true;
      document.getElementById('config-show-descriptions').checked = true;
      document.getElementById('config-remember-last-sheet').checked = true;
      
      configSaveSettings();
    }

    // Utility Functions
    function configShowSuccess(message) {
      const element = document.getElementById('config-success-message');
      element.textContent = message;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    function configShowError(message) {
      const element = document.getElementById('config-error-message');
      element.textContent = message;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('config-modal');
      if (event.target === modal) {
        closeConfiguration();
      }
    }

    loadData();
    loadCPData();
  </script>
</body>
</html>

