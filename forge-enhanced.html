<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celestial Forge Character Sheet - Enhanced</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f1419, #1a1a2e); 
      color: #e0e0e0; 
      padding: 1rem; 
      margin: 0;
      min-height: 100vh;
    }
    
    h2 { 
      margin-top: 0; 
      color: #4fc3f7;
      text-align: center;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
      font-size: 1.8em;
    }
    
    button { 
      margin: 0.25rem; 
      padding: 0.75rem 1.25rem; 
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      background: linear-gradient(135deg, #1976d2, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }
    
    .panel { 
      border: 2px solid #0f3460; 
      padding: 1.5rem; 
      margin-bottom: 1.5rem; 
      border-radius: 12px; 
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .panel h3 {
      color: #81c784;
      margin-top: 0;
      font-size: 1.3em;
      border-bottom: 2px solid #388e3c;
      padding-bottom: 8px;
    }
    
    .choices { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 1rem; 
      margin: 1rem 0;
    }
    
    .choice { 
      cursor: pointer; 
      padding: 1rem; 
      border: 2px solid #424242; 
      border-radius: 10px; 
      background: linear-gradient(135deg, #303030, #424242);
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .choice:hover { 
      background: linear-gradient(135deg, #424242, #616161);
      border-color: #4fc3f7;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
    }
    
    .choice-title {
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    
    .choice-origin {
      color: #81c784;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    
    .choice-cost {
      color: #ffb74d;
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 8px;
    }
    
    .choice-description {
      color: #bdbdbd;
      font-size: 0.85em;
      line-height: 1.4;
      flex-grow: 1;
    }
    
    .choice-sub-perks {
      color: #81c784;
      font-size: 0.8em;
      margin-top: 8px;
      padding: 6px;
      background: rgba(129, 199, 132, 0.1);
      border-radius: 4px;
      border-left: 3px solid #81c784;
    }
    
    .choice-primary-note {
      color: #ffb74d;
      font-size: 0.85em;
      font-style: italic;
      margin-top: 5px;
      padding: 4px 8px;
      background: rgba(255, 183, 77, 0.1);
      border-radius: 4px;
      border-left: 3px solid #ffb74d;
    }
    
    .choice-sub-perks-list {
      margin-top: 8px;
      max-height: 120px;
      overflow-y: auto;
      background: rgba(79, 195, 247, 0.05);
      border-radius: 4px;
      padding: 6px;
    }
    
    .choice-sub-perk-item {
      color: #4fc3f7;
      font-size: 0.75em;
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      background: rgba(79, 195, 247, 0.1);
    }
    
    .sheet-entry { 
      margin-bottom: 1rem; 
      border-bottom: 2px dashed #424242; 
      padding-bottom: 1rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sheet-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .sheet-entry-title {
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.1em;
    }
    
    .sheet-entry-info {
      color: #81c784;
      font-size: 0.9em;
    }
    
    .sheet-entry-cost {
      color: #ffb74d;
      font-weight: bold;
    }
    
    .sheet-entry-description {
      color: #e0e0e0;
      line-height: 1.5;
      margin-top: 8px;
    }
    
    details { 
      margin-left: 1rem; 
      margin-top: 0.5rem;
    }
    
    details summary {
      color: #81c784;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    textarea { 
      width: 100%; 
      height: 220px; 
      background: #1e1e1e;
      color: #e0e0e0;
      border: 2px solid #424242;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      resize: vertical;
    }
    
    textarea:focus {
      border-color: #4fc3f7;
      outline: none;
      box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
    }
    
    .error { 
      color: #f44336; 
      font-weight: bold; 
      background: rgba(244, 67, 54, 0.1);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #f44336;
      margin-bottom: 1rem;
    }
    
    .row { 
      display: flex; 
      gap: 0.75rem; 
      flex-wrap: wrap; 
      align-items: center;
      margin: 0.5rem 0;
    }
    
    .cp-display { 
      font-weight: bold; 
      color: #4fc3f7; 
      font-size: 1.1em;
    }
    
    .insufficient-cp { 
      color: #f44336 !important; 
      text-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
    }
    
    .available-cp { 
      color: #4caf50 !important; 
      text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
    }
    
    .cp-panel-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .cp-stat {
      text-align: center;
      padding: 0.5rem;
    }
    
    .cp-stat-label {
      font-size: 0.9em;
      color: #bdbdbd;
      margin-bottom: 5px;
    }
    
    .cp-stat-value {
      font-size: 1.3em;
      font-weight: bold;
    }
    
    /* Enhanced AI Response Integration */
    .ai-response-panel {
      background: linear-gradient(135deg, #1a2332, #2d3748);
      border: 2px solid #4299e1;
    }
    
    .ai-response-panel h3 {
      color: #4299e1;
      border-bottom-color: #2b6cb0;
    }
    
    .sillytavern-integration {
      background: rgba(66, 153, 225, 0.1);
      border: 1px solid #4299e1;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .sillytavern-integration h4 {
      color: #4299e1;
      margin: 0 0 0.5rem 0;
    }
    
    .perk-for-ai {
      background: linear-gradient(135deg, #2d3748, #4a5568);
      border: 2px solid #4299e1;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .perk-for-ai-header {
      text-align: center;
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.2em;
      margin-bottom: 1rem;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
    }
    
    .perk-for-ai-content {
      color: #e0e0e0;
      line-height: 1.6;
    }
    
    .perk-for-ai-divider {
      border: none;
      border-top: 2px solid #4299e1;
      margin: 1rem 0;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .choices {
        grid-template-columns: 1fr;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .cp-panel-display {
        grid-template-columns: 1fr;
      }
    }
    
    /* Animation for sheet updates */
    .sheet-entry {
      animation: slideInFromBottom 0.3s ease-out;
    }
    
    @keyframes slideInFromBottom {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Special styling for iframe mode */
    .iframe-mode {
      padding: 0.5rem;
    }
    
    .iframe-mode h2 {
      font-size: 1.3em;
      margin-bottom: 1rem;
    }
    
    .iframe-mode .panel {
      margin-bottom: 1rem;
      padding: 1rem;
    }
    
    /* Configuration Modal Styles */
    .config-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    
    .config-modal-content {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      margin: 2% auto;
      padding: 0;
      border: 2px solid #64b5f6;
      border-radius: 12px;
      width: 95%;
      max-width: 1200px;
      height: 90%;
      position: relative;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }
    
    .config-modal-header {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: #1a1a2e;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #42a5f5;
    }
    
    .config-modal-header h2 {
      margin: 0;
      font-size: 1.5em;
      text-shadow: none;
      color: #1a1a2e;
    }
    
    .config-close {
      background: transparent;
      border: none;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #1a1a2e;
      padding: 0;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .config-close:hover {
      background: rgba(26, 26, 46, 0.2);
      transform: none;
      box-shadow: none;
    }
    
    .config-modal-body {
      padding: 20px;
      height: calc(100% - 80px);
      overflow-y: auto;
      color: #e0e0e0;
    }
    
    .config-nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .config-nav-buttons button {
      background: #424242;
      color: #e0e0e0;
      border: 1px solid #64b5f6;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .config-nav-buttons button:hover,
    .config-nav-buttons button.active {
      background: #64b5f6;
      color: #1a1a2e;
    }
    
    .config-tab-content {
      display: none;
    }
    
    .config-tab-content.active {
      display: block;
    }
    
    .config-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .config-panel h3 {
      color: #64b5f6;
      margin-top: 0;
      border-bottom: 2px solid #64b5f6;
      padding-bottom: 8px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(100, 181, 246, 0.3);
    }
    
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #64b5f6;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #c0c0c0;
      margin-top: 5px;
    }
    
    .search-box, .config-select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #64b5f6;
      border-radius: 5px;
      color: #e0e0e0;
      font-size: 1em;
    }
    
    .search-box::placeholder {
      color: #888;
    }
    
    .config-perk-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #424242;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.3);
    }
    
    .config-perk-item {
      padding: 10px;
      border-bottom: 1px solid #424242;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .config-perk-item:hover {
      background: rgba(100, 181, 246, 0.1);
    }
    
    .config-perk-item:last-child {
      border-bottom: none;
    }
    
    .config-perk-name {
      font-weight: bold;
      color: #64b5f6;
      margin-bottom: 5px;
    }
    
    .config-perk-origin {
      color: #81c784;
      font-size: 0.9em;
      margin-bottom: 3px;
    }
    
    .config-perk-cost {
      color: #ffb74d;
      font-weight: bold;
    }
    
    .sheet-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #424242;
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.3);
    }
    
    .sheet-item {
      padding: 10px;
      border-bottom: 1px solid #424242;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sheet-item:last-child {
      border-bottom: none;
    }
    
    .sheet-info {
      flex-grow: 1;
    }
    
    .sheet-actions {
      display: flex;
      gap: 5px;
    }
    
    .sheet-actions button {
      padding: 5px 10px;
      font-size: 0.8em;
    }
    
    .config-file-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #64b5f6;
      border-radius: 5px;
      color: #e0e0e0;
    }
    
    .config-checkbox-group {
      margin: 15px 0;
    }
    
    .config-checkbox-group label {
      display: flex;
      align-items: center;
      margin: 10px 0;
      cursor: pointer;
    }
    
    .config-checkbox-group input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }
    
    .danger {
      background: linear-gradient(135deg, #f44336, #d32f2f) !important;
    }
    
    .danger:hover {
      background: linear-gradient(135deg, #d32f2f, #c62828) !important;
    }
    
    .config-success {
      background: #4caf50;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    
    .config-error {
      background: #f44336;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body>
  <h2>🌌 Celestial Forge Character Sheet</h2>

  <div id="error-box" class="error" style="display: none;"></div>
  
  <div id="data-loading-panel" class="panel" style="display: none;">
    <h3>⚠️ Perks Data Loading</h3>
    <p>Having trouble loading perks.json? Try these options:</p>
    <div class="row">
      <button onclick="loadData()">🔄 Retry Auto-Load</button>
      <button onclick="showFileSelector()">📁 Select File Manually</button>
      <button onclick="showJsonPaster()">📋 Paste JSON Data</button>
    </div>
    <div id="file-selector" style="display: none; margin-top: 1rem;">
      <input type="file" id="perks-file-input" accept=".json" onchange="loadFromFile(this)">
      <p style="font-size: 0.9em; color: #81c784;">Select your perks.json file from your computer</p>
    </div>
    <div id="json-paster" style="display: none; margin-top: 1rem;">
      <textarea id="json-paste-area" placeholder="Paste perks.json content here..." style="width: 100%; height: 150px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #424242; border-radius: 4px; padding: 0.5rem;"></textarea>
      <br>
      <button onclick="loadFromPaste()" style="margin-top: 0.5rem;">Load from Pasted Data</button>
    </div>
  </div>

  <div id="cp-panel" class="panel">
    <h3>Choice Points (CP) Management</h3>
    <div class="cp-panel-display">
      <div class="cp-stat">
        <div class="cp-stat-label">Current CP</div>
        <div class="cp-stat-value cp-display" id="current-cp">0</div>
      </div>
      <div class="cp-stat">
        <div class="cp-stat-label">Total Earned</div>
        <div class="cp-stat-value" id="total-cp">0</div>
      </div>
      <div class="cp-stat">
        <div class="cp-stat-label">CP Spent</div>
        <div class="cp-stat-value" id="spent-cp">0</div>
      </div>
    </div>
    <div class="row">
      <button onclick="addCP()">Add CP</button>
      <button onclick="subtractCP()">Subtract CP</button>
      <button onclick="parseAIResponse()">Parse AI Response for CP</button>
      <button onclick="resetCP()">Reset CP</button>
    </div>
    <div class="row">
      <textarea id="ai-response" placeholder="Paste SillyTavern AI response here to extract CP total..." style="height:100px;"></textarea>
    </div>
  </div>

  <div id="domain-panel" class="panel">
    <h3>Step 1: Choose a Domain</h3>
    <div id="domain-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollDomains()">Reroll Domains</button>
    </div>
  </div>

  <div id="perk-panel" class="panel" style="display:none;">
    <h3>Step 2: Choose a Perk from <span id="selected-domain"></span></h3>
    <div id="perk-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollPerks()">Reroll Perks</button>
      <button onclick="backToDomains()">Back to Domains</button>
    </div>
  </div>

  <div id="sheet-panel" class="panel">
    <h3>Celestial Forge Sheet</h3>
    <div id="sheet"></div>
    <div class="row">
      <button onclick="saveSheet()">Save</button>
      <button onclick="loadSheet()">Load</button>
      <button onclick="wipeSheet()">Wipe</button>
      <button onclick="downloadSheet()">Download Sheet as JSON</button>
      <button onclick="showImportSheet()">Import Sheet JSON</button>
      <button onclick="openConfiguration()" style="background: #64b5f6; color: #1a1a2e;">⚙️ Configuration</button>
    </div>
    <div id="import-sheet-input" style="display: none; margin-top: 1rem;">
      <input type="file" id="sheet-file-input" accept=".json" onchange="importSheetFromFile(this)">
      <p style="font-size: 0.9em; color: #81c784;">Select a sheet JSON file to import</p>
    </div>
    <h4>For SillyTavern Integration:</h4>
    <div class="sillytavern-integration">
      <h4>📋 Copy this to insert in AI responses:</h4>
      <textarea id="export" readonly placeholder="Your selected perks will appear here in the format ready for AI responses..."></textarea>
      <div class="row">
        <button onclick="copyToClipboard()">Copy to Clipboard</button>
        <button onclick="generatePerkForAI()">Generate Current Perk Display</button>
      </div>
    </div>
  </div>

  <!-- AI Response Preview Panel -->
  <div id="ai-preview-panel" class="panel ai-response-panel" style="display:none;">
    <h3>🤖 AI Response Preview</h3>
    <div id="ai-preview-content" class="perk-for-ai">
      <div class="perk-for-ai-header">THE CELESTIAL FORGE</div>
      <div class="perk-for-ai-content" id="ai-preview-text"></div>
    </div>
    <div class="row">
      <button onclick="hideAIPreview()">Close Preview</button>
      <button onclick="copyAIPreview()">Copy Preview</button>
    </div>
  </div>

  <!-- Configuration Modal -->
  <div id="config-modal" class="config-modal">
    <div class="config-modal-content">
      <div class="config-modal-header">
        <h2>⚙️ Celestial Forge Configuration</h2>
        <button class="config-close" onclick="closeConfiguration()">&times;</button>
      </div>
      <div class="config-modal-body">
        <div class="config-nav-buttons">
          <button onclick="showConfigTab('perk-browser')" class="active" id="tab-perk-browser">Perk Browser</button>
          <button onclick="showConfigTab('sheet-manager')" id="tab-sheet-manager">Sheet Manager</button>
          <button onclick="showConfigTab('import-export')" id="tab-import-export">Import/Export</button>
          <button onclick="showConfigTab('settings')" id="tab-settings">Settings</button>
        </div>

        <div class="config-success" id="config-success-message"></div>
        <div class="config-error" id="config-error-message"></div>

        <!-- Perk Browser Tab -->
        <div id="config-perk-browser" class="config-tab-content active">
          <div class="config-panel">
            <h3>🔍 Perk Database Browser</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="config-total-perks">-</div>
                <div class="stat-label">Total Perks</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="config-total-domains">-</div>
                <div class="stat-label">Domains</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="config-affordable-perks">-</div>
                <div class="stat-label">Affordable (Current CP)</div>
              </div>
            </div>
            
            <select id="config-domain-filter" class="config-select" onchange="configFilterPerks()">
              <option value="">All Domains</option>
            </select>
            
            <input type="text" class="search-box" id="config-perk-search" placeholder="Search perks by name or description..." oninput="configFilterPerks()">
            
            <div class="config-perk-list" id="config-perk-list"></div>
          </div>
        </div>

        <!-- Sheet Manager Tab -->
        <div id="config-sheet-manager" class="config-tab-content">
          <div class="config-panel">
            <h3>📋 Sheet Manager</h3>
            <div class="sheet-list" id="config-sheet-list"></div>
            <div style="margin-top: 15px;">
              <button onclick="configRefreshSheetList()">Refresh</button>
              <button onclick="configExportAllSheets()">Export All Sheets</button>
              <button class="danger" onclick="configClearAllSheets()">Clear All Sheets</button>
            </div>
          </div>
        </div>

        <!-- Import/Export Tab -->
        <div id="config-import-export" class="config-tab-content">
          <div class="config-panel">
            <h3>📤 Export Options</h3>
            <button onclick="configExportCurrentSheet()">Export Current Sheet (JSON)</button>
            <button onclick="configExportCurrentSheetFormatted()">Export Current Sheet (Formatted)</button>
            <button onclick="configExportPerksDatabase()">Export Perks Database</button>
            <button onclick="configExportSettings()">Export Settings</button>
          </div>
          
          <div class="config-panel">
            <h3>📥 Import Options</h3>
            <div>
              <label>Import Sheet:</label>
              <input type="file" class="config-file-input" id="config-import-sheet" accept=".json" onchange="configImportSheet(this)">
            </div>
            <div style="margin-top: 15px;">
              <label>Import Perks Database:</label>
              <input type="file" class="config-file-input" id="config-import-perks" accept=".json" onchange="configImportPerks(this)">
            </div>
            <div style="margin-top: 15px;">
              <label>Import Settings:</label>
              <input type="file" class="config-file-input" id="config-import-settings" accept=".json" onchange="configImportSettings(this)">
            </div>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="config-settings" class="config-tab-content">
          <div class="config-panel">
            <h3>⚙️ Application Settings</h3>
            <div class="config-checkbox-group">
              <label>
                <input type="checkbox" id="config-confirm-selections" checked>
                Confirm perk selections
              </label>
              <label>
                <input type="checkbox" id="config-show-descriptions" checked>
                Show full perk descriptions
              </label>
              <label>
                <input type="checkbox" id="config-remember-last-sheet" checked>
                Remember last saved sheet name
              </label>
            </div>
            <div style="margin-top: 20px;">
              <button onclick="configSaveSettings()">Save Settings</button>
              <button onclick="configResetSettings()">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let perksData = {};
    let currentDomain = null;
    let sheet = [];
    let currentCP = 0;
    let totalCP = 0;

    // Check if running in iframe (for SillyTavern integration)
    const isIframe = window !== window.parent;
    if (isIframe) {
      document.body.classList.add('iframe-mode');
    }

    // Enhanced error handling with better user feedback
    function showError(message) {
      const errorBox = document.getElementById("error-box");
      errorBox.textContent = message;
      errorBox.style.display = "block";
      setTimeout(() => {
        errorBox.style.display = "none";
      }, 5000);
    }

    // Enhanced success notifications
    function showSuccess(message) {
      // Create a temporary success notification
      const successBox = document.createElement('div');
      successBox.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
      `;
      successBox.textContent = message;
      document.body.appendChild(successBox);
      
      setTimeout(() => {
        successBox.remove();
      }, 3000);
    }

    async function loadData(){
      try {
        console.log("🔄 Loading perks data from perks.json...");
        const res = await fetch("perks.json");
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const rawData = await res.json();
        perksData = processPerksData(rawData);
        
        // Log successful load with data summary
        const domainCount = Object.keys(perksData).length;
        const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
        console.log(`✅ Successfully loaded and processed perks.json: ${domainCount} domains, ${totalPerks} total perks`);
        
        onDataLoadSuccess();
      } catch (err) {
        console.error("❌ Error loading perks.json:", err);
        handleLoadError(err);
      }
    }

    function processPerksData(rawData) {
      const processedData = {};
      
      for (const [domain, perks] of Object.entries(rawData)) {
        processedData[domain] = [];
        
        // Create maps for quick lookup
        const perksByName = new Map();
        const compoundPerks = [];
        
        // First pass: categorize perks
        perks.forEach(perk => {
          perksByName.set(perk.name, perk);
          if (perk.name.includes('|')) {
            compoundPerks.push(perk);
          }
        });
        
        // Second pass: process perks
        perks.forEach(perk => {
          // Skip compound perks with empty descriptions - we'll handle them specially
          if (perk.name.includes('|') && !perk.description.trim()) {
            return;
          }
          
          // For compound perks with descriptions, break them into sub-perks
          if (perk.name.includes('|') && perk.description.trim()) {
            const names = perk.name.split('|').map(n => n.trim());
            const mainName = names[0];
            
            // Create main perk
            const mainPerk = {
              ...perk,
              name: mainName,
              sub_perks: []
            };
            
            // Add other parts as sub-perks if they exist individually
            for (let i = 1; i < names.length; i++) {
              const subName = names[i];
              const individualPerk = perksByName.get(subName);
              if (individualPerk && individualPerk.description.trim()) {
                mainPerk.sub_perks.push({
                  name: subName,
                  origin: individualPerk.origin,
                  cost: individualPerk.cost,
                  description: individualPerk.description
                });
              }
            }
            
            processedData[domain].push(mainPerk);
          } else {
            // Regular perk - include if it's not part of a compound perk or if compound perk doesn't exist
            const isPartOfCompound = compoundPerks.some(cp => 
              cp.name.includes('|') && 
              cp.name.split('|').map(n => n.trim()).includes(perk.name) &&
              !cp.description.trim()
            );
            
            if (!isPartOfCompound) {
              processedData[domain].push(perk);
            }
          }
        });
      }
      
      return processedData;
    }

    function onDataLoadSuccess() {
      // Hide loading panel if it was shown
      document.getElementById("data-loading-panel").style.display = "none";
      
      // Show success message with data summary
      const domainCount = Object.keys(perksData).length;
      const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
      showSuccess(`✅ perks.json loaded successfully: ${domainCount} domains, ${totalPerks} perks`);
      
      rerollDomains();
      loadCPData();
      loadSheet();
    }

    function handleLoadError(err) {
      const errorMsg = `⚠️ Could not load perks.json from the main directory.\nError: ${err.message}\n\nThis means the application cannot access the official perks database. Try these solutions:`;
      showError(errorMsg);
      document.getElementById("data-loading-panel").style.display = "block";
    }

    function showFileSelector() {
      document.getElementById("file-selector").style.display = "block";
      document.getElementById("json-paster").style.display = "none";
    }

    function showJsonPaster() {
      document.getElementById("json-paster").style.display = "block";
      document.getElementById("file-selector").style.display = "none";
    }

    async function loadFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.json')) {
        showError("⚠️ Please select a JSON file");
        return;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        perksData = data;
        
        // Log and update success messaging for manual file load
        const domainCount = Object.keys(perksData).length;
        const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
        console.log(`✅ Perks data loaded manually from file: ${file.name} (${domainCount} domains, ${totalPerks} perks)`);
        
        // Hide loading panel and show success
        document.getElementById("data-loading-panel").style.display = "none";
        showSuccess(`✅ Perks loaded from file "${file.name}": ${domainCount} domains, ${totalPerks} perks`);
        
        rerollDomains();
        loadCPData();
        loadSheet();
      } catch (err) {
        showError(`⚠️ Error reading file: ${err.message}`);
        console.error("❌ Error loading from file:", err);
      }
    }

    function loadFromPaste() {
      const textarea = document.getElementById("json-paste-area");
      const jsonText = textarea.value.trim();
      
      if (!jsonText) {
        showError("⚠️ Please paste JSON data first");
        return;
      }

      try {
        const data = JSON.parse(jsonText);
        perksData = data;
        
        // Log and update success messaging for pasted data
        const domainCount = Object.keys(perksData).length;
        const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
        console.log(`✅ Perks data loaded from pasted JSON content (${domainCount} domains, ${totalPerks} perks)`);
        
        // Hide loading panel and show success
        document.getElementById("data-loading-panel").style.display = "none";
        showSuccess(`✅ Perks loaded from pasted JSON: ${domainCount} domains, ${totalPerks} perks`);
        
        rerollDomains();
        loadCPData();
        loadSheet();
      } catch (err) {
        showError(`⚠️ Invalid JSON data: ${err.message}`);
        console.error("❌ Error parsing pasted JSON:", err);
      }
    }

    function getRandomItems(arr, n){
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function rerollDomains(){
      if (!perksData || Object.keys(perksData).length === 0) {
        showError("Perks data not loaded yet. Please wait...");
        return;
      }
      
      const domains = Object.keys(perksData);
      const selectedDomains = getRandomItems(domains, 4);
      const container = document.getElementById("domain-choices");
      container.innerHTML = "";
      
      selectedDomains.forEach(domain => {
        const div = document.createElement("div");
        div.className = "choice";
        div.onclick = () => selectDomain(domain);
        
        // Count affordable perks in this domain
        const domainPerks = perksData[domain] || [];
        const affordableCount = domainPerks.filter(perk => (perk.cost || 0) <= currentCP).length;
        
        div.innerHTML = `
          <div class="choice-title">${domain}</div>
          <div class="choice-info">
            <div class="choice-origin">${domainPerks.length} total perks</div>
            <div class="choice-cost">${affordableCount} affordable</div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById("perk-panel").style.display = "none";
    }

    function selectDomain(domain){
      currentDomain = domain;
      document.getElementById("selected-domain").textContent = domain;
      rerollPerks();
      document.getElementById("perk-panel").style.display = "block";
    }

    function rerollPerks(){
      if (!currentDomain || !perksData[currentDomain]) return;
      
      const domainPerks = perksData[currentDomain];
      const affordablePerks = domainPerks.filter(perk => (perk.cost || 0) <= currentCP);
      const selectedPerks = getRandomItems(affordablePerks, 4);
      
      const container = document.getElementById("perk-choices");
      container.innerHTML = "";
      
      if (selectedPerks.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #f44336; padding: 2rem;">No affordable perks available in this domain!</div>';
        return;
      }
      
      selectedPerks.forEach(perk => {
        const div = document.createElement("div");
        div.className = "choice";
        div.onclick = () => pickPerk(perk);
        
        let contentDisplay = "";
        let subPerkInfo = "";
        
        // Handle Primary Perks differently
        if (perk.is_primary && perk.sub_perks && perk.sub_perks.length > 0) {
          // For Primary Perks, show sub-perks instead of description
          contentDisplay = `<div class="choice-primary-note"><em>Primary Perk - includes all sub-perks below:</em></div>`;
          const subPerksList = perk.sub_perks.map(sp => 
            `<div class="choice-sub-perk-item">• <strong>${sp.name}</strong> [${sp.cost || 0} CP] - ${sp.origin || 'Unknown'}</div>`
          ).join("");
          subPerkInfo = `<div class="choice-sub-perks-list">${subPerksList}</div>`;
        } else {
          // Regular perk display
          const description = (perk.description || "No description available").substring(0, 150);
          const truncated = perk.description && perk.description.length > 150 ? "..." : "";
          contentDisplay = `<div class="choice-description">${description}${truncated}</div>`;
          
          // Show sub-perks if they exist (for compound perks)
          if (perk.sub_perks && perk.sub_perks.length > 0) {
            subPerkInfo = `<div class="choice-sub-perks"><strong>Includes ${perk.sub_perks.length} sub-perk(s):</strong> ${perk.sub_perks.map(sp => sp.name).join(", ")}</div>`;
          }
        }
        
        div.innerHTML = `
          <div class="choice-title">${perk.name || "Unknown Perk"}</div>
          <div class="choice-origin">${perk.origin || "Unknown Origin"}</div>
          <div class="choice-cost">[${perk.cost || 0} CP]</div>
          ${contentDisplay}
          ${subPerkInfo}
        `;
        container.appendChild(div);
      });
    }

    function backToDomains(){
      document.getElementById("perk-panel").style.display = "none";
      currentDomain = null;
    }

    function pickPerk(perk){
      const cost = perk.cost || 0;
      if (cost > currentCP) {
        showError(`Insufficient CP! You need ${cost} CP but only have ${currentCP} CP.`);
        return;
      }
      
      // Check settings for confirmation
      const settings = JSON.parse(localStorage.getItem("forgeSettings") || "{}");
      const confirmSelections = settings.confirmSelections !== false; // default true
      
      if (confirmSelections) {
        showPerkPreview(perk);
      } else {
        addPerkToSheet(perk);
      }
    }

    function showPerkPreview(perk) {
      const cost = perk.cost || 0;
      let description = perk.description || "No description available";
      
      let subPerkInfo = "";
      if (perk.sub_perks && perk.sub_perks.length > 0) {
        if (perk.is_primary) {
          // For Primary Perks, show sub-perks as the main content
          description = "Primary Perk - This purchase includes all the following sub-perks:";
          subPerkInfo = `\n\nIncluded Sub-Perks:\n${perk.sub_perks.map(sp => `• ${sp.name} [${sp.cost || 0} CP] (${sp.origin || 'Unknown'})\n  ${sp.description || 'No description'}`).join('\n\n')}`;
        } else {
          // Regular compound perk display
          subPerkInfo = `\n\nSub-perks included:\n${perk.sub_perks.map(sp => `• ${sp.name} [${sp.cost || 0} CP] - ${sp.description || 'No description'}`).join('\n')}`;
        }
      }
      
      const fullInfo = `${perk.name}\nOrigin: ${perk.origin || 'Unknown'}\nCost: ${cost} CP\n\nDescription:\n${description}${subPerkInfo}\n\nAdd this perk to your sheet for ${cost} CP?`;
      
      if (confirm(fullInfo)) {
        addPerkToSheet(perk);
      }
    }

    function addPerkToSheet(perk) {
      const cost = perk.cost || 0;
      sheet.push(perk);
      currentCP -= cost;
      updateSheet();
      updateCPDisplay();
      rerollDomains();
      showSuccess(`Added "${perk.name}" to your sheet!`);
      
      // Auto-save functionality disabled
    }

    // Auto-save functionality removed

    function updateSheet(){
      const container = document.getElementById("sheet");
      container.innerHTML = "";
      
      if (sheet.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #757575; padding: 2rem; font-style: italic;">No perks selected yet</div>';
        updateExport();
        return;
      }
      
      sheet.forEach((p, idx) => {
        const div = document.createElement("div");
        div.className = "sheet-entry";
        
        const name = p.name || "Unknown Perk";
        const origin = p.origin || "Unknown";
        const cost = p.cost || 0;
        let description = p.description || "No description available";
        
        // Handle Primary Perks differently
        if (p.is_primary && p.sub_perks && p.sub_perks.length > 0) {
          description = `<em>Primary Perk - Includes ${p.sub_perks.length} sub-perk(s)</em>`;
        }
        
        div.innerHTML = `
          <div class="sheet-entry-header">
            <div>
              <div class="sheet-entry-title">${name}${p.is_primary ? ' <span style="color: #ffb74d; font-size: 0.8em;">(Primary)</span>' : ''}</div>
              <div class="sheet-entry-info">${origin} - <span class="sheet-entry-cost">[${cost} CP]</span></div>
            </div>
            <button onclick="removePerk(${idx})" style="background: #f44336; border-radius: 50%; width: 30px; height: 30px; border: none; color: white; cursor: pointer;">×</button>
          </div>
          <div class="sheet-entry-description">${description}</div>
        `;
        
        // Add sub-perks if they exist
        if(p.sub_perks && p.sub_perks.length){
          const detailsDiv = document.createElement("details");
          const summaryText = p.is_primary ? `Included Sub-Perks (${p.sub_perks.length})` : `Sub-Perks (${p.sub_perks.length})`;
          detailsDiv.innerHTML = `<summary>${summaryText}</summary>`;
          
          // For Primary Perks, show sub-perks opened by default and with more detail
          if (p.is_primary) {
            detailsDiv.setAttribute('open', '');
          }
          
          const ul = document.createElement("ul");
          p.sub_perks.forEach(sp => {
            const li = document.createElement("li");
            li.innerHTML = p.is_primary 
              ? `<strong>${sp.name}</strong> (${sp.origin||"Unknown"}) [${sp.cost || 0} CP]<br><small style="color: #aaa;">${sp.description || 'No description'}</small>`
              : `<b>${sp.name}</b> (${sp.origin||"Unknown"}) [${sp.cost || 0} CP]`;
            ul.appendChild(li);
          });
          detailsDiv.appendChild(ul);
          div.appendChild(detailsDiv);
        }
        
        container.appendChild(div);
      });
      
      updateExport();
      updateCPDisplay();
    }

    function removePerk(index) {
      if (index >= 0 && index < sheet.length) {
        const removedPerk = sheet[index];
        const cost = removedPerk.cost || 0;
        currentCP += cost;
        sheet.splice(index, 1);
        updateSheet();
        showSuccess(`Removed "${removedPerk.name}" and refunded ${cost} CP`);
      }
    }

    function updateExport(){
      let txt = '<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\n<hr>\n';
      
      sheet.forEach(p => {
        const name = p.name || "Unknown Perk";
        const origin = p.origin || "Unknown";
        const cost = p.cost || 0;
        const description = p.description || "No description available";
        
        txt += `[${name}] - ${origin} - ${cost} CP\n`;
        txt += `${description}\n`;
        
        if(p.sub_perks && p.sub_perks.length){
          p.sub_perks.forEach(sp => {
            const subName = sp.name || "Unknown Sub-Perk";
            const subOrigin = sp.origin || "Unknown";
            const subCost = sp.cost || 0;
            txt += `  └ ${subName} - ${subOrigin} - ${subCost} CP\n`;
          });
        }
        txt += '<hr>\n';
      });
      
      if (sheet.length > 0) {
        txt += `Current CP: ${currentCP}\n`;
        txt += `Perks Selected: ${sheet.length}\n`;
        txt += '<hr>\n';
      }
      
      document.getElementById("export").value = txt;
    }

    function generatePerkForAI() {
      if (sheet.length === 0) {
        showError("No perks selected to display!");
        return;
      }
      
      const lastPerk = sheet[sheet.length - 1];
      const name = lastPerk.name || "Unknown Perk";
      const origin = lastPerk.origin || "Unknown";
      const cost = lastPerk.cost || 0;
      const description = lastPerk.description || "No description available";
      
      let aiText = `<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\n<hr>\n`;
      aiText += `[${name}] - ${origin} - ${cost} CP\n`;
      aiText += `${description}\n`;
      aiText += '<hr>\n';
      aiText += `Current CP: ${currentCP}\n`;
      aiText += `Total Perks: ${sheet.length}\n`;
      aiText += '<hr>\n';
      
      // Update preview
      document.getElementById("ai-preview-text").innerHTML = aiText.replace(/\n/g, '<br>');
      document.getElementById("ai-preview-panel").style.display = "block";
      
      showSuccess("AI response preview generated!");
    }

    function hideAIPreview() {
      document.getElementById("ai-preview-panel").style.display = "none";
    }

    function copyAIPreview() {
      const text = document.getElementById("ai-preview-text").textContent;
      copyToClipboardHelper(text);
    }

    function copyToClipboard() {
      const exportArea = document.getElementById("export");
      if (!exportArea.value.trim()) {
        showError("Nothing to copy! Select some perks first.");
        return;
      }
      copyToClipboardHelper(exportArea.value);
    }

    function copyToClipboardHelper(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showSuccess("Copied to clipboard!");
        }).catch(err => {
          console.error('Failed to copy: ', err);
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showSuccess("Copied to clipboard!");
      } catch (err) {
        showError("Failed to copy. Please copy manually from the text area.");
      }
      document.body.removeChild(textArea);
    }

    function saveSheet(){ 
      // Get settings to check if we should remember last sheet name
      const settings = JSON.parse(localStorage.getItem("forgeSettings") || "{}");
      const rememberLastSheet = settings.rememberLastSheet !== false; // default true
      
      // Get last used sheet name
      const lastSheetName = localStorage.getItem("lastSheetName");
      const defaultName = lastSheetName || `Sheet_${new Date().toISOString().split('T')[0]}`;
      
      let sheetName;
      if (rememberLastSheet && lastSheetName) {
        // Auto-save to last used name, but allow user to change
        sheetName = prompt(`Save as "${lastSheetName}"? (or enter new name):`, lastSheetName);
      } else {
        sheetName = prompt("Enter a name for this sheet:", defaultName);
      }
      
      if (sheetName) {
        const savedSheets = JSON.parse(localStorage.getItem("forgeSheets") || "{}");
        savedSheets[sheetName] = {
          sheet: sheet,
          currentCP: currentCP,
          totalCP: totalCP,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem("forgeSheets", JSON.stringify(savedSheets));
        localStorage.setItem("lastSheetName", sheetName); // Remember this name
        showSuccess(`Sheet "${sheetName}" saved!`);
      }
    }
    
    function loadSheet(){ 
      const savedSheets = JSON.parse(localStorage.getItem("forgeSheets") || "{}");
      const sheetNames = Object.keys(savedSheets);
      
      if (sheetNames.length === 0) {
        showError("No saved sheets found!");
        return;
      }
      
      if (sheetNames.length === 1) {
        // Only one sheet, load it directly
        const sheetData = savedSheets[sheetNames[0]];
        sheet = sheetData.sheet || [];
        currentCP = sheetData.currentCP || 0;
        totalCP = sheetData.totalCP || 0;
        updateSheet();
        showSuccess(`Sheet "${sheetNames[0]}" loaded!`);
        return;
      }
      
      // Multiple sheets, show selection
      const sheetList = sheetNames.map((name, index) => {
        const data = savedSheets[name];
        const timestamp = new Date(data.timestamp).toLocaleString();
        return `${index + 1}. ${name} (${data.sheet.length} perks, ${timestamp})`;
      }).join('\n');
      
      const selection = prompt(`Select a sheet to load:\n\n${sheetList}\n\nEnter the number (1-${sheetNames.length}):`);
      const index = parseInt(selection) - 1;
      
      if (index >= 0 && index < sheetNames.length) {
        const selectedName = sheetNames[index];
        const sheetData = savedSheets[selectedName];
        sheet = sheetData.sheet || [];
        currentCP = sheetData.currentCP || 0;
        totalCP = sheetData.totalCP || 0;
        updateSheet();
        showSuccess(`Sheet "${selectedName}" loaded!`);
      } else {
        showError("Invalid selection!");
      }
    }
    
    function wipeSheet(){ 
      if (confirm("Are you sure you want to clear your entire sheet? This will refund all CP.")) {
        const refundCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
        currentCP += refundCP;
        sheet = []; 
        updateSheet();
        showSuccess(`Sheet cleared and ${refundCP} CP refunded!`);
      }
    }

    function downloadSheet(){
      const blob = new Blob([JSON.stringify(sheet, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'celestial_forge_sheet.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showSuccess("Sheet downloaded!");
    }

    function showImportSheet() {
      const importDiv = document.getElementById("import-sheet-input");
      importDiv.style.display = importDiv.style.display === "none" ? "block" : "none";
    }

    async function importSheetFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.json')) {
        showError("⚠️ Please select a JSON file");
        return;
      }

      try {
        const text = await file.text();
        const importedSheet = JSON.parse(text);
        
        if (!Array.isArray(importedSheet)) {
          showError("⚠️ Invalid sheet format. Expected an array of perks.");
          return;
        }

        // Validate that imported data has the expected structure
        const validPerk = importedSheet.every(perk => 
          perk && typeof perk === 'object' && 
          typeof perk.name === 'string'
        );
        
        if (!validPerk) {
          showError("⚠️ Invalid sheet format. Perks must have at least a name field.");
          return;
        }

        // Confirm before importing
        const confirmMsg = `Import ${importedSheet.length} perk(s) from "${file.name}"? This will replace your current sheet.`;
        if (confirm(confirmMsg)) {
          // Refund current CP
          const refundCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
          currentCP += refundCP;
          
          // Set new sheet
          sheet = importedSheet;
          
          // Deduct CP for imported perks
          const importCost = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
          currentCP -= importCost;
          
          updateSheet();
          showSuccess(`Sheet imported! ${importedSheet.length} perks loaded from "${file.name}"`);
          
          // Hide import input
          document.getElementById("import-sheet-input").style.display = "none";
          input.value = ""; // Clear file input
        }
      } catch (err) {
        showError(`⚠️ Error reading file: ${err.message}`);
        console.error("Error importing sheet:", err);
      }
    }

    function updateCPDisplay(){
      const spentCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
      document.getElementById("current-cp").textContent = currentCP;
      document.getElementById("total-cp").textContent = totalCP;
      document.getElementById("spent-cp").textContent = spentCP;
      
      const currentCPElement = document.getElementById("current-cp");
      currentCPElement.className = currentCP > 0 ? "cp-display available-cp" : "cp-display insufficient-cp";
    }

    function addCP(){
      const amount = parseInt(prompt("How much CP to add?", "100"));
      if (amount && amount > 0) {
        currentCP += amount;
        totalCP += amount;
        updateCPDisplay();
        saveCPData();
        showSuccess(`Added ${amount} CP!`);
      }
    }

    function subtractCP(){
      const amount = parseInt(prompt("How much CP to subtract?", "100"));
      if (amount && amount > 0) {
        currentCP = Math.max(0, currentCP - amount);
        updateCPDisplay();
        saveCPData();
        showSuccess(`Subtracted ${amount} CP!`);
      }
    }

    function resetCP(){
      if (confirm("Reset all CP data? This will set current and total CP to 0.")) {
        currentCP = 0;
        totalCP = 0;
        updateCPDisplay();
        saveCPData();
        showSuccess("CP data reset!");
      }
    }

    function parseAIResponse(){
      const aiText = document.getElementById("ai-response").value;
      if (!aiText.trim()) {
        showError("Please paste an AI response to parse for CP!");
        return;
      }

      // Enhanced CP patterns with more variations
      const cpPatterns = [
        /(?:current\s+)?(?:choice\s+)?(?:points?|cp)(?:\s*:?\s*)(\d+)/gi,
        /(\d+)\s*(?:choice\s+)?(?:points?|cp)/gi,
        /cp\s*(?:total|current|available)?\s*:?\s*(\d+)/gi,
        /total\s*cp\s*:?\s*(\d+)/gi,
        /remaining\s*(?:cp|choice\s*points?)\s*:?\s*(\d+)/gi,
        /you\s+(?:now\s+)?have\s+(\d+)\s*(?:cp|choice\s*points?)/gi,
        /(\d+)\s*(?:cp|choice\s*points?)\s+(?:remaining|left|available)/gi
      ];

      let foundCP = null;
      for (const pattern of cpPatterns) {
        const matches = [...aiText.matchAll(pattern)];
        if (matches.length > 0) {
          foundCP = parseInt(matches[matches.length - 1][1]);
          break;
        }
      }

      if (foundCP !== null && foundCP >= 0) {
        const difference = foundCP - currentCP;
        currentCP = foundCP;
        if (difference > 0) {
          totalCP += difference;
        }
        updateCPDisplay();
        saveCPData();
        showSuccess(`Found CP: ${foundCP}. Current CP updated!`);
        document.getElementById("ai-response").value = "";
      } else {
        showError("Could not find CP amount in the AI response. Try patterns like 'CP: 500' or '500 Choice Points'");
      }
    }

    function saveCPData(){
      const cpData = { currentCP, totalCP };
      localStorage.setItem("forgeCPData", JSON.stringify(cpData));
    }

    function loadCPData(){
      const data = localStorage.getItem("forgeCPData");
      if (data) {
        const cpData = JSON.parse(data);
        currentCP = cpData.currentCP || 0;
        totalCP = cpData.totalCP || 0;
        updateCPDisplay();
      }
    }

    // Initialize when page loads
    window.addEventListener('load', loadData);

    // Auto-save disabled - no periodic saving

    // Message API for iframe communication with SillyTavern
    if (isIframe) {
      window.addEventListener('message', (event) => {
        if (event.data.type === 'PARSE_CP') {
          const foundCP = parseCP(event.data.text);
          if (foundCP !== null) {
            updateCP(foundCP);
            event.source.postMessage({
              type: 'CP_UPDATED',
              currentCP: currentCP,
              totalCP: totalCP
            }, '*');
          }
        }
        
        if (event.data.type === 'GET_SHEET_EXPORT') {
          event.source.postMessage({
            type: 'SHEET_EXPORT',
            export: document.getElementById("export").value
          }, '*');
        }
      });
    }

    // Configuration Modal Functions
    function openConfiguration() {
      document.getElementById('config-modal').style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      initializeConfigurationData();
    }

    function closeConfiguration() {
      document.getElementById('config-modal').style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore scrolling
    }

    function showConfigTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.config-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all nav buttons
      document.querySelectorAll('.config-nav-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('config-' + tabName).classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function initializeConfigurationData() {
      configLoadCurrentSheetData();
      configPopulateDomainFilter();
      configUpdateStats();
      configRefreshSheetList();
      configLoadSettings();
    }

    function configLoadCurrentSheetData() {
      // This data is already loaded in the main application
      // Just update the display
      configUpdateStats();
    }

    function configPopulateDomainFilter() {
      const select = document.getElementById('config-domain-filter');
      select.innerHTML = '<option value="">All Domains</option>';
      
      if (perksData && typeof perksData === 'object') {
        Object.keys(perksData).sort().forEach(domain => {
          const option = document.createElement('option');
          option.value = domain;
          option.textContent = domain;
          select.appendChild(option);
        });
      }
    }

    function configUpdateStats() {
      if (!perksData || typeof perksData !== 'object') {
        document.getElementById('config-total-perks').textContent = '0';
        document.getElementById('config-total-domains').textContent = '0';
        document.getElementById('config-affordable-perks').textContent = '0';
        return;
      }

      const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
      const totalDomains = Object.keys(perksData).length;
      const affordablePerks = Object.values(perksData).reduce((sum, perks) => {
        return sum + perks.filter(perk => (perk.cost || 0) <= currentCP).length;
      }, 0);

      document.getElementById('config-total-perks').textContent = totalPerks.toLocaleString();
      document.getElementById('config-total-domains').textContent = totalDomains;
      document.getElementById('config-affordable-perks').textContent = affordablePerks.toLocaleString();
    }

    function configFilterPerks() {
      const searchTerm = document.getElementById('config-perk-search').value.toLowerCase();
      const domainFilter = document.getElementById('config-domain-filter').value;
      configDisplayPerks(searchTerm, domainFilter);
    }

    function configDisplayPerks(searchTerm = '', domainFilter = '') {
      const perkList = document.getElementById('config-perk-list');
      perkList.innerHTML = '';

      if (!perksData || typeof perksData !== 'object') {
        perkList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No perks data loaded</div>';
        return;
      }

      let foundPerks = [];
      const domains = domainFilter ? [domainFilter] : Object.keys(perksData);

      domains.forEach(domain => {
        if (perksData[domain]) {
          perksData[domain].forEach(perk => {
            const matchesSearch = !searchTerm || 
              perk.name.toLowerCase().includes(searchTerm) || 
              (perk.description && perk.description.toLowerCase().includes(searchTerm));
            
            if (matchesSearch) {
              foundPerks.push({ ...perk, domain });
            }
          });
        }
      });

      if (foundPerks.length === 0) {
        perkList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No perks found matching your criteria</div>';
        return;
      }

      // Sort by cost, then by name
      foundPerks.sort((a, b) => {
        const costDiff = (a.cost || 0) - (b.cost || 0);
        return costDiff !== 0 ? costDiff : a.name.localeCompare(b.name);
      });

      foundPerks.slice(0, 100).forEach(perk => { // Limit to 100 for performance
        const perkElement = configCreatePerkElement(perk, perk.domain);
        perkList.appendChild(perkElement);
      });

      if (foundPerks.length > 100) {
        const moreElement = document.createElement('div');
        moreElement.style.padding = '10px';
        moreElement.style.textAlign = 'center';
        moreElement.style.color = '#888';
        moreElement.textContent = `... and ${foundPerks.length - 100} more. Try refining your search.`;
        perkList.appendChild(moreElement);
      }
    }

    function configCreatePerkElement(perk, domain) {
      const perkElement = document.createElement('div');
      perkElement.className = 'config-perk-item';
      
      const affordable = (perk.cost || 0) <= currentCP;
      const costColor = affordable ? '#4caf50' : '#f44336';
      
      perkElement.innerHTML = `
        <div class="config-perk-name">${perk.name}</div>
        <div class="config-perk-origin">${domain}</div>
        <div class="config-perk-cost" style="color: ${costColor};">${perk.cost || 0} CP</div>
      `;
      
      perkElement.onclick = () => configShowPerkModal(perk, domain);
      
      return perkElement;
    }

    function configShowPerkModal(perk, domain) {
      const affordable = (perk.cost || 0) <= currentCP;
      const addButtonText = affordable ? 'Add to Sheet' : 'Cannot Afford';
      
      const modal = confirm(`${perk.name}\nDomain: ${domain}\nCost: ${perk.cost || 0} CP\n\n${perk.description || 'No description available'}\n\nAdd this perk to your sheet?`);
      
      if (modal && affordable) {
        addPerk(perk, domain);
        configShowSuccess(`Added "${perk.name}" to your sheet!`);
        configUpdateStats();
      } else if (modal && !affordable) {
        configShowError('Insufficient CP to add this perk!');
      }
    }

    // Sheet Manager Functions
    function configRefreshSheetList() {
      const sheetList = document.getElementById('config-sheet-list');
      sheetList.innerHTML = '';
      
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      
      if (Object.keys(savedSheets).length === 0) {
        sheetList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No saved sheets found</div>';
        return;
      }
      
      Object.entries(savedSheets).forEach(([name, data]) => {
        const sheetItem = document.createElement('div');
        sheetItem.className = 'sheet-item';
        
        const timestamp = new Date(data.timestamp).toLocaleString();
        const perkCount = data.sheet ? data.sheet.length : 0;
        const cpSpent = data.sheet ? data.sheet.reduce((sum, p) => sum + (p.cost || 0), 0) : 0;
        
        sheetItem.innerHTML = `
          <div class="sheet-info">
            <div style="font-weight: bold; color: #64b5f6;">${name}</div>
            <div style="font-size: 0.9em; color: #c0c0c0;">
              ${perkCount} perks, ${cpSpent} CP spent, saved ${timestamp}
            </div>
          </div>
          <div class="sheet-actions">
            <button onclick="configLoadSheet('${name}')">Load</button>
            <button onclick="configExportSheet('${name}')">Export</button>
            <button class="danger" onclick="configDeleteSheet('${name}')">Delete</button>
          </div>
        `;
        
        sheetList.appendChild(sheetItem);
      });
    }

    function configLoadSheet(name) {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      const sheetData = savedSheets[name];
      
      if (!sheetData) {
        configShowError('Sheet not found!');
        return;
      }
      
      // Load into current sheet
      sheet = sheetData.sheet || [];
      currentCP = sheetData.currentCP || 0;
      totalCP = sheetData.totalCP || 0;
      
      updateSheet();
      updateCPDisplay();
      saveSheet(); // Save to current storage
      saveCPData();
      
      configShowSuccess(`Sheet "${name}" loaded!`);
      configUpdateStats();
    }

    function configExportSheet(name) {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      const sheetData = savedSheets[name];
      
      if (!sheetData) {
        configShowError('Sheet not found!');
        return;
      }
      
      const dataStr = JSON.stringify(sheetData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${name}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess(`Sheet "${name}" exported!`);
    }

    function configDeleteSheet(name) {
      if (!confirm(`Are you sure you want to delete the sheet "${name}"? This cannot be undone.`)) {
        return;
      }
      
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      delete savedSheets[name];
      localStorage.setItem('forgeSheets', JSON.stringify(savedSheets));
      
      configShowSuccess(`Sheet "${name}" deleted!`);
      configRefreshSheetList();
    }

    // Import/Export Functions
    function configExportCurrentSheet() {
      const exportData = {
        sheet: sheet,
        currentCP: currentCP,
        totalCP: totalCP,
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'current-sheet.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Current sheet exported!');
    }

    function configExportCurrentSheetFormatted() {
      const exportText = document.getElementById('export').value;
      if (!exportText) {
        configShowError('No sheet data to export!');
        return;
      }
      
      const dataBlob = new Blob([exportText], {type: 'text/plain'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'formatted-sheet.txt';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Formatted sheet exported!');
    }

    function configExportPerksDatabase() {
      if (!perksData) {
        configShowError('No perks database to export!');
        return;
      }
      
      const dataStr = JSON.stringify(perksData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'perks-database.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Perks database exported!');
    }

    function configExportSettings() {
      const settings = {
        autoSave: document.getElementById('config-auto-save').checked,
        confirmSelections: document.getElementById('config-confirm-selections').checked,
        showDescriptions: document.getElementById('config-show-descriptions').checked,
        rememberLastSheet: document.getElementById('config-remember-last-sheet').checked
      };
      
      const dataStr = JSON.stringify(settings, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'forge-settings.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('Settings exported!');
    }

    function configExportAllSheets() {
      const savedSheets = JSON.parse(localStorage.getItem('forgeSheets') || '{}');
      
      if (Object.keys(savedSheets).length === 0) {
        configShowError('No saved sheets to export!');
        return;
      }
      
      const dataStr = JSON.stringify(savedSheets, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'all-sheets.json';
      link.click();
      URL.revokeObjectURL(url);
      
      configShowSuccess('All sheets exported!');
    }

    function configClearAllSheets() {
      if (!confirm('Are you sure you want to delete ALL saved sheets? This cannot be undone!')) {
        return;
      }
      
      localStorage.removeItem('forgeSheets');
      configShowSuccess('All sheets cleared!');
      configRefreshSheetList();
    }

    async function configImportSheet(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        // Validate the data structure
        if (!data.sheet || !Array.isArray(data.sheet)) {
          throw new Error('Invalid sheet format');
        }
        
        // Import the sheet
        sheet = data.sheet;
        currentCP = data.currentCP || 0;
        totalCP = data.totalCP || 0;
        
        updateSheet();
        updateCPDisplay();
        saveSheet();
        saveCPData();
        
        configShowSuccess('Sheet imported successfully!');
        configUpdateStats();
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = ''; // Clear the input
    }

    async function configImportPerks(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        // Validate that it's a perks database
        if (typeof data !== 'object' || !Object.keys(data).length) {
          throw new Error('Invalid perks database format');
        }
        
        // Import the perks
        perksData = data;
        
        // Log and show success message with data summary
        const domainCount = Object.keys(perksData).length;
        const totalPerks = Object.values(perksData).reduce((sum, perks) => sum + perks.length, 0);
        console.log(`✅ Successfully imported perks database manually: ${domainCount} domains, ${totalPerks} total perks`);
        
        configPopulateDomainFilter();
        configUpdateStats();
        configDisplayPerks();
        
        // Show success message indicating manual import
        configShowSuccess(`✅ Perks database imported manually: ${domainCount} domains, ${totalPerks} perks`);
        
        // Also update the main status area
        showSuccess(`✅ Perks database manually imported: ${domainCount} domains, ${totalPerks} perks`);
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = ''; // Clear the input
    }

    async function configImportSettings(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const settings = JSON.parse(text);
        
        // Apply the settings (autoSave setting ignored as it's disabled)
        if (settings.hasOwnProperty('confirmSelections')) {
          document.getElementById('config-confirm-selections').checked = settings.confirmSelections;
        }
        if (settings.hasOwnProperty('showDescriptions')) {
          document.getElementById('config-show-descriptions').checked = settings.showDescriptions;
        }
        if (settings.hasOwnProperty('rememberLastSheet')) {
          document.getElementById('config-remember-last-sheet').checked = settings.rememberLastSheet;
        }
        
        configSaveSettings();
        configShowSuccess('Settings imported successfully!');
      } catch (error) {
        configShowError(`Import failed: ${error.message}`);
      }
      
      input.value = ''; // Clear the input
    }

    // Settings Functions
    function configLoadSettings() {
      const settings = JSON.parse(localStorage.getItem('forgeSettings') || '{}');
      
      document.getElementById('config-confirm-selections').checked = settings.confirmSelections !== false;
      document.getElementById('config-show-descriptions').checked = settings.showDescriptions !== false;
      document.getElementById('config-remember-last-sheet').checked = settings.rememberLastSheet !== false;
    }

    function configSaveSettings() {
      const settings = {
        confirmSelections: document.getElementById('config-confirm-selections').checked,
        showDescriptions: document.getElementById('config-show-descriptions').checked,
        rememberLastSheet: document.getElementById('config-remember-last-sheet').checked
      };
      
      localStorage.setItem('forgeSettings', JSON.stringify(settings));
      configShowSuccess('Settings saved!');
    }

    function configResetSettings() {
      if (!confirm('Reset all settings to defaults?')) {
        return;
      }
      
      document.getElementById('config-confirm-selections').checked = true;
      document.getElementById('config-show-descriptions').checked = true;
      document.getElementById('config-remember-last-sheet').checked = true;
      
      configSaveSettings();
    }

    // Utility Functions
    function configShowSuccess(message) {
      const element = document.getElementById('config-success-message');
      element.textContent = message;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 3000);
    }

    function configShowError(message) {
      const element = document.getElementById('config-error-message');
      element.textContent = message;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('config-modal');
      if (event.target === modal) {
        closeConfiguration();
      }
    }

    // Add CSS animation for success notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>