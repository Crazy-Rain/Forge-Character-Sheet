<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celestial Forge Character Sheet - Enhanced</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #0f1419, #1a1a2e); 
      color: #e0e0e0; 
      padding: 1rem; 
      margin: 0;
      min-height: 100vh;
    }
    
    h2 { 
      margin-top: 0; 
      color: #4fc3f7;
      text-align: center;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
      font-size: 1.8em;
    }
    
    button { 
      margin: 0.25rem; 
      padding: 0.75rem 1.25rem; 
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      background: linear-gradient(135deg, #1976d2, #1565c0);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }
    
    .panel { 
      border: 2px solid #0f3460; 
      padding: 1.5rem; 
      margin-bottom: 1.5rem; 
      border-radius: 12px; 
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.9), rgba(22, 33, 62, 0.9));
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .panel h3 {
      color: #81c784;
      margin-top: 0;
      font-size: 1.3em;
      border-bottom: 2px solid #388e3c;
      padding-bottom: 8px;
    }
    
    .choices { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 1rem; 
      margin: 1rem 0;
    }
    
    .choice { 
      cursor: pointer; 
      padding: 1rem; 
      border: 2px solid #424242; 
      border-radius: 10px; 
      background: linear-gradient(135deg, #303030, #424242);
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .choice:hover { 
      background: linear-gradient(135deg, #424242, #616161);
      border-color: #4fc3f7;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(79, 195, 247, 0.3);
    }
    
    .choice-title {
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    
    .choice-origin {
      color: #81c784;
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    
    .choice-cost {
      color: #ffb74d;
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 8px;
    }
    
    .choice-description {
      color: #bdbdbd;
      font-size: 0.85em;
      line-height: 1.4;
      flex-grow: 1;
    }
    
    .choice-sub-perks {
      color: #81c784;
      font-size: 0.8em;
      margin-top: 8px;
      padding: 6px;
      background: rgba(129, 199, 132, 0.1);
      border-radius: 4px;
      border-left: 3px solid #81c784;
    }
    
    .sheet-entry { 
      margin-bottom: 1rem; 
      border-bottom: 2px dashed #424242; 
      padding-bottom: 1rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sheet-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .sheet-entry-title {
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.1em;
    }
    
    .sheet-entry-info {
      color: #81c784;
      font-size: 0.9em;
    }
    
    .sheet-entry-cost {
      color: #ffb74d;
      font-weight: bold;
    }
    
    .sheet-entry-description {
      color: #e0e0e0;
      line-height: 1.5;
      margin-top: 8px;
    }
    
    details { 
      margin-left: 1rem; 
      margin-top: 0.5rem;
    }
    
    details summary {
      color: #81c784;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    textarea { 
      width: 100%; 
      height: 220px; 
      background: #1e1e1e;
      color: #e0e0e0;
      border: 2px solid #424242;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      resize: vertical;
    }
    
    textarea:focus {
      border-color: #4fc3f7;
      outline: none;
      box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
    }
    
    .error { 
      color: #f44336; 
      font-weight: bold; 
      background: rgba(244, 67, 54, 0.1);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #f44336;
      margin-bottom: 1rem;
    }
    
    .row { 
      display: flex; 
      gap: 0.75rem; 
      flex-wrap: wrap; 
      align-items: center;
      margin: 0.5rem 0;
    }
    
    .cp-display { 
      font-weight: bold; 
      color: #4fc3f7; 
      font-size: 1.1em;
    }
    
    .insufficient-cp { 
      color: #f44336 !important; 
      text-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
    }
    
    .available-cp { 
      color: #4caf50 !important; 
      text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
    }
    
    .cp-panel-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .cp-stat {
      text-align: center;
      padding: 0.5rem;
    }
    
    .cp-stat-label {
      font-size: 0.9em;
      color: #bdbdbd;
      margin-bottom: 5px;
    }
    
    .cp-stat-value {
      font-size: 1.3em;
      font-weight: bold;
    }
    
    /* Enhanced AI Response Integration */
    .ai-response-panel {
      background: linear-gradient(135deg, #1a2332, #2d3748);
      border: 2px solid #4299e1;
    }
    
    .ai-response-panel h3 {
      color: #4299e1;
      border-bottom-color: #2b6cb0;
    }
    
    .sillytavern-integration {
      background: rgba(66, 153, 225, 0.1);
      border: 1px solid #4299e1;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .sillytavern-integration h4 {
      color: #4299e1;
      margin: 0 0 0.5rem 0;
    }
    
    .perk-for-ai {
      background: linear-gradient(135deg, #2d3748, #4a5568);
      border: 2px solid #4299e1;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .perk-for-ai-header {
      text-align: center;
      font-weight: bold;
      color: #4fc3f7;
      font-size: 1.2em;
      margin-bottom: 1rem;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
    }
    
    .perk-for-ai-content {
      color: #e0e0e0;
      line-height: 1.6;
    }
    
    .perk-for-ai-divider {
      border: none;
      border-top: 2px solid #4299e1;
      margin: 1rem 0;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .choices {
        grid-template-columns: 1fr;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .cp-panel-display {
        grid-template-columns: 1fr;
      }
    }
    
    /* Animation for sheet updates */
    .sheet-entry {
      animation: slideInFromBottom 0.3s ease-out;
    }
    
    @keyframes slideInFromBottom {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Special styling for iframe mode */
    .iframe-mode {
      padding: 0.5rem;
    }
    
    .iframe-mode h2 {
      font-size: 1.3em;
      margin-bottom: 1rem;
    }
    
    .iframe-mode .panel {
      margin-bottom: 1rem;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <h2>üåå Celestial Forge Character Sheet</h2>

  <div id="error-box" class="error" style="display: none;"></div>
  
  <div id="data-loading-panel" class="panel" style="display: none;">
    <h3>‚ö†Ô∏è Perks Data Loading</h3>
    <p>Having trouble loading perks.json? Try these options:</p>
    <div class="row">
      <button onclick="loadData()">üîÑ Retry Auto-Load</button>
      <button onclick="showFileSelector()">üìÅ Select File Manually</button>
      <button onclick="showJsonPaster()">üìã Paste JSON Data</button>
    </div>
    <div id="file-selector" style="display: none; margin-top: 1rem;">
      <input type="file" id="perks-file-input" accept=".json" onchange="loadFromFile(this)">
      <p style="font-size: 0.9em; color: #81c784;">Select your perks.json file from your computer</p>
    </div>
    <div id="json-paster" style="display: none; margin-top: 1rem;">
      <textarea id="json-paste-area" placeholder="Paste perks.json content here..." style="width: 100%; height: 150px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #424242; border-radius: 4px; padding: 0.5rem;"></textarea>
      <br>
      <button onclick="loadFromPaste()" style="margin-top: 0.5rem;">Load from Pasted Data</button>
    </div>
  </div>

  <div id="cp-panel" class="panel">
    <h3>Choice Points (CP) Management</h3>
    <div class="cp-panel-display">
      <div class="cp-stat">
        <div class="cp-stat-label">Current CP</div>
        <div class="cp-stat-value cp-display" id="current-cp">0</div>
      </div>
      <div class="cp-stat">
        <div class="cp-stat-label">Total Earned</div>
        <div class="cp-stat-value" id="total-cp">0</div>
      </div>
      <div class="cp-stat">
        <div class="cp-stat-label">CP Spent</div>
        <div class="cp-stat-value" id="spent-cp">0</div>
      </div>
    </div>
    <div class="row">
      <button onclick="addCP()">Add CP</button>
      <button onclick="subtractCP()">Subtract CP</button>
      <button onclick="parseAIResponse()">Parse AI Response for CP</button>
      <button onclick="resetCP()">Reset CP</button>
    </div>
    <div class="row">
      <textarea id="ai-response" placeholder="Paste SillyTavern AI response here to extract CP total..." style="height:100px;"></textarea>
    </div>
  </div>

  <div id="domain-panel" class="panel">
    <h3>Step 1: Choose a Domain</h3>
    <div id="domain-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollDomains()">Reroll Domains</button>
    </div>
  </div>

  <div id="perk-panel" class="panel" style="display:none;">
    <h3>Step 2: Choose a Perk from <span id="selected-domain"></span></h3>
    <div id="perk-choices" class="choices"></div>
    <div class="row">
      <button onclick="rerollPerks()">Reroll Perks</button>
      <button onclick="backToDomains()">Back to Domains</button>
    </div>
  </div>

  <div id="sheet-panel" class="panel">
    <h3>Celestial Forge Sheet</h3>
    <div id="sheet"></div>
    <div class="row">
      <button onclick="saveSheet()">Save</button>
      <button onclick="loadSheet()">Load</button>
      <button onclick="wipeSheet()">Wipe</button>
      <button onclick="downloadSheet()">Download Sheet as JSON</button>
      <button onclick="showImportSheet()">Import Sheet JSON</button>
    </div>
    <div id="import-sheet-input" style="display: none; margin-top: 1rem;">
      <input type="file" id="sheet-file-input" accept=".json" onchange="importSheetFromFile(this)">
      <p style="font-size: 0.9em; color: #81c784;">Select a sheet JSON file to import</p>
    </div>
    <h4>For SillyTavern Integration:</h4>
    <div class="sillytavern-integration">
      <h4>üìã Copy this to insert in AI responses:</h4>
      <textarea id="export" readonly placeholder="Your selected perks will appear here in the format ready for AI responses..."></textarea>
      <div class="row">
        <button onclick="copyToClipboard()">Copy to Clipboard</button>
        <button onclick="generatePerkForAI()">Generate Current Perk Display</button>
      </div>
    </div>
  </div>

  <!-- AI Response Preview Panel -->
  <div id="ai-preview-panel" class="panel ai-response-panel" style="display:none;">
    <h3>ü§ñ AI Response Preview</h3>
    <div id="ai-preview-content" class="perk-for-ai">
      <div class="perk-for-ai-header">THE CELESTIAL FORGE</div>
      <div class="perk-for-ai-content" id="ai-preview-text"></div>
    </div>
    <div class="row">
      <button onclick="hideAIPreview()">Close Preview</button>
      <button onclick="copyAIPreview()">Copy Preview</button>
    </div>
  </div>

  <script>
    let perksData = {};
    let currentDomain = null;
    let sheet = [];
    let currentCP = 0;
    let totalCP = 0;

    // Check if running in iframe (for SillyTavern integration)
    const isIframe = window !== window.parent;
    if (isIframe) {
      document.body.classList.add('iframe-mode');
    }

    // Enhanced error handling with better user feedback
    function showError(message) {
      const errorBox = document.getElementById("error-box");
      errorBox.textContent = message;
      errorBox.style.display = "block";
      setTimeout(() => {
        errorBox.style.display = "none";
      }, 5000);
    }

    // Enhanced success notifications
    function showSuccess(message) {
      // Create a temporary success notification
      const successBox = document.createElement('div');
      successBox.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
      `;
      successBox.textContent = message;
      document.body.appendChild(successBox);
      
      setTimeout(() => {
        successBox.remove();
      }, 3000);
    }

    async function loadData(){
      try {
        console.log("Attempting to load perks.json...");
        const res = await fetch("perks.json");
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const rawData = await res.json();
        perksData = processPerksData(rawData);
        console.log("Perks data loaded successfully");
        onDataLoadSuccess();
      } catch (err) {
        console.error("Error loading perks.json:", err);
        handleLoadError(err);
      }
    }

    function processPerksData(rawData) {
      const processedData = {};
      
      for (const [domain, perks] of Object.entries(rawData)) {
        processedData[domain] = [];
        
        // Create maps for quick lookup
        const perksByName = new Map();
        const compoundPerks = [];
        
        // First pass: categorize perks
        perks.forEach(perk => {
          perksByName.set(perk.name, perk);
          if (perk.name.includes('|')) {
            compoundPerks.push(perk);
          }
        });
        
        // Second pass: process perks
        perks.forEach(perk => {
          // Skip compound perks with empty descriptions - we'll handle them specially
          if (perk.name.includes('|') && !perk.description.trim()) {
            return;
          }
          
          // For compound perks with descriptions, break them into sub-perks
          if (perk.name.includes('|') && perk.description.trim()) {
            const names = perk.name.split('|').map(n => n.trim());
            const mainName = names[0];
            
            // Create main perk
            const mainPerk = {
              ...perk,
              name: mainName,
              sub_perks: []
            };
            
            // Add other parts as sub-perks if they exist individually
            for (let i = 1; i < names.length; i++) {
              const subName = names[i];
              const individualPerk = perksByName.get(subName);
              if (individualPerk && individualPerk.description.trim()) {
                mainPerk.sub_perks.push({
                  name: subName,
                  origin: individualPerk.origin,
                  cost: individualPerk.cost,
                  description: individualPerk.description
                });
              }
            }
            
            processedData[domain].push(mainPerk);
          } else {
            // Regular perk - include if it's not part of a compound perk or if compound perk doesn't exist
            const isPartOfCompound = compoundPerks.some(cp => 
              cp.name.includes('|') && 
              cp.name.split('|').map(n => n.trim()).includes(perk.name) &&
              !cp.description.trim()
            );
            
            if (!isPartOfCompound) {
              processedData[domain].push(perk);
            }
          }
        });
      }
      
      return processedData;
    }

    function onDataLoadSuccess() {
      // Hide loading panel if it was shown
      document.getElementById("data-loading-panel").style.display = "none";
      rerollDomains();
      loadCPData();
      loadSheet();
      showSuccess("‚úÖ Perks data loaded successfully!");
    }

    function handleLoadError(err) {
      const errorMsg = `‚ö†Ô∏è Could not load perks.json automatically.\nError: ${err.message}\n\nPossible solutions:`;
      showError(errorMsg);
      document.getElementById("data-loading-panel").style.display = "block";
    }

    function showFileSelector() {
      document.getElementById("file-selector").style.display = "block";
      document.getElementById("json-paster").style.display = "none";
    }

    function showJsonPaster() {
      document.getElementById("json-paster").style.display = "block";
      document.getElementById("file-selector").style.display = "none";
    }

    async function loadFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.json')) {
        showError("‚ö†Ô∏è Please select a JSON file");
        return;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        perksData = data;
        console.log("Perks data loaded from file:", file.name);
        onDataLoadSuccess();
      } catch (err) {
        showError(`‚ö†Ô∏è Error reading file: ${err.message}`);
        console.error("Error loading from file:", err);
      }
    }

    function loadFromPaste() {
      const textarea = document.getElementById("json-paste-area");
      const jsonText = textarea.value.trim();
      
      if (!jsonText) {
        showError("‚ö†Ô∏è Please paste JSON data first");
        return;
      }

      try {
        const data = JSON.parse(jsonText);
        perksData = data;
        console.log("Perks data loaded from pasted content");
        onDataLoadSuccess();
      } catch (err) {
        showError(`‚ö†Ô∏è Invalid JSON data: ${err.message}`);
        console.error("Error parsing pasted JSON:", err);
      }
    }

    function getRandomItems(arr, n){
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function rerollDomains(){
      if (!perksData || Object.keys(perksData).length === 0) {
        showError("Perks data not loaded yet. Please wait...");
        return;
      }
      
      const domains = Object.keys(perksData);
      const selectedDomains = getRandomItems(domains, 4);
      const container = document.getElementById("domain-choices");
      container.innerHTML = "";
      
      selectedDomains.forEach(domain => {
        const div = document.createElement("div");
        div.className = "choice";
        div.onclick = () => selectDomain(domain);
        
        // Count affordable perks in this domain
        const domainPerks = perksData[domain] || [];
        const affordableCount = domainPerks.filter(perk => (perk.cost || 0) <= currentCP).length;
        
        div.innerHTML = `
          <div class="choice-title">${domain}</div>
          <div class="choice-info">
            <div class="choice-origin">${domainPerks.length} total perks</div>
            <div class="choice-cost">${affordableCount} affordable</div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById("perk-panel").style.display = "none";
    }

    function selectDomain(domain){
      currentDomain = domain;
      document.getElementById("selected-domain").textContent = domain;
      rerollPerks();
      document.getElementById("perk-panel").style.display = "block";
    }

    function rerollPerks(){
      if (!currentDomain || !perksData[currentDomain]) return;
      
      const domainPerks = perksData[currentDomain];
      const affordablePerks = domainPerks.filter(perk => (perk.cost || 0) <= currentCP);
      const selectedPerks = getRandomItems(affordablePerks, 4);
      
      const container = document.getElementById("perk-choices");
      container.innerHTML = "";
      
      if (selectedPerks.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #f44336; padding: 2rem;">No affordable perks available in this domain!</div>';
        return;
      }
      
      selectedPerks.forEach(perk => {
        const div = document.createElement("div");
        div.className = "choice";
        div.onclick = () => pickPerk(perk);
        
        const description = (perk.description || "No description available").substring(0, 150);
        const truncated = perk.description && perk.description.length > 150 ? "..." : "";
        
        let subPerkInfo = "";
        if (perk.sub_perks && perk.sub_perks.length > 0) {
          subPerkInfo = `<div class="choice-sub-perks"><strong>Includes ${perk.sub_perks.length} sub-perk(s):</strong> ${perk.sub_perks.map(sp => sp.name).join(", ")}</div>`;
        }
        
        div.innerHTML = `
          <div class="choice-title">${perk.name || "Unknown Perk"}</div>
          <div class="choice-origin">${perk.origin || "Unknown Origin"}</div>
          <div class="choice-cost">[${perk.cost || 0} CP]</div>
          <div class="choice-description">${description}${truncated}</div>
          ${subPerkInfo}
        `;
        container.appendChild(div);
      });
    }

    function backToDomains(){
      document.getElementById("perk-panel").style.display = "none";
      currentDomain = null;
    }

    function pickPerk(perk){
      const cost = perk.cost || 0;
      if (cost > currentCP) {
        showError(`Insufficient CP! You need ${cost} CP but only have ${currentCP} CP.`);
        return;
      }
      
      sheet.push(perk);
      currentCP -= cost;
      updateSheet();
      updateCPDisplay();
      rerollDomains();
      showSuccess(`Added "${perk.name}" to your sheet!`);
    }

    function updateSheet(){
      const container = document.getElementById("sheet");
      container.innerHTML = "";
      
      if (sheet.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #757575; padding: 2rem; font-style: italic;">No perks selected yet</div>';
        updateExport();
        return;
      }
      
      sheet.forEach((p, idx) => {
        const div = document.createElement("div");
        div.className = "sheet-entry";
        
        const name = p.name || "Unknown Perk";
        const origin = p.origin || "Unknown";
        const cost = p.cost || 0;
        const description = p.description || "No description available";
        
        div.innerHTML = `
          <div class="sheet-entry-header">
            <div>
              <div class="sheet-entry-title">${name}</div>
              <div class="sheet-entry-info">${origin} - <span class="sheet-entry-cost">[${cost} CP]</span></div>
            </div>
            <button onclick="removePerk(${idx})" style="background: #f44336; border-radius: 50%; width: 30px; height: 30px; border: none; color: white; cursor: pointer;">√ó</button>
          </div>
          <div class="sheet-entry-description">${description}</div>
        `;
        
        // Add sub-perks if they exist
        if(p.sub_perks && p.sub_perks.length){
          const detailsDiv = document.createElement("details");
          detailsDiv.innerHTML = `<summary>Sub-Perks (${p.sub_perks.length})</summary>`;
          
          const ul = document.createElement("ul");
          p.sub_perks.forEach(sp => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${sp.name}</b> (${sp.origin||"Unknown"}) [${sp.cost} CP]`;
            ul.appendChild(li);
          });
          detailsDiv.appendChild(ul);
          div.appendChild(detailsDiv);
        }
        
        container.appendChild(div);
      });
      
      updateExport();
      updateCPDisplay();
    }

    function removePerk(index) {
      if (index >= 0 && index < sheet.length) {
        const removedPerk = sheet[index];
        const cost = removedPerk.cost || 0;
        currentCP += cost;
        sheet.splice(index, 1);
        updateSheet();
        showSuccess(`Removed "${removedPerk.name}" and refunded ${cost} CP`);
      }
    }

    function updateExport(){
      let txt = '<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\n<hr>\n';
      
      sheet.forEach(p => {
        const name = p.name || "Unknown Perk";
        const origin = p.origin || "Unknown";
        const cost = p.cost || 0;
        const description = p.description || "No description available";
        
        txt += `[${name}] - ${origin} - ${cost} CP\n`;
        txt += `${description}\n`;
        
        if(p.sub_perks && p.sub_perks.length){
          p.sub_perks.forEach(sp => {
            const subName = sp.name || "Unknown Sub-Perk";
            const subOrigin = sp.origin || "Unknown";
            const subCost = sp.cost || 0;
            txt += `  ‚îî ${subName} - ${subOrigin} - ${subCost} CP\n`;
          });
        }
        txt += '<hr>\n';
      });
      
      if (sheet.length > 0) {
        txt += `Current CP: ${currentCP}\n`;
        txt += `Perks Selected: ${sheet.length}\n`;
        txt += '<hr>\n';
      }
      
      document.getElementById("export").value = txt;
    }

    function generatePerkForAI() {
      if (sheet.length === 0) {
        showError("No perks selected to display!");
        return;
      }
      
      const lastPerk = sheet[sheet.length - 1];
      const name = lastPerk.name || "Unknown Perk";
      const origin = lastPerk.origin || "Unknown";
      const cost = lastPerk.cost || 0;
      const description = lastPerk.description || "No description available";
      
      let aiText = `<div align="center"> <b>THE CELESTIAL FORGE</b> </div>\n<hr>\n`;
      aiText += `[${name}] - ${origin} - ${cost} CP\n`;
      aiText += `${description}\n`;
      aiText += '<hr>\n';
      aiText += `Current CP: ${currentCP}\n`;
      aiText += `Total Perks: ${sheet.length}\n`;
      aiText += '<hr>\n';
      
      // Update preview
      document.getElementById("ai-preview-text").innerHTML = aiText.replace(/\n/g, '<br>');
      document.getElementById("ai-preview-panel").style.display = "block";
      
      showSuccess("AI response preview generated!");
    }

    function hideAIPreview() {
      document.getElementById("ai-preview-panel").style.display = "none";
    }

    function copyAIPreview() {
      const text = document.getElementById("ai-preview-text").textContent;
      copyToClipboardHelper(text);
    }

    function copyToClipboard() {
      const exportArea = document.getElementById("export");
      if (!exportArea.value.trim()) {
        showError("Nothing to copy! Select some perks first.");
        return;
      }
      copyToClipboardHelper(exportArea.value);
    }

    function copyToClipboardHelper(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showSuccess("Copied to clipboard!");
        }).catch(err => {
          console.error('Failed to copy: ', err);
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showSuccess("Copied to clipboard!");
      } catch (err) {
        showError("Failed to copy. Please copy manually from the text area.");
      }
      document.body.removeChild(textArea);
    }

    function saveSheet(){ 
      const sheetName = prompt("Enter a name for this sheet:", `Sheet_${new Date().toISOString().split('T')[0]}`);
      if (sheetName) {
        const savedSheets = JSON.parse(localStorage.getItem("forgeSheets") || "{}");
        savedSheets[sheetName] = {
          sheet: sheet,
          currentCP: currentCP,
          totalCP: totalCP,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem("forgeSheets", JSON.stringify(savedSheets));
        showSuccess(`Sheet "${sheetName}" saved!`);
      }
    }
    
    function loadSheet(){ 
      const savedSheets = JSON.parse(localStorage.getItem("forgeSheets") || "{}");
      const sheetNames = Object.keys(savedSheets);
      
      if (sheetNames.length === 0) {
        showError("No saved sheets found!");
        return;
      }
      
      if (sheetNames.length === 1) {
        // Only one sheet, load it directly
        const sheetData = savedSheets[sheetNames[0]];
        sheet = sheetData.sheet || [];
        currentCP = sheetData.currentCP || 0;
        totalCP = sheetData.totalCP || 0;
        updateSheet();
        showSuccess(`Sheet "${sheetNames[0]}" loaded!`);
        return;
      }
      
      // Multiple sheets, show selection
      const sheetList = sheetNames.map((name, index) => {
        const data = savedSheets[name];
        const timestamp = new Date(data.timestamp).toLocaleString();
        return `${index + 1}. ${name} (${data.sheet.length} perks, ${timestamp})`;
      }).join('\n');
      
      const selection = prompt(`Select a sheet to load:\n\n${sheetList}\n\nEnter the number (1-${sheetNames.length}):`);
      const index = parseInt(selection) - 1;
      
      if (index >= 0 && index < sheetNames.length) {
        const selectedName = sheetNames[index];
        const sheetData = savedSheets[selectedName];
        sheet = sheetData.sheet || [];
        currentCP = sheetData.currentCP || 0;
        totalCP = sheetData.totalCP || 0;
        updateSheet();
        showSuccess(`Sheet "${selectedName}" loaded!`);
      } else {
        showError("Invalid selection!");
      }
    }
    
    function wipeSheet(){ 
      if (confirm("Are you sure you want to clear your entire sheet? This will refund all CP.")) {
        const refundCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
        currentCP += refundCP;
        sheet = []; 
        updateSheet();
        showSuccess(`Sheet cleared and ${refundCP} CP refunded!`);
      }
    }

    function downloadSheet(){
      const blob = new Blob([JSON.stringify(sheet, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'celestial_forge_sheet.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showSuccess("Sheet downloaded!");
    }

    function showImportSheet() {
      const importDiv = document.getElementById("import-sheet-input");
      importDiv.style.display = importDiv.style.display === "none" ? "block" : "none";
    }

    async function importSheetFromFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.json')) {
        showError("‚ö†Ô∏è Please select a JSON file");
        return;
      }

      try {
        const text = await file.text();
        const importedSheet = JSON.parse(text);
        
        if (!Array.isArray(importedSheet)) {
          showError("‚ö†Ô∏è Invalid sheet format. Expected an array of perks.");
          return;
        }

        // Validate that imported data has the expected structure
        const validPerk = importedSheet.every(perk => 
          perk && typeof perk === 'object' && 
          typeof perk.name === 'string'
        );
        
        if (!validPerk) {
          showError("‚ö†Ô∏è Invalid sheet format. Perks must have at least a name field.");
          return;
        }

        // Confirm before importing
        const confirmMsg = `Import ${importedSheet.length} perk(s) from "${file.name}"? This will replace your current sheet.`;
        if (confirm(confirmMsg)) {
          // Refund current CP
          const refundCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
          currentCP += refundCP;
          
          // Set new sheet
          sheet = importedSheet;
          
          // Deduct CP for imported perks
          const importCost = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
          currentCP -= importCost;
          
          updateSheet();
          showSuccess(`Sheet imported! ${importedSheet.length} perks loaded from "${file.name}"`);
          
          // Hide import input
          document.getElementById("import-sheet-input").style.display = "none";
          input.value = ""; // Clear file input
        }
      } catch (err) {
        showError(`‚ö†Ô∏è Error reading file: ${err.message}`);
        console.error("Error importing sheet:", err);
      }
    }

    function updateCPDisplay(){
      const spentCP = sheet.reduce((sum, perk) => sum + (perk.cost || 0), 0);
      document.getElementById("current-cp").textContent = currentCP;
      document.getElementById("total-cp").textContent = totalCP;
      document.getElementById("spent-cp").textContent = spentCP;
      
      const currentCPElement = document.getElementById("current-cp");
      currentCPElement.className = currentCP > 0 ? "cp-display available-cp" : "cp-display insufficient-cp";
    }

    function addCP(){
      const amount = parseInt(prompt("How much CP to add?", "100"));
      if (amount && amount > 0) {
        currentCP += amount;
        totalCP += amount;
        updateCPDisplay();
        saveCPData();
        showSuccess(`Added ${amount} CP!`);
      }
    }

    function subtractCP(){
      const amount = parseInt(prompt("How much CP to subtract?", "100"));
      if (amount && amount > 0) {
        currentCP = Math.max(0, currentCP - amount);
        updateCPDisplay();
        saveCPData();
        showSuccess(`Subtracted ${amount} CP!`);
      }
    }

    function resetCP(){
      if (confirm("Reset all CP data? This will set current and total CP to 0.")) {
        currentCP = 0;
        totalCP = 0;
        updateCPDisplay();
        saveCPData();
        showSuccess("CP data reset!");
      }
    }

    function parseAIResponse(){
      const aiText = document.getElementById("ai-response").value;
      if (!aiText.trim()) {
        showError("Please paste an AI response to parse for CP!");
        return;
      }

      // Enhanced CP patterns with more variations
      const cpPatterns = [
        /(?:current\s+)?(?:choice\s+)?(?:points?|cp)(?:\s*:?\s*)(\d+)/gi,
        /(\d+)\s*(?:choice\s+)?(?:points?|cp)/gi,
        /cp\s*(?:total|current|available)?\s*:?\s*(\d+)/gi,
        /total\s*cp\s*:?\s*(\d+)/gi,
        /remaining\s*(?:cp|choice\s*points?)\s*:?\s*(\d+)/gi,
        /you\s+(?:now\s+)?have\s+(\d+)\s*(?:cp|choice\s*points?)/gi,
        /(\d+)\s*(?:cp|choice\s*points?)\s+(?:remaining|left|available)/gi
      ];

      let foundCP = null;
      for (const pattern of cpPatterns) {
        const matches = [...aiText.matchAll(pattern)];
        if (matches.length > 0) {
          foundCP = parseInt(matches[matches.length - 1][1]);
          break;
        }
      }

      if (foundCP !== null && foundCP >= 0) {
        const difference = foundCP - currentCP;
        currentCP = foundCP;
        if (difference > 0) {
          totalCP += difference;
        }
        updateCPDisplay();
        saveCPData();
        showSuccess(`Found CP: ${foundCP}. Current CP updated!`);
        document.getElementById("ai-response").value = "";
      } else {
        showError("Could not find CP amount in the AI response. Try patterns like 'CP: 500' or '500 Choice Points'");
      }
    }

    function saveCPData(){
      const cpData = { currentCP, totalCP };
      localStorage.setItem("forgeCPData", JSON.stringify(cpData));
    }

    function loadCPData(){
      const data = localStorage.getItem("forgeCPData");
      if (data) {
        const cpData = JSON.parse(data);
        currentCP = cpData.currentCP || 0;
        totalCP = cpData.totalCP || 0;
        updateCPDisplay();
      }
    }

    // Initialize when page loads
    window.addEventListener('load', loadData);

    // Auto-save data periodically
    setInterval(() => {
      saveSheet();
      saveCPData();
    }, 30000); // Save every 30 seconds

    // Message API for iframe communication with SillyTavern
    if (isIframe) {
      window.addEventListener('message', (event) => {
        if (event.data.type === 'PARSE_CP') {
          const foundCP = parseCP(event.data.text);
          if (foundCP !== null) {
            updateCP(foundCP);
            event.source.postMessage({
              type: 'CP_UPDATED',
              currentCP: currentCP,
              totalCP: totalCP
            }, '*');
          }
        }
        
        if (event.data.type === 'GET_SHEET_EXPORT') {
          event.source.postMessage({
            type: 'SHEET_EXPORT',
            export: document.getElementById("export").value
          }, '*');
        }
      });
    }

    // Add CSS animation for success notifications
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>